{"componentChunkName":"component---src-templates-post-tsx","path":"/hood-hook/","result":{"data":{"markdownRemark":{"html":"<p><a href=\"https://medium.com/the-guild/under-the-hood-of-reacts-hooks-system-eb59638c9dba\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">이글</a>을 번역 및 분석 한 글입니다. 잘못된 번역이 있을 수 있습니다. 또한 예전 코드들이 많으므로 참고만 해야 합니다. 현재 코드랑 다른점이 많이 있습니다.</p>\n<h1 id=\"under-the-hood-of-reacts-hooks-system\" style=\"position:relative;\"><a href=\"#under-the-hood-of-reacts-hooks-system\" aria-label=\"under the hood of reacts hooks system permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Under the hood of React’s hooks system</h1>\n<p>우리는 모두 그것에 대해 들었습니다. React 16.7 의 새로운 훅 시스템은 커뮤니티에서 많은 이야기가 나옵니다. 우리는 모두 그것을 시도하고 그것을 테스트하고, 그리고 그것의 잠재력에 대해 정말로 흥분했습니다. 후크에 대해 생각할 때 그것들은 다소 마술적입니다. 어떻게 든 React 는 인스턴스를 노출하지 않고도이 구성 요소를 관리합니다 (<code class=\"language-text\">this</code> 키워드를 사용하지 않아도 됨). 그래서 도대체 어떻게 React 가 그렇게합니까?</p>\n<p>오늘 나는 React 의 후크 구현에 대해 더 자세히 이해할 수 있기를 바랍니다. 마법 같은 기능의 문제점은 복잡한 스택 추적으로 뒷받침되기 때문에 문제가 발생하면 문제를 디버그하는 것이 더 어렵다는 것입니다. 따라서, React 의 새로운 후크 시스템에 대한 깊은 지식을 갖게되면 문제가 발생하면 이를 신속하게 해결할 수 있을 것입니다.</p>\n<blockquote>\n<p>시작하기 전에 저는 제가 React 의 개발자 / 유지자가 아니며 제 말을 아주 작은 알갱이로 가야한다고 말하고 싶습니다. 나는 React 's hooks 시스템의 구현에 깊이 깊이 잠긴했지만, 꼭 이것이 React 가 실제로 어떻게 작동 하는지를 보장 할 수는 없습니다. 필자는 필자의 말을 React 의 소스 코드에서 증명과 참조로 뒷받침했으며 가능한 한 견고하게 주장하려고 노력했습니다.</p>\n</blockquote>\n<p><img src=\"https://miro.medium.com/max/684/1*R-oovJm4IQBLDjZy6DvbBg.png\" alt=\"https://miro.medium.com/max/684/1*R-oovJm4IQBLDjZy6DvbBg.png\"></p>\n<p>우선, 올바른 컨텍스트에서 호출되지 않으면 후크가 의미가 없다는 것을 알았을 것이므로 React의 범위 내에서 후크가 호출되도록하는 메커니즘을 살펴 보겠습니다.</p>\n<h2 id=\"the-dispatcher\" style=\"position:relative;\"><a href=\"#the-dispatcher\" aria-label=\"the dispatcher permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The dispatcher</h2>\n<p>디스패처는 후크 기능을 포함하는 공유 객체입니다. ReactDOM 의 렌더링 단계를 기반으로 동적으로 할당되거나 정리되며 사용자가 React 구성 요소 외부의 후크에 접근하지 못하게 합니다. (see <a href=\"https://github.com/facebook/react/tree/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberDispatcher.js?source=post_page---------------------------#L24\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">implementation</a>).</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// ReactFiberDispatcher.js</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span>\n  useCallback<span class=\"token punctuation\">,</span>\n  useContext<span class=\"token punctuation\">,</span>\n  useEffect<span class=\"token punctuation\">,</span>\n  useImperativeMethods<span class=\"token punctuation\">,</span>\n  useLayoutEffect<span class=\"token punctuation\">,</span>\n  useMemo<span class=\"token punctuation\">,</span>\n  useMutationEffect<span class=\"token punctuation\">,</span>\n  useReducer<span class=\"token punctuation\">,</span>\n  useRef<span class=\"token punctuation\">,</span>\n  useState<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'./ReactFiberHooks'</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">const</span> Dispatcher <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  readContext<span class=\"token punctuation\">,</span>\n  useCallback<span class=\"token punctuation\">,</span>\n  useContext<span class=\"token punctuation\">,</span>\n  useEffect<span class=\"token punctuation\">,</span>\n  useImperativeMethods<span class=\"token punctuation\">,</span>\n  useLayoutEffect<span class=\"token punctuation\">,</span>\n  useMemo<span class=\"token punctuation\">,</span>\n  useMutationEffect<span class=\"token punctuation\">,</span>\n  useReducer<span class=\"token punctuation\">,</span>\n  useRef<span class=\"token punctuation\">,</span>\n  useState<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>후크는 올바른 디스패처로 간단하게 전환하여 루트 구성 요소를 렌더링하기 전에 <code class=\"language-text\">enableHooks</code> 플래그에 의해 활성화 / 비활성화됩니다. 이는 기술적으로 런타임에 후크를 활성화 / 비활성화 할 수 있음을 의미합니다. React 16.6.X 에는 실험 기능이 구현되어 있지만 실제로는 사용할 수 없습니다. (see <a href=\"https://github.com/facebook/react/tree/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberScheduler.js?source=post_page---------------------------#L1211\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">implementation</a>).</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 1211줄 ReactFiberScheduler.js</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>enableHooks<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  ReactCurrentOwner<span class=\"token punctuation\">.</span>currentDispatcher <span class=\"token operator\">=</span> Dispatcher\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n  ReactCurrentOwner<span class=\"token punctuation\">.</span>currentDispatcher <span class=\"token operator\">=</span> DispatcherWithoutHooks\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>렌더링 작업(여기서 렌더링 작업이라 하면 fiber를 구성하고 아직 스크린에 반영하지 않은 작업상태를 뜻한다.)이 끝나면 디스패처를 무효화하여 ReactDOM 렌더링주기 밖에서 후크가 실수로 사용되는 것을 방지합니다. 이것은 사용자가 어리석은 일을 하지 않도록 보장하는 메커니즘입니다. (see <a href=\"https://github.com/facebook/react/tree/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberScheduler.js?source=post_page---------------------------#L1376\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">implementation</a>).</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 1376줄 ReactFiberScheduler.js</span>\n<span class=\"token comment\">// We're done performing work. Time to clean up.</span>\nReactCurrentOwner<span class=\"token punctuation\">.</span>currentDispatcher <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span></code></pre></div>\n<p>dispatcher는 <code class=\"language-text\">resolveDispatcher()</code> 함수를 사용하여 각각의 모든 후크 호출에서 resolve됩니다. 앞에서 말했듯이, React 의 렌더링주기 밖에서는 의미가 없어야하고, React 는 경고 메시지를 출력해야합니다 : <em>\"후크는 함수 구성 요소의 본체 내부에서만 호출 할 수 있습니다\"</em> (see <a href=\"https://github.com/facebook/react/tree/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react/src/ReactHooks.js?source=post_page---------------------------#L17\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">implementation</a>).</p>\n<p>Dispatcher 실행을 간단하게 표현하면 아래와 같습니다.</p>\n<p>매 <code class=\"language-text\">renderRoot</code> 에서만 <code class=\"language-text\">currentDispatcher</code> 가 할당되며 render가 모두 끝나면 <code class=\"language-text\">currentDispatcher</code> 을 null 처리 해서 외부 에서 <code class=\"language-text\">useXXX</code>를 호출 했을시 error 가 나게 했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> currentDispatcher\n<span class=\"token keyword\">const</span> dispatcherWithoutHooks <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/* ... */</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">const</span> dispatcherWithHooks <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">/* ... */</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">resolveDispatcher</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span> <span class=\"token comment\">// 적절한 dispatcher를 리턴해준다.</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentDispatcher<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> currentDispatcher\n  <span class=\"token keyword\">throw</span> <span class=\"token function\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hooks can't be called\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">useXXX</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> dispatcher <span class=\"token operator\">=</span> <span class=\"token function\">resolveDispatcher</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> dispatcher<span class=\"token punctuation\">.</span><span class=\"token function\">useXXX</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">renderRoot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  currentDispatcher <span class=\"token operator\">=</span> enableHooks <span class=\"token operator\">?</span> dispatcherWithHooks <span class=\"token operator\">:</span> dispatcherWithoutHooks <span class=\"token comment\">// root render하기 전에 알맞는 dispatcher 셋팅</span>\n  <span class=\"token function\">performWork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  currentDispatcher <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>실제 React github 코드 상에선 아래와 같이 표현하고 있다. (예전 코드)</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 16줄 ReactFiberScheduler.js</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">resolveDispatcher</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> dispatcher <span class=\"token operator\">=</span> ReactCurrentOwner<span class=\"token punctuation\">.</span>currentDispatcher\n  <span class=\"token function\">invariant</span><span class=\"token punctuation\">(</span>\n    dispatcher <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'Hooks can only be called inside the body of a function component.'</span>\n  <span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> dispatcher\n<span class=\"token punctuation\">}</span></code></pre></div>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// 54줄 ReactFiberScheduler.js</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> useState<span class=\"token operator\">&lt;</span><span class=\"token constant\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>initialState<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token constant\">S</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token constant\">S</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> dispatcher <span class=\"token operator\">=</span> <span class=\"token function\">resolveDispatcher</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> dispatcher<span class=\"token punctuation\">.</span><span class=\"token function\">useState</span><span class=\"token punctuation\">(</span>initialState<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이제는 간단한 <code class=\"language-text\">캡슐화 메커니즘</code>을 살펴 보았으므로 이 기사의 핵심 인 후크로 넘어 가고자 한다. 여기서 나는 새로운 개념을 소개하고자 합니다.</p>\n<h2 id=\"the-hooks-queue\" style=\"position:relative;\"><a href=\"#the-hooks-queue\" aria-label=\"the hooks queue permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The hooks queue</h2>\n<p>React 뒤에서, hooks는 호출 순서로 함께 연결된 노드로 표시됩니다. 후크는 단순히 생성된 다음 혼자 남겨지는 것이 아니기 때문에 그렇게 표현됩니다. 그들은 그들이 있는 그대로가 될 수 있도록 하는 메커니즘을 가지고 있다. 후크(hook)에는 구현에 뛰어 들기 전에 염두해야 할 필요한 몇 가지 프로퍼티들 있습니다.</p>\n<ul>\n<li>hook의 초기 상태값은 초기 렌더링시에 생성됩니다.</li>\n<li>hook의 상태는 즉시 업데이트 할 수 있습니다.</li>\n<li>React 는 다음번 렌더링에서 hook 의 상태를 기억할 것입니다.</li>\n<li>React 는 호출 순서에 따라 올바른 상태를 제공합니다.</li>\n<li>React 는 이 hook 이 어떤 fiber 에 속하는지 알 수 있습니다.</li>\n</ul>\n<p>따라서 component 의 상태를 보는 방식을 다시 생각 해야합니다. 지금까지 우리는 마치 평범한 object 인 것처럼 그것에 대해 생각해 왔습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// React state - the old way</span>\n<span class=\"token punctuation\">{</span>\n  foo<span class=\"token operator\">:</span> <span class=\"token string\">'foo'</span><span class=\"token punctuation\">,</span>\n  bar<span class=\"token operator\">:</span> <span class=\"token string\">'bar'</span><span class=\"token punctuation\">,</span>\n  baz<span class=\"token operator\">:</span> <span class=\"token string\">'baz'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>그러나 후크를 처리 할 때 각 노드가 하나의 상태 모델을 나타내는 큐로 간주 되어야합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// React state - the new way</span>\n<span class=\"token punctuation\">{</span>\n  memoizedState<span class=\"token operator\">:</span> <span class=\"token string\">'foo'</span><span class=\"token punctuation\">,</span>\n  baseUpdate<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    expirationTime<span class=\"token operator\">:</span> <span class=\"token string\">'만료시간'</span><span class=\"token punctuation\">,</span>\n    action<span class=\"token operator\">:</span> <span class=\"token string\">'업뎃에 필요한 액션'</span><span class=\"token punctuation\">,</span>\n    next<span class=\"token operator\">:</span> <span class=\"token string\">'다음 업뎃?'</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  queue<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    last<span class=\"token operator\">:</span> <span class=\"token string\">'마지막에 업데이트 했던 작업'</span><span class=\"token punctuation\">,</span>\n    dispatch<span class=\"token operator\">:</span> <span class=\"token string\">''</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  next<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    memoizedState<span class=\"token operator\">:</span> <span class=\"token string\">'bar'</span><span class=\"token punctuation\">,</span>\n    next<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n      memoizedState<span class=\"token operator\">:</span> <span class=\"token string\">'baz'</span><span class=\"token punctuation\">,</span>\n      next<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span>\n    <span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// 이것은 흡사 배열과 비슷할 수 있을거 같다.</span>\n<span class=\"token comment\">// ['foo', 'bar', 'baz'] iterator</span>\n<span class=\"token comment\">// ['foo', 'bar', 'baz'][Symbol.iterator]()</span></code></pre></div>\n<p>단일 훅 노드의 스키마는 <a href=\"https://github.com/facebook/react/tree/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberHooks.js?source=post_page---------------------------#L243\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">implementation</a>.에서 볼 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">type Update<span class=\"token operator\">&lt;</span><span class=\"token constant\">A</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  expirationTime<span class=\"token operator\">:</span> ExpirationTime<span class=\"token punctuation\">,</span>\n  action<span class=\"token operator\">:</span> <span class=\"token constant\">A</span><span class=\"token punctuation\">,</span>\n  next<span class=\"token operator\">:</span> Update<span class=\"token operator\">&lt;</span><span class=\"token constant\">A</span><span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\ntype UpdateQueue<span class=\"token operator\">&lt;</span><span class=\"token constant\">A</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  last<span class=\"token operator\">:</span> Update<span class=\"token operator\">&lt;</span><span class=\"token constant\">A</span><span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  dispatch<span class=\"token operator\">:</span> any<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">export</span> type Hook <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  memoizedState<span class=\"token operator\">:</span> any<span class=\"token punctuation\">,</span>\n\n  baseState<span class=\"token operator\">:</span> any<span class=\"token punctuation\">,</span>\n  baseUpdate<span class=\"token operator\">:</span> Update<span class=\"token operator\">&lt;</span>any<span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  queue<span class=\"token operator\">:</span> UpdateQueue<span class=\"token operator\">&lt;</span>any<span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n\n  next<span class=\"token operator\">:</span> Hook <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// ReactFiberHooks.js</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">createHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> Hook <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    memoizedState<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n\n    baseState<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    queue<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    baseUpdate<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n\n    next<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>훅에는 몇 가지 추가 속성이 있지만 훅의 작동 방식을 이해하는 열쇠는 <code class=\"language-text\">memoizedState</code> 와 <code class=\"language-text\">next</code> 내에 있습니다. 나머지 프로퍼티들은 <code class=\"language-text\">useReducer()</code> 훅에 의해 특별히 사용되어 <code class=\"language-text\">디스패치 된 액션(dispatched actions)</code>과 <code class=\"language-text\">기본 상태들(base states)</code>를 캐싱하므로 다양한 경우를 대비하여 reduction process가 반복 될 수 있습니다 :</p>\n<ul>\n<li><code class=\"language-text\">baseState</code> - reducer 에 주어진 상태 객체.</li>\n<li><code class=\"language-text\">baseUpdate</code> -<code class=\"language-text\">baseState</code>를 생성 한 가장 최근의 dispatch 된 액션입니다. (ex. [state, setState] = useState(0); setState(액션))</li>\n<li><code class=\"language-text\">queue</code> - dispatch 된 액션의 대기열(queue), reducer 를 통해 처리되길 기다리는 액션들이다.</li>\n</ul>\n<p>각 함수형 <code class=\"language-text\">fiber</code>마다 memoizedState field 에 <code class=\"language-text\">hook</code>을 지니고 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// Hooks are stored as a linked list on the fiber's memoizedState field. The</span>\n<span class=\"token comment\">// current hook list is the list that belongs to the current fiber. The</span>\n<span class=\"token comment\">// work-in-progress hook list is a new list that will be added to the</span>\n<span class=\"token comment\">// work-in-progress fiber.</span>\n<span class=\"token keyword\">let</span> firstCurrentHook<span class=\"token operator\">:</span> Hook <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> currentHook<span class=\"token operator\">:</span> Hook <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> firstWorkInProgressHook<span class=\"token operator\">:</span> Hook <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">let</span> workInProgressHook<span class=\"token operator\">:</span> Hook <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">// https://github.com/facebook/react/blob/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberHooks.js?source=post_page---------------------------#L367</span>\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> useReducer<span class=\"token operator\">&lt;</span><span class=\"token constant\">S</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">A</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>\n  <span class=\"token function-variable function\">reducer</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token constant\">S</span><span class=\"token punctuation\">,</span> <span class=\"token constant\">A</span></span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token constant\">S</span><span class=\"token punctuation\">,</span>\n  initialState<span class=\"token operator\">:</span> <span class=\"token constant\">S</span><span class=\"token punctuation\">,</span>\n  initialAction<span class=\"token operator\">:</span> <span class=\"token constant\">A</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">void</span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token constant\">S</span><span class=\"token punctuation\">,</span> Dispatch<span class=\"token operator\">&lt;</span><span class=\"token constant\">A</span><span class=\"token operator\">></span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span>\n  \n  currentlyRenderingFiber <span class=\"token operator\">=</span> <span class=\"token function\">resolveCurrentlyRenderingFiber</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  workInProgressHook <span class=\"token operator\">=</span> <span class=\"token function\">createWorkInProgressHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">let</span> queue<span class=\"token operator\">:</span> UpdateQueue<span class=\"token operator\">&lt;</span><span class=\"token constant\">A</span><span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>workInProgressHook<span class=\"token punctuation\">.</span>queue<span class=\"token operator\">:</span> any<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// .. 생략..</span>\n\n  <span class=\"token comment\">// 업데이트 시</span>\n  <span class=\"token comment\">// // 재 렌더시 (isReRender) - workInProgressHook에 next가 존재할 경우 </span>\n  <span class=\"token keyword\">const</span> dispatch<span class=\"token operator\">:</span> Dispatch<span class=\"token operator\">&lt;</span><span class=\"token constant\">A</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>queue<span class=\"token punctuation\">.</span>dispatch<span class=\"token operator\">:</span> any<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// 재 렌더가 아닐 경우</span>\n\n\n  <span class=\"token comment\">// 첫 렌더시 </span>\n  workInProgressHook<span class=\"token punctuation\">.</span>memoizedState <span class=\"token operator\">=</span> workInProgressHook<span class=\"token punctuation\">.</span>baseState <span class=\"token operator\">=</span> initialState<span class=\"token punctuation\">;</span>\n  queue <span class=\"token operator\">=</span> workInProgressHook<span class=\"token punctuation\">.</span>queue <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    last<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    dispatch<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> dispatch<span class=\"token operator\">:</span> Dispatch<span class=\"token operator\">&lt;</span><span class=\"token constant\">A</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>queue<span class=\"token punctuation\">.</span>dispatch <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token function\">dispatchAction</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    currentlyRenderingFiber<span class=\"token punctuation\">,</span>\n    queue<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> any<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// action 만 나중에 받게끔 dispatch를 bind 시킴.</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>workInProgressHook<span class=\"token punctuation\">.</span>memoizedState<span class=\"token punctuation\">,</span> dispatch<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span>\n\n\n\n<span class=\"token comment\">// useState에서 사용하는 reducer에는 basicStateReducer 사용</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">basicStateReducer</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">state<span class=\"token punctuation\">,</span> action</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">typeof</span> action <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span> <span class=\"token operator\">?</span> <span class=\"token function\">action</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> action\n<span class=\"token punctuation\">}</span></code></pre></div>\n<blockquote>\n<p>여기서 reducer 는 action 과 payload state 를 받아서 새로운 state 를 반환하는 순수함수라 할 수 있겠다. baseUpdate 는 액션이라고 보면 될것이다.</p>\n</blockquote>\n<p>불행하게도 거의 모든 경우를 재현 할 수 없었기 때문에 reducer hook 을 잘 이해할 수 없었습니다. 그래서 정교하게 느껴지지 않을 것입니다. 나는 단지 reducer 구현이 너무 일관성이 없기 때문에 <a href=\"https://github.com/facebook/react/blob/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberHooks.js?source=post_page---------------------------#L380\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">implementation</a> 에서 구현 자체의 주석 중 하나조차도 \"(이것이) 원하는 의미론이 맞는지 확실치 않다(TODO: Not sure if this is the desired semantics, but it's what we do for gDSFP. I can't remember why.)\" 라고 말합니다. 그래서 어떻게 확신해야합니까?!</p>\n<p>후크로 돌아가서, 각각의 모든 컴포넌트 호출 이전에,  <a href=\"https://github.com/facebook/react/blob/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberHooks.js#L123\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">prepareHooks()</code></a>라는 이름의 함수가 호출됩니다. <strong>이 함수안에서는 current fiber 와 hooks 큐(대기열) 안에 있는 그것의 첫 번째 hook 노드는 전역 변수에 저장됩니다. 이런 방식으로, 우리가 후크 함수 (<code class=\"language-text\">useXXX ()</code>)를 호출 할 때마다 어떤 컨텍스트에서 실행되는지를 알 수 있습니다.</strong></p>\n<blockquote>\n<p><code class=\"language-text\">prepareHooks()</code> 이 함수가 보이지 않는다. <code class=\"language-text\">prepareToUseHooks()</code> 이 함수인거 같다.</p>\n</blockquote>\n<p>다음은 Hooks 대기열이 실행되는 간단한 코드 형식이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">type</span> Update<span class=\"token operator\">&lt;</span><span class=\"token constant\">A</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  expirationTime<span class=\"token operator\">:</span> ExpirationTime\n  action<span class=\"token operator\">:</span> <span class=\"token constant\">A</span>\n  next<span class=\"token operator\">:</span> Update<span class=\"token operator\">&lt;</span><span class=\"token constant\">A</span><span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">type</span> UpdateQueue<span class=\"token operator\">&lt;</span><span class=\"token constant\">A</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  last<span class=\"token operator\">:</span> Update<span class=\"token operator\">&lt;</span><span class=\"token constant\">A</span><span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span>\n  dispatch<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">type</span> Hook <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  memoizedState<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span>\n\n  baseState<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span>\n  baseUpdate<span class=\"token operator\">:</span> Update<span class=\"token operator\">&lt;</span><span class=\"token builtin\">any</span><span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span>\n  queue<span class=\"token operator\">:</span> UpdateQueue<span class=\"token operator\">&lt;</span><span class=\"token builtin\">any</span><span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span>\n\n  next<span class=\"token operator\">:</span> Hook <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// The work-in-progress fiber. I've named it differently to distinguish it from</span>\n<span class=\"token comment\">// the work-in-progress hook.</span>\n<span class=\"token keyword\">let</span> currentlyRenderingFiber<span class=\"token operator\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token comment\">// Hooks are stored as a linked list on the fiber's memoizedState field. The</span>\n<span class=\"token comment\">// current hook list is the list that belongs to the current fiber. The</span>\n<span class=\"token comment\">// work-in-progress hook list is a new list that will be added to the</span>\n<span class=\"token comment\">// work-in-progress fiber.</span>\n<span class=\"token keyword\">let</span> workInProgressHook<span class=\"token operator\">:</span> Hook <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token keyword\">let</span> currentHook<span class=\"token operator\">:</span> Hook <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n<span class=\"token comment\">// Source: https://github.com/facebook/react/blob/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberHooks.js#L123</span>\n<span class=\"token comment\">// 2. 전역에 셋팅</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">prepareHooks</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">current<span class=\"token operator\">:</span> Fiber <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  workInProgress<span class=\"token operator\">:</span> Fiber<span class=\"token punctuation\">,</span>\n  nextRenderExpirationTime<span class=\"token operator\">:</span> ExpirationTime<span class=\"token punctuation\">,</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n     \n  renderExpirationTime <span class=\"token operator\">=</span> nextRenderExpirationTime<span class=\"token punctuation\">;</span>\n  currentlyRenderingFiber <span class=\"token operator\">=</span> workInProgress<span class=\"token punctuation\">;</span> <span class=\"token comment\">// 현재 작업중인 Fiber</span>\n  firstCurrentHook <span class=\"token operator\">=</span> current <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> current<span class=\"token punctuation\">.</span>memoizedState <span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// 이미 render된 Fiber(current)의 memoizedState를 firstCurrentHook 할당.</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Source: https://github.com/facebook/react/tree/5f06576f51ece88d846d01abd2ddd575827c6127/react-reconciler/src/ReactFiberHooks.js:148</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">finishHooks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  currentlyRenderingFiber<span class=\"token punctuation\">.</span>memoizedState <span class=\"token operator\">=</span> firstWorkInProgressHook\n  \n  currentlyRenderingFiber <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  firstCurrentHook <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  currentHook <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  firstWorkInProgressHook <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  workInProgressHook <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Source: https://github.com/facebook/react/blob/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberHooks.js#L332</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">resolveCurrentlyRenderingFiber</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>currentlyRenderingFiber<span class=\"token punctuation\">)</span> <span class=\"token keyword\">return</span> currentlyRenderingFiber\n  <span class=\"token keyword\">throw</span> <span class=\"token function\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Hooks can't be called\"</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// Source: https://github.com/facebook/react/blob/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberHooks.js#L267</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">createWorkInProgressHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// workInProgressHook 가 존재하고 next가 존재하지 않으면 hook을 새로 만들어서 workInProgressHook = workInProgressHook.next = hook;</span>\n  <span class=\"token comment\">// workInProgressHook 가 존재하고 next가 존재하면 workInProgressHook = workInProgressHook.next;</span>\n  <span class=\"token comment\">// workInProgressHook 가 존재하지 않고 firstWorkInProgressHook가 존재하지 않으면 firstWorkInProgressHook = workInProgressHook;</span>\n  <span class=\"token comment\">// 기존 fiber에 등록된 훅이 있으면 그 훅을 복사해서 사용하고 그게 아니라면 새로운 훅을 생성한다. </span>\n  workInProgressHook <span class=\"token operator\">=</span> currentHook <span class=\"token operator\">?</span> <span class=\"token function\">cloneHook</span><span class=\"token punctuation\">(</span>currentHook<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token function\">createNewHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  currentHook <span class=\"token operator\">=</span> currentHook <span class=\"token operator\">!==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> currentHook<span class=\"token punctuation\">.</span>next <span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> workInProgressHook\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 4. 컴포넌트 안에서 호출되는 useXXX 함수.</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">useXXX</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> fiber <span class=\"token operator\">=</span> <span class=\"token function\">resolveCurrentlyRenderingFiber</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// update 될 fiber 리턴.</span>\n  <span class=\"token keyword\">const</span> hook <span class=\"token operator\">=</span> <span class=\"token function\">createWorkInProgressHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">//현재 렌더링된 fiber의 memoizedState</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">updateFunctionComponent</span><span class=\"token punctuation\">(</span>\n  <span class=\"token parameter\">recentFiber<span class=\"token punctuation\">,</span>\n  workInProgressFiber<span class=\"token punctuation\">,</span>\n  Component<span class=\"token punctuation\">,</span>\n  props</span>\n<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">prepareHooks</span><span class=\"token punctuation\">(</span>recentFiber<span class=\"token punctuation\">,</span> workInProgressFiber<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 1. 훅 준비</span>\n  <span class=\"token function\">Component</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span> <span class=\"token comment\">// 3. 컴포넌트 호출 - 여기서 useXXX 호출할 것이다.</span>\n  <span class=\"token function\">finishHooks</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token comment\">// 5. Hooks 마무리</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>업데이트가 완료되면, <a href=\"https://github.com/facebook/react/tree/5f06576f51ece88d846d01abd2ddd575827c6127/react-reconciler/src/ReactFiberHooks.js:148?source=post_page---------------------------\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><code class=\"language-text\">finishHooks()</code></a> 이 호출 될 것입니다. 여기서 후크 대기열(hooks queue)의 첫 번째 노드에 대한 참조가 렌더링 된 fiber 의 <code class=\"language-text\">memoizedState</code> 속성에 저장됩니다. 즉, 후크 대기열과 그 상태를 외부 적으로 처리 할 수 ​​있습니다.</p>\n<p>컴퍼넌트의 메모 상태의 외부 읽기.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">ChildComponent</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">'foo'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">'bar'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">'baz'</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">ParentComponent</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> childFiberRef <span class=\"token operator\">=</span> <span class=\"token function\">useRef</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 자식이 mount 된 후에 실행된다.</span>\n    <span class=\"token keyword\">let</span> hookNode <span class=\"token operator\">=</span> childFiberRef<span class=\"token punctuation\">.</span>current<span class=\"token punctuation\">.</span>memoizedState\n\n    <span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>hookNode<span class=\"token punctuation\">.</span>memoizedState<span class=\"token punctuation\">,</span> <span class=\"token string\">'foo'</span><span class=\"token punctuation\">)</span>\n    hookNode <span class=\"token operator\">=</span> hooksNode<span class=\"token punctuation\">.</span>next\n    <span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>hookNode<span class=\"token punctuation\">.</span>memoizedState<span class=\"token punctuation\">,</span> <span class=\"token string\">'bar'</span><span class=\"token punctuation\">)</span>\n    hookNode <span class=\"token operator\">=</span> hooksNode<span class=\"token punctuation\">.</span>next\n    <span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>hookNode<span class=\"token punctuation\">.</span>memoizedState<span class=\"token punctuation\">,</span> <span class=\"token string\">'baz'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span>ChildComponent ref<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>childFiberRef<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>가장 일반적인 상태 후크부터 시작하여 개별 후크에 대해 더 구체적으로 설명하고 이야기하겠습니다.</p>\n<h2 id=\"state-hooks\" style=\"position:relative;\"><a href=\"#state-hooks\" aria-label=\"state hooks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>State hooks</h2>\n<p>놀랍지만 <code class=\"language-text\">useState</code> 훅 뒤에선 <code class=\"language-text\">useReducer</code> 를 사용하고 단순히 미리 정의 된 reducer 핸들러를 제공합니다 (see <a href=\"https://github.com/facebook/react/blob/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberHooks.js?source=post_page---------------------------#L339\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">implementation</a>). 즉, <code class=\"language-text\">useState</code> 에 의해 리턴 된 결과는 실제로 reducer 상태(state)와 action 디스패처(dispatcher)입니다. 상태 후크가 사용하는 reducer 핸들러를 살펴 보시기 바랍니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">basicStateReducer</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">state<span class=\"token punctuation\">,</span> action</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">typeof</span> action <span class=\"token operator\">===</span> <span class=\"token string\">'function'</span> <span class=\"token operator\">?</span> <span class=\"token function\">action</span><span class=\"token punctuation\">(</span>state<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> action\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> useState<span class=\"token operator\">&lt;</span><span class=\"token constant\">S</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>\n  initialState<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token constant\">S</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">|</span> <span class=\"token constant\">S</span>\n<span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token constant\">S</span><span class=\"token punctuation\">,</span> Dispatch<span class=\"token operator\">&lt;</span>BasicStateAction<span class=\"token operator\">&lt;</span><span class=\"token constant\">S</span><span class=\"token operator\">>></span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">useReducer</span><span class=\"token punctuation\">(</span>\n    basicStateReducer<span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// useReducer has a special case to support lazy useState initializers</span>\n    <span class=\"token punctuation\">(</span>initialState<span class=\"token operator\">:</span> any<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span> <span class=\"token comment\">// return [state, dispatchState]</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// dispatchState(value) => basicStateReducer 함수의 action에 value 값이 할당되고 action은 함수가 아니기에</span>\n<span class=\"token comment\">// 바로 action이 리턴되고 state에 할당된다.</span>\n\n<span class=\"token comment\">// 그럼 만약에 dispatchState((state) => state + 10) 이라고 하면 될까??? 된다.!!!</span>\n<span class=\"token comment\">// &lt;button onClick={() => setCount((count) => count+10)}>increse&lt;/button></span></code></pre></div>\n<p><code class=\"language-text\">useReducer()</code> 함수는 간단하게 이렇게 작성될 수 있다. <a href=\"https://github.com/facebook/react/blob/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberHooks.js?source=post_page---------------------------#L346\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">useReducer</a></p>\n<p>함수형 컴포넌트가 실행되고 나면 현재 fiber랑 해당 fiber에 hook을 전역으로 준비해둔다. 그리고 나서 <code class=\"language-text\">useState</code>를 호출이 되면 내부적으로 <code class=\"language-text\">useReduce</code> 함수가 실행이 되고 이 안에서 필요한 <code class=\"language-text\">hook</code> 을 만들어내거나 참조하게 된다. 그리고 나서 hook의 state와 dispatch를 리턴하고 나면 함수형 컴포넌트가 끝날쯤에 <code class=\"language-text\">finishHooks</code>을 호출 해당되는 hook의 첫번째 참조값을 해당 fiber의 memoizedState에 연결해두고 전역변수 들을 정리한다. </p>\n<p>아래 함수에서 <code class=\"language-text\">useState</code>호출시 <code class=\"language-text\">useReducer</code>를 호출 후 리턴 배열이 리턴이 되는데 이때 <code class=\"language-text\">dispatch</code>가 <code class=\"language-text\">dispatchAction</code> 함수의 binding 된 함수이다. 이때 바인딩 되는 인자들은 현재 렌더링 될 fiber 를 가지고 있게 되는데 그렇다면 우리가 <code class=\"language-text\">dispatch</code> 함수를 액션을 넣어서 호출 할 때마다 어떤 fiber 와 연관되어있는지 알게 되는 것이다. 그래서 해당 fiber 에서부터 reconcile 을 하는거 같다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">export</span> <span class=\"token keyword\">function</span> <span class=\"token function\">useReducer</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  currentlyRenderingFiber <span class=\"token operator\">=</span> <span class=\"token function\">resolveCurrentlyRenderingFiber</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  workInProgressHook <span class=\"token operator\">=</span> <span class=\"token function\">createWorkInProgressHook</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">let</span> queue<span class=\"token operator\">:</span> UpdateQueue<span class=\"token operator\">&lt;</span><span class=\"token constant\">A</span><span class=\"token operator\">></span> <span class=\"token operator\">|</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>workInProgressHook<span class=\"token punctuation\">.</span>queue<span class=\"token operator\">:</span> any<span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// ...</span>\n  <span class=\"token keyword\">const</span> dispatch<span class=\"token operator\">:</span> Dispatch<span class=\"token operator\">&lt;</span><span class=\"token constant\">A</span><span class=\"token operator\">></span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>queue<span class=\"token punctuation\">.</span>dispatch <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token function\">dispatchAction</span><span class=\"token punctuation\">.</span><span class=\"token function\">bind</span><span class=\"token punctuation\">(</span>\n    <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n    currentlyRenderingFiber<span class=\"token punctuation\">,</span> <span class=\"token comment\">// workInTree Fiber</span>\n    queue\n  <span class=\"token punctuation\">)</span><span class=\"token operator\">:</span> any<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">[</span>workInProgressHook<span class=\"token punctuation\">.</span>memoizedState<span class=\"token punctuation\">,</span> dispatch<span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> dispatchAction<span class=\"token operator\">&lt;</span><span class=\"token constant\">A</span><span class=\"token operator\">></span><span class=\"token punctuation\">(</span>fiber<span class=\"token operator\">:</span> Fiber<span class=\"token punctuation\">,</span> queue<span class=\"token operator\">:</span> UpdateQueue<span class=\"token operator\">&lt;</span><span class=\"token constant\">A</span><span class=\"token operator\">></span><span class=\"token punctuation\">,</span> action<span class=\"token operator\">:</span> <span class=\"token constant\">A</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">//...</span>\n  <span class=\"token function\">scheduleWork</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">,</span> expirationTime<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>예상대로 액션 디스패처에 새로운 상태를 직접 제공 할 수 있습니다. Dispatcher 에게 <em>액션 함수를 제공하여 이전 상태를 받고 새 상태를 반환 할 수도 있습니다 .</em></p>\n<p>즉, 구성 요소 트리 아래로 <code class=\"language-text\">state setter</code>(useState 에서 리턴된 배열의 두번째 함수)를 보내면 다른 props 없이 상위 구성 요소의 현재 상태(current state)에 대해 변형을 실행할 수 있습니다. 예 :</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token function-variable function\">ParentComponent</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">,</span> setName<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token operator\">&lt;</span>ChildComponent toUpperCase<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>setName<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">ChildComponent</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">props</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span>\n    <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      props<span class=\"token punctuation\">.</span><span class=\"token function\">toUpperCase</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">state</span> <span class=\"token operator\">=></span> state<span class=\"token punctuation\">.</span><span class=\"token function\">toUpperCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">[</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">]</span>\n  <span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>마지막으로, 구성 요소의 라이플 사이클에 중요한 영향을 미치는 effect hooks 작동 방식을 알아보자.</p>\n<h2 id=\"effect-hooks\" style=\"position:relative;\"><a href=\"#effect-hooks\" aria-label=\"effect hooks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Effect hooks</h2>\n<p>이펙트 후크는 약간 다르게 동작하고 내가 설명하고 싶은 추가 로직 레이어를 가지고 있습니다. 다시 한 번, 구현에 들어가기 전에 effect hook의 프로퍼티들에 대해 염두에 두어야 할 사항이 있습니다.</p>\n<ul>\n<li>effect hooks는 렌더링 시간 동안 생성되지만 페인팅 후에 실행됩니다.</li>\n<li>그렇게되면, 그들은 다음 페인팅 직전에 파괴 될 것입니다.</li>\n<li>그들은 정의된 순서대로 호출됩니다.</li>\n</ul>\n<p><em>\"페이팅\"이라는 용어를 사용하고 \"렌더링\" 단어는 사용하하지 않았습니다. 이 두 가지가 다른데, 나는 최근의 [</em>React Conf<em>](<a href=\"https://conf.reactjs.org/?source=post\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://conf.reactjs.org/?source=post</a></em>page---------------------------)에서 잘못된 용어를 사용하는 것을 많이 바왔다.! 공식 <a href=\"https://reactjs.org/docs/hooks-reference.html?source=post_page---------------------------#useeffect\" target=\"_blank\" rel=\"nofollow noopener noreferrer\"><em>React docs</em></a>에서 \"페인팅\"과 같은 말을 \"렌더링이 화면에 적용 된 후\"라고 말합니다. render 메서드는 파이버 노드를 생성하지만 아직 아무것도 그리지 않습니다 ._</p>\n<p>따라서 이러한 효과를 유지해야하는 추가 대기열이 있어야하며 페인팅 후에 처리해야합니다. 일반적으로 말하자면, fiber는 effect node들을 포함하는 대기열을 보유하고 있습니다. 각 effect는 다른 유형이므로 적절한 단계에서 해결해야합니다.</p>\n<ul>\n<li>mutation이 일어나기 전에 <code class=\"language-text\">getSnapshotBeforeUpdate()</code> 인스턴스를 호출한다.  (see  <a href=\"https://github.com/facebook/react/tree/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberScheduler.js?source=post_page---------------------------#L646\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">implementation</a>).</li>\n<li>all the host 삽입, 업데이트, 삭제 그리고 참조해제를 수행한다.  (see  <a href=\"https://github.com/facebook/react/tree/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberScheduler.js?source=post_page---------------------------#L687\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">implementation</a>).</li>\n<li>모든 라이프 사이클 및 참조 콜백을 수행하십시오. 라이프 사이클은 별도의 실행으로 발생하므로 전체 트리에서 모든 배치, 업데이트 및 삭제가 이미 호출되었습니다. 이 실행은 또한 렌더러 관련 초기 효과를 트리거합니다. (see  <a href=\"https://github.com/facebook/react/tree/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberScheduler.js?source=post_page---------------------------#L732\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">implementation</a>).</li>\n<li><code class=\"language-text\">useEffect()</code>  hook에 의해 스케쥴된 Effect - 구현에 기반한 \"passive effects\" 라고도 합니다. <a href=\"https://github.com/facebook/react/tree/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberScheduler.js?source=post_page---------------------------#L779\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">implementation</a>  (어쩌면 우리는 React 커뮤니티에서이 용어를 사용해야 할까?).</li>\n</ul>\n<p>hook effects에 관해서는 fiber의 <code class=\"language-text\">updateQueue</code> 라는 속성에 저장해야하며 각 효과 노드(effect node)는 다음 스키마를 가져야합니다 ((see  <a href=\"https://github.com/facebook/react/tree/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberHooks.js?source=post_page---------------------------#L477\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">implementation</a>):</p>\n<div class=\"gatsby-highlight\" data-language=\"typescript\"><pre class=\"language-typescript\"><code class=\"language-typescript\"><span class=\"token keyword\">function</span> <span class=\"token function\">pushEffect</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">tag<span class=\"token punctuation\">,</span> create<span class=\"token punctuation\">,</span> destroy<span class=\"token punctuation\">,</span> inputs</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> effect<span class=\"token operator\">:</span> Effect <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    tag<span class=\"token punctuation\">,</span>\n    create<span class=\"token punctuation\">,</span>\n    destroy<span class=\"token punctuation\">,</span>\n    inputs<span class=\"token punctuation\">,</span>\n    <span class=\"token comment\">// Circular</span>\n    next<span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span> \n\n  <span class=\"token keyword\">return</span> effect<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<ul>\n<li><code class=\"language-text\">tag</code>  - 효과의 동작을 지시하는 이진수입니다 (곧 자세히 설명 할 것입니다).</li>\n<li><code class=\"language-text\">create</code>  - painting 이후에 실행해야하는 콜백입니다.</li>\n<li><code class=\"language-text\">destroy</code>  - 초기 렌더링 전에 실행되어야하는<code class=\"language-text\">create ()</code>에서 반환 된 콜백.</li>\n<li><code class=\"language-text\">inputs</code>  - effect를 파괴하고 재생성 해야하는지 여부를 결정하는 값 집합입니다.</li>\n<li><code class=\"language-text\">next</code>  - Component에서 정의 된 다음 효과에 대한 참조입니다.</li>\n</ul>\n<p><code class=\"language-text\">tag</code> 프로퍼티 외에, 다른 프로퍼티는 이해하기 쉽고 간단합니다. 후크를 잘 연구했다면 React가 <code class=\"language-text\">useMutationEffect()</code> 와 <code class=\"language-text\">useLayoutEffect()</code>와 같은 몇 가지 특수 효과 후크를 제공한다는 것을 알 수 있습니다. 이 두 가지 효과는 내부적으로 <code class=\"language-text\">useEffect()</code> 를 사용합니다. 이것은 본질적으로 effect node를 만드는 것을 의미하지만, 다른 태그 값을 사용하여 effect node를 만듭니다.</p>\n<p>태그는 이진 값의 조합으로 구성됩니다. (see  <a href=\"https://github.com/facebook/react/tree/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactHookEffectTags.js?source=post_page---------------------------\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">implementation</a>):</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> NoEffect <span class=\"token operator\">=</span> <span class=\"token comment\">/*             */</span> <span class=\"token number\">0b00000000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> UnmountSnapshot <span class=\"token operator\">=</span> <span class=\"token comment\">/*      */</span> <span class=\"token number\">0b00000010</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> UnmountMutation <span class=\"token operator\">=</span> <span class=\"token comment\">/*      */</span> <span class=\"token number\">0b00000100</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> MountMutation <span class=\"token operator\">=</span> <span class=\"token comment\">/*        */</span> <span class=\"token number\">0b00001000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> UnmountLayout <span class=\"token operator\">=</span> <span class=\"token comment\">/*        */</span> <span class=\"token number\">0b00010000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> MountLayout <span class=\"token operator\">=</span> <span class=\"token comment\">/*          */</span> <span class=\"token number\">0b00100000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> MountPassive <span class=\"token operator\">=</span> <span class=\"token comment\">/*         */</span> <span class=\"token number\">0b01000000</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> UnmountPassive <span class=\"token operator\">=</span> <span class=\"token comment\">/*       */</span> <span class=\"token number\">0b10000000</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>React에 의해 지원되는 후크 효과 유형.</p>\n<p>이 이진 값의 가장 일반적인 경우는 파이프 라인 (<code class=\"language-text\">|</code>)을 사용하여 비트를 그대로 단일 값에 추가하는 것입니다. 그런 다음 태그가 특정 동작을 구현하는지 여부를 앰퍼샌드 (<code class=\"language-text\">&amp;</code>)를 사용하여 확인할 수 있습니다. 결과가 0이 아니면 태그가 지정된 동작을 구현 함을 의미합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> effectTag <span class=\"token operator\">=</span> MountPassive <span class=\"token operator\">|</span> UnmountPassive\n<span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>effectTag<span class=\"token punctuation\">,</span> <span class=\"token number\">0b11000000</span><span class=\"token punctuation\">)</span>\n<span class=\"token function\">assert</span><span class=\"token punctuation\">(</span>effectTag <span class=\"token operator\">&amp;</span> MountPassive<span class=\"token punctuation\">,</span> <span class=\"token number\">0b10000000</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>React의 바이너리 디자인 패턴을 사용하는 방법을 보여주는 예제.</p>\n<p>다음은 React가 해당 태그와 함께 지원하는 후크 효과 유형입니다. (see  <a href=\"https://github.com/facebook/react/tree/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberHooks.js:520?source=post_page---------------------------\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">implementation</a>):</p>\n<ul>\n<li>Default effect —  <code class=\"language-text\">UnmountPassive | MountPassive</code>.</li>\n<li>Mutation effect —  <code class=\"language-text\">UnmountSnapshot | MountMutation</code>.</li>\n<li>Layout effect —  <code class=\"language-text\">UnmountMutation | MountLayout</code>.</li>\n</ul>\n<p>행동 구현을 위한 React 검사 방법은 다음과 같습니다. (see  <a href=\"https://github.com/facebook/react/tree/5f06576f51ece88d846d01abd2ddd575827c6127/packages/react-reconciler/src/ReactFiberCommitWork.js?source=post_page---------------------------#L309\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">implementation</a>):</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>effect<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">&amp;</span> unmountTag<span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> NoHookEffect<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Unmount</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>effect<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">&amp;</span> mountTag<span class=\"token punctuation\">)</span> <span class=\"token operator\">!==</span> NoHookEffect<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Mount</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>React가 구현 한 실제 스냅 샷.</p>\n<p>그래서, 우리가 방금 배운 효과에 따라, 실제로 우리는 특정 fiber에 효과를 외부 적으로 주입 할 수 있습니다 :</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">injectEffect</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> lastEffect <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>updateQueue<span class=\"token punctuation\">.</span>lastEffect\n\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">destroyEffect</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'on destroy'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">createEffect</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'on create'</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">return</span> destroy\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">const</span> injectedEffect <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    tag<span class=\"token operator\">:</span> <span class=\"token number\">0b11000000</span><span class=\"token punctuation\">,</span>\n    next<span class=\"token operator\">:</span> lastEffect<span class=\"token punctuation\">.</span>next<span class=\"token punctuation\">,</span>\n    create<span class=\"token operator\">:</span> createEffect<span class=\"token punctuation\">,</span>\n    destroy<span class=\"token operator\">:</span> destroyEffect<span class=\"token punctuation\">,</span>\n    inputs<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>createEffect<span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n\n  lastEffect<span class=\"token punctuation\">.</span>next <span class=\"token operator\">=</span> injectedEffect\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> ParentComponent <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token operator\">&lt;</span>ChildComponent ref<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span>injectEffect<span class=\"token punctuation\">}</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>효과 주입의 예.</p>","excerpt":"이글을 번역 및 분석 한 글입니다. 잘못된 번역이 있을 수 있습니다. 또한 예전 코드들이 많으므로 참고만 해야 합니다. 현재 코드랑 다른점이 많이 있습니다. Under the hood of React’s hooks system…","tableOfContents":"<ul>\n<li>\n<p><a href=\"/hood-hook/#under-the-hood-of-reacts-hooks-system\">Under the hood of React’s hooks system</a></p>\n<ul>\n<li><a href=\"/hood-hook/#the-dispatcher\">The dispatcher</a></li>\n<li><a href=\"/hood-hook/#the-hooks-queue\">The hooks queue</a></li>\n<li><a href=\"/hood-hook/#state-hooks\">State hooks</a></li>\n<li><a href=\"/hood-hook/#effect-hooks\">Effect hooks</a></li>\n</ul>\n</li>\n</ul>","fields":{"slug":"/hood-hook/"},"frontmatter":{"title":"Under the hood of React Hooks","date":"Jul 30, 2019","tags":["undefined"],"keywords":["Merlin Tech Blog","Merlin.ho"],"update":"Jan 01, 0001"}}},"pageContext":{"slug":"/hood-hook/","series":[],"lastmod":"0001-01-01"}}}