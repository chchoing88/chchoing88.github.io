{"componentChunkName":"component---src-templates-post-tsx","path":"/build-react.md/","result":{"data":{"markdownRemark":{"html":"<p>이 글은 아래 링크에 있는 글을 참조 했습니다.\n<a href=\"https://engineering.hexacta.com/didact-learning-how-react-works-by-building-it-from-scratch-51007984e5c5\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">참조</a></p>\n<h2 id=\"rendering-dom-element\" style=\"position:relative;\"><a href=\"#rendering-dom-element\" aria-label=\"rendering dom element permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Rendering DOM element</h2>\n<p>우리가 render 할 때 필요한게 뭔지 설명하기 위해 plain JS object 를 하나 만들 것입니다.\n이것을 우리는 element 라고 부를 것입니다. 여기서는 <code class=\"language-text\">type</code> 과 <code class=\"language-text\">props</code>라는 2 개의 프로퍼티가 요구됩니다.\n<code class=\"language-text\">type</code>은 기본 string 또는 function 이 될 수 있고, props 는 비어있을 수 있는 객체가 될것입니다. null 은 오지 않습니다. 여기서 props 는 children 이라는 프로퍼티도 가질 것입니다. children 은 배열로 구성될 것입니다.</p>\n<p>예를 들면 아래와 같습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  type<span class=\"token operator\">:</span> <span class=\"token string\">'div'</span><span class=\"token punctuation\">,</span>\n  props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    id<span class=\"token operator\">:</span> <span class=\"token string\">'container'</span><span class=\"token punctuation\">,</span>\n    children<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'input'</span><span class=\"token punctuation\">,</span> props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> value<span class=\"token operator\">:</span> <span class=\"token string\">'foo'</span><span class=\"token punctuation\">,</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'text'</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'a'</span><span class=\"token punctuation\">,</span> props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> href<span class=\"token operator\">:</span> <span class=\"token string\">'/bar'</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'span'</span><span class=\"token punctuation\">,</span> props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 객체는 아래 dom 을 설명하는 것이 됩니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>container<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">value</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>foo<span class=\"token punctuation\">\"</span></span> <span class=\"token attr-name\">type</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>text<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>a</span> <span class=\"token attr-name\">href</span><span class=\"token attr-value\"><span class=\"token punctuation\">=</span><span class=\"token punctuation\">\"</span>/bar<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>a</span><span class=\"token punctuation\">></span></span>\n  <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>span</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>span</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>DOM Element 를 그려봅시다.</p>\n<p>다음 단계는 element 와 그 element 의 children 을 dom 에 그리는 일입니다. 여기서 우리는 element 와 dom container 를 받는 <code class=\"language-text\">render</code> 함수 (<code class=\"language-text\">ReactDom.render</code>와 같은 )를 이용할 것입니다. 이 함수는 element 에 정의된 dom sub-tree 를 생성하고 container 에 그것을 추가할 것입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">element<span class=\"token punctuation\">,</span> parentDom</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> type<span class=\"token punctuation\">,</span> props <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> element\n  <span class=\"token keyword\">const</span> dom <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> childElement <span class=\"token operator\">=</span> props<span class=\"token punctuation\">.</span>children <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n\n  childElement<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">childElement</span> <span class=\"token operator\">=></span> <span class=\"token function\">render</span><span class=\"token punctuation\">(</span>childElement<span class=\"token punctuation\">,</span> dom<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  parentDom<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>dom<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">render</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">,</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><code class=\"language-text\">render</code>함수는 root Dom 에 실제 element 를 실제 Dom 객체로 바꿔서 append 시킨다.\n위에서 빠뜨린 부분이 있다면 프로퍼티들과 이벤트 리스너이다. <code class=\"language-text\">props</code> 프로퍼티 이름들을 <code class=\"language-text\">Object.keys</code> 를 이용해서 순회하고 알맞게 셋팅해보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">element<span class=\"token punctuation\">,</span> parentDom</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> type<span class=\"token punctuation\">,</span> props <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> element\n  <span class=\"token keyword\">const</span> dom <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// props setting start</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isListener</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">name</span> <span class=\"token operator\">=></span> name<span class=\"token punctuation\">.</span><span class=\"token function\">startWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'on'</span><span class=\"token punctuation\">)</span>\n  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>isListener<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> eventType <span class=\"token operator\">=</span> name<span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">substring</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n      dom<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span>eventType<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isAttribute</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">name</span> <span class=\"token operator\">=></span> <span class=\"token operator\">!</span><span class=\"token function\">isListener</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> name <span class=\"token operator\">!=</span> <span class=\"token string\">'children'</span>\n  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>isAttribute<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      dom<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> props<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// end</span>\n\n  <span class=\"token keyword\">const</span> childElement <span class=\"token operator\">=</span> props<span class=\"token punctuation\">.</span>children <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  childElement<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">childElement</span> <span class=\"token operator\">=></span> <span class=\"token function\">render</span><span class=\"token punctuation\">(</span>childElement<span class=\"token punctuation\">,</span> dom<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  parentDom<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>dom<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>다음은 DOM 의 Text Nodes 를 render 하는 방법이다.\n여기서 Text Node 를 표현하는 방법은 children 배열에 element 객체가 아닌 plain text 가 들어간 경우가 될 것입니다.\n이전 까지는 children 에 element 객체를 품은 배열이였습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> reactElement <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  type<span class=\"token operator\">:</span> <span class=\"token string\">'span'</span><span class=\"token punctuation\">,</span>\n  props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    children<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'Foo'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>하지만 여기서 children 배열에 type 과 props 가 들어간 객체만 온다는 룰을 가지고 있으면 우린 더 적은 if 문을 만들 수 있을 것이다. 해서 text 타입은 \"TEXT ELEMENT\" 라고 props 에는 nodeValue 라는 프로퍼티를 갖게 만들어 봅시다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> textElement <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  type<span class=\"token operator\">:</span> <span class=\"token string\">'span'</span><span class=\"token punctuation\">,</span>\n  props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    children<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span>\n        type<span class=\"token operator\">:</span> <span class=\"token string\">'TEXT_ELEMENT'</span><span class=\"token punctuation\">,</span>\n        props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> nodeValue<span class=\"token operator\">:</span> <span class=\"token string\">'Foo'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>여기서 우리가 정의한 text element 대로 render 하는 함수를 다시 수정해보자. 여기서 달라지는 점이 있다면 일반 dom type 일 경우에는 <code class=\"language-text\">createElement</code> 의 dom api 를 썼을텐데 text 는 <code class=\"language-text\">createTextNode</code> 라는 dom api 를 사용하자.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">element<span class=\"token punctuation\">,</span> parentDom</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> type<span class=\"token punctuation\">,</span> props <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> element\n\n  <span class=\"token comment\">// Create DOM element</span>\n  <span class=\"token keyword\">const</span> isTextElement <span class=\"token operator\">=</span> type <span class=\"token operator\">===</span> <span class=\"token string\">'TEXT ELEMENT'</span>\n  <span class=\"token comment\">// 타입에 따라 다른 api를 사용한다.</span>\n  <span class=\"token keyword\">const</span> dom <span class=\"token operator\">=</span> isTextElement\n    <span class=\"token operator\">?</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createTextNode</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">:</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// Add event listeners</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isListener</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">name</span> <span class=\"token operator\">=></span> name<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'on'</span><span class=\"token punctuation\">)</span>\n  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>isListener<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> eventType <span class=\"token operator\">=</span> name<span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">substring</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n      dom<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span>eventType<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// Set properties</span>\n  <span class=\"token comment\">// 여기서 nodeValue도 셋팅한다.</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isAttribute</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">name</span> <span class=\"token operator\">=></span> <span class=\"token operator\">!</span><span class=\"token function\">isListener</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> name <span class=\"token operator\">!==</span> <span class=\"token string\">'children'</span>\n  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>isAttribute<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      dom<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> props<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// Render children</span>\n  <span class=\"token keyword\">const</span> childElements <span class=\"token operator\">=</span> props<span class=\"token punctuation\">.</span>children <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  childElements<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">childElement</span> <span class=\"token operator\">=></span> <span class=\"token function\">render</span><span class=\"token punctuation\">(</span>childElement<span class=\"token punctuation\">,</span> dom<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// Append to parent</span>\n  parentDom<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>dom<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"element-creation-and-jsx\" style=\"position:relative;\"><a href=\"#element-creation-and-jsx\" aria-label=\"element creation and jsx permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Element creation and JSX</h2>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  type<span class=\"token operator\">:</span> <span class=\"token string\">'div'</span><span class=\"token punctuation\">,</span>\n  props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    id<span class=\"token operator\">:</span> <span class=\"token string\">'container'</span><span class=\"token punctuation\">,</span>\n    children<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n      <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'input'</span><span class=\"token punctuation\">,</span> props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> value<span class=\"token operator\">:</span> <span class=\"token string\">'foo'</span><span class=\"token punctuation\">,</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'text'</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        type<span class=\"token operator\">:</span> <span class=\"token string\">'a'</span><span class=\"token punctuation\">,</span>\n        props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          href<span class=\"token operator\">:</span> <span class=\"token string\">'/bar'</span><span class=\"token punctuation\">,</span>\n          children<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'TEXT ELEMENT'</span><span class=\"token punctuation\">,</span> props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> nodeValue<span class=\"token operator\">:</span> <span class=\"token string\">'bar'</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">{</span>\n        type<span class=\"token operator\">:</span> <span class=\"token string\">'span'</span><span class=\"token punctuation\">,</span>\n        props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n          <span class=\"token function-variable function\">onClick</span><span class=\"token operator\">:</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Hi'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n          children<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>\n            <span class=\"token punctuation\">{</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'TEXT ELEMENT'</span><span class=\"token punctuation\">,</span> props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> nodeValue<span class=\"token operator\">:</span> <span class=\"token string\">'click me'</span> <span class=\"token punctuation\">}</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n          <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 Element 를 좀 더 쉽게 만들기 위해 JSX 를 사용하면 쉽게 읽히면서도 쉽게 표현이 된다. 여기서 JSX 는 우리가 DOM 에 무엇을 표현하고 싶은지를 설명해주는 한 방법이다.</p>\n<p>바벨을 사용한다면 JSX 표현은 다음과 같이 변경된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>\n  <span class=\"token operator\">&lt;</span>div id<span class=\"token operator\">=</span><span class=\"token string\">\"container\"</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>input value<span class=\"token operator\">=</span><span class=\"token string\">\"foo\"</span> type<span class=\"token operator\">=</span><span class=\"token string\">\"text\"</span> <span class=\"token operator\">/</span><span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>a href<span class=\"token operator\">=</span><span class=\"token string\">\"/bar\"</span><span class=\"token operator\">></span>bar<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>a<span class=\"token operator\">></span>\n    <span class=\"token operator\">&lt;</span>span onClick<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Hi'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token operator\">></span>click me<span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>span<span class=\"token operator\">></span>\n  <span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>div<span class=\"token operator\">></span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p><a href=\"https://babeljs.io/repl/#?babili=false&#x26;evaluate=true&#x26;lineWrap=false&#x26;presets=react&#x26;targets=&#x26;browsers=&#x26;builtIns=false&#x26;debug=false&#x26;code=%2F**%20%40jsx%20createElement%20*%2F%0A%0Aconst%20element%20%3D%20%28%0A%20%20%3Cdiv%20id%3D%22container%22%3E%0A%20%20%20%20%3Cinput%20value%3D%22foo%22%20type%3D%22text%22%20%2F%3E%0A%20%20%20%20%3Ca%20href%3D%22%2Fbar%22%3Ebar%3C%2Fa%3E%0A%20%20%20%20%3Cspan%20onClick%3D%7Be%20%3D%3E%20alert%28%22Hi%22%29%7D%3Eclick%20me%3C%2Fspan%3E%0A%20%20%3C%2Fdiv%3E%0A%29%3B\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">try it on babel REPL</a></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> <span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>\n  <span class=\"token string\">'div'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token string\">'container'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'input'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> value<span class=\"token operator\">:</span> <span class=\"token string\">'foo'</span><span class=\"token punctuation\">,</span> type<span class=\"token operator\">:</span> <span class=\"token string\">'text'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'a'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> href<span class=\"token operator\">:</span> <span class=\"token string\">'/bar'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'bar'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'span'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> <span class=\"token function-variable function\">onClick</span><span class=\"token operator\">:</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Hi'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'click me'</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">)</span></code></pre></div>\n<p>그래서 우린 <code class=\"language-text\">createElement</code> 함수를 만들어 줄 것이다. 첫번째 인자는 <code class=\"language-text\">type</code> 인자이고 두번째 인자는 <code class=\"language-text\">props</code> 이다. 그리고 나머지 인자들은 <code class=\"language-text\">children</code> 이다.\n<code class=\"language-text\">createElement</code> 함수는 <code class=\"language-text\">props</code> 객체를 만들어주고 두번째 인자의 값들을 전부 할당해 주어야 한다. 또, <code class=\"language-text\">children</code> 프로퍼티는 두번째 이후로 오는 인자들을(...args) 배열로 만들어서 <code class=\"language-text\">props</code> 의 <code class=\"language-text\">children</code> 프로퍼티에 셋팅해준다. 그리고 type 과 props 를 반환하면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">type<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> props <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> hasChildren <span class=\"token operator\">=</span> args<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span>\n  props<span class=\"token punctuation\">.</span>children <span class=\"token operator\">=</span> hasChildren <span class=\"token operator\">?</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> type<span class=\"token punctuation\">,</span> props <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 createElement 함수에서 text node 에 해당하는게 하나 빠져있다. 위 함수대로 작동을 한다면 아래 span 의 text node 의 경우에 그냥 string 값이 들어갈 것이다.</p>\n<p>아까 우린 위에서 text node 도 <code class=\"language-text\">{ type: TEXT_ELEMENT, props: {nodeValue: &#39;test&#39;}}</code> 로 만들어 주기로 했었다. 해서 createElement 를 수정해야 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> spanElement <span class=\"token operator\">=</span> <span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>\n  <span class=\"token string\">'span'</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> <span class=\"token function-variable function\">onClick</span><span class=\"token operator\">:</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Hi'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token string\">'click me'</span>\n<span class=\"token punctuation\">)</span>\n\nspanElement <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  type<span class=\"token operator\">:</span> <span class=\"token string\">'span'</span><span class=\"token punctuation\">,</span>\n  props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function-variable function\">onClick</span><span class=\"token operator\">:</span> <span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token function\">alert</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Hi'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n    children<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'click me'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token comment\">// [{type: TEXT_ELEMTN, props: {nodeValue: 'click me'}}]</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>수정해 보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token constant\">TEXT_ELEMENT</span> <span class=\"token operator\">=</span> <span class=\"token string\">'TEXT ELEMENT'</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">type<span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">,</span> <span class=\"token operator\">...</span>args</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> props <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> config<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> hasChildren <span class=\"token operator\">=</span> args<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span>\n  <span class=\"token keyword\">const</span> rawChildren <span class=\"token operator\">=</span> hasChildren <span class=\"token operator\">?</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span><span class=\"token operator\">...</span>args<span class=\"token punctuation\">)</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token comment\">// children 배열을 돌면서 textElement는 TEXT ELEMENT 타입으로 변환해서 넣어준다.</span>\n  props<span class=\"token punctuation\">.</span>children <span class=\"token operator\">=</span> rawChildren\n    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">c</span> <span class=\"token operator\">=></span> c <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">&amp;&amp;</span> c <span class=\"token operator\">!==</span> <span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">c</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>c <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Object</span> <span class=\"token operator\">?</span> c <span class=\"token operator\">:</span> <span class=\"token function\">createTextElement</span><span class=\"token punctuation\">(</span>c<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span> type<span class=\"token punctuation\">,</span> props <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// text element 생성</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">createTextElement</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">value</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token constant\">TEXT_ELEMENT</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> nodeValue<span class=\"token operator\">:</span> value <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2 id=\"instances-reconciliation-and-virtual-dom\" style=\"position:relative;\"><a href=\"#instances-reconciliation-and-virtual-dom\" aria-label=\"instances reconciliation and virtual dom permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Instances, reconciliation and virtual DOM</h2>\n<p>지금까지는 JSX 설명을 기반으로 dom 요소를 만드는 메커니즘을 구현했습니다. 이번에는 DOM 을 어떻게 업데이트 시키는지에 대해서 포커스를 둘 것입니다.\n우선 setState 를 설명하기 전까지 dom update 를 할수 있는 방법은 달라진 element 를 가지고 render 함수를 반복해서 시키는 방법입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> rootDom <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'root'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">tick</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> time <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Date</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toLocaleTimeString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> clockElement <span class=\"token operator\">=</span> <span class=\"token operator\">&lt;</span>h1<span class=\"token operator\">></span><span class=\"token punctuation\">{</span>time<span class=\"token punctuation\">}</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>h1<span class=\"token operator\">></span>\n  <span class=\"token function\">render</span><span class=\"token punctuation\">(</span>clockElement<span class=\"token punctuation\">,</span> rootDom<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">tick</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n<span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span>tick<span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p><a href=\"https://codepen.io/pomber/pen/KmXeXr?editors=0010\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">codepen</a></p>\n<p>위에서 계속 바왔던 <code class=\"language-text\">render</code> 함수는 container 에 element 를 넘기면 element 를 dom 으로 만들어서 container 에 append 시키는 함수이다. element 의 children 도 <code class=\"language-text\">render</code> 재귀로 돌면서 실행하게 된다.</p>\n<p>기존 <code class=\"language-text\">render</code> 는 매 <code class=\"language-text\">tick</code>할 시에 같은 div 를 업데이트하는 대신에 새로운 것을 추가하는 방식이라서 update 에 적합하지가 않다.\n그래서 처음으로 바꿔야 할 부분은 각 업데이트에 대해 dom 을 replace 하는 작업이고, render 함수 마지막 부분에 우리는 parent 에 어떤 child 가 있다면 그것을 새롭게 element 로 만들어진 dom 으로 교체 되도록 한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">element<span class=\"token punctuation\">,</span> parentDom</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n  <span class=\"token comment\">// Create dom from element</span>\n  <span class=\"token comment\">// ...</span>\n\n  <span class=\"token comment\">// Append or replace dom</span>\n  <span class=\"token comment\">// lastChild는 노드의 마지막 자식을 반환합니다.</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>parentDom<span class=\"token punctuation\">.</span>lastChild<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    parentDom<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>dom<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// replaceChild(newChild, oldChild);</span>\n    parentDom<span class=\"token punctuation\">.</span><span class=\"token function\">replaceChild</span><span class=\"token punctuation\">(</span>dom<span class=\"token punctuation\">,</span> parentDom<span class=\"token punctuation\">.</span>lastChild<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><a href=\"https://codepen.io/pomber/pen/eWGQRz?editors=0010\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">codepen</a></p>\n<p>첫번째 render 시에 h1 에 TEXT<em>ELEMENT 를 먼저 append 하고 h1 을 root 컨테이너 dom 에 append 합니다.\n두번째 부터는 render 시에는 똑같이 h1 에 TEXT</em>ELEMENT 를 먼저 append 하고 만들어진 h1 을 root 컨테이너에 append 하기 전에 root 컨테이너에 lastchild 가 있다면 parentDom.lastchild 를 dom 으로 replace 한다.</p>\n<p><strong>여기서 문제점은 update 상황에서 render 시에 모든 children 을 재 생성해서 마지막 root container dom 에만 replace 한다는 점이다. render 에서 모든 element 타입에 대해서 새로 만들기 때문에 자식들의 부모의 lastChild 는 null 이 되어 appendChild 가 실행될 것이다. 그 상황에서 기존에 그려놨던 root 의 경우에는 이미 한번 그려져 있는게 있기 때문에 replace 로직으로 처리가 된다.</strong></p>\n<p>이런 작은 상황에서는 잘 동작하지만 좀 더 복잡한 케이스에서는 모든 child node 들을 재 생성 하는 퍼포먼스 비용이 만족스럽지 않습니다.\n그래서 우린 현재 <strong>새로 생성한 elements tree 와 이전 render 를 호출했을 때 사용되었던 element tree 를 비교</strong>해서 달라진 곳만 update 시켜야 한다.</p>\n<h3 id=\"virtual-dom-and-reconciliation\" style=\"position:relative;\"><a href=\"#virtual-dom-and-reconciliation\" aria-label=\"virtual dom and reconciliation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Virtual DOM and Reconciliation</h3>\n<p>React 에서는 위에서 말한 달라진 곳을 비교하는 이 \"diffing\" 프로세싱을 <strong>reconciliation</strong> 이라 부릅니다. 우리도 이와같이 하기 위해서 <strong>이전 render 에 사용 되었던 element tree 구조를 보관할 필요가 있고 이것을 새로운 element tree 구조와 비교할 것입니다. 다른말로 하면 우리의 virtual DOM 버젼을 계속 유지해 나갈 것이다.</strong></p>\n<p>virtual DOM 안에 있는 \"노드들\"은 무엇을 해야 할까요? 한가지 옵션으로 단지 Elements 로 사용을 하는 것입니다. 이 Elements 들은 <code class=\"language-text\">props.children</code> 프로퍼티를 이미 가지고 있다. 이 프로퍼티는 tree 구조 처럼 element 들 탐색을 가능하게 합니다. 하지만 여기서 2 가지 문제점이 있는데, 하나는 reconciliation 을 좀 더 쉽게 진행하기 위해서 각 노드의 virtual DOM 에 실제 dom 을 참조하고 있어야 한다는 점이고, element 들을 immutable 하게 유지해야 한다. 두번째 문제는 우리는 나중에 본인만의 state 를 갖고 있는 Components 를 지원할 것이고 element 들이 그것을 다루지 못하게 해야한다.</p>\n<h3 id=\"instances\" style=\"position:relative;\"><a href=\"#instances\" aria-label=\"instances permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Instances</h3>\n<p>그래서 우리는 새로운 용어인 Instances 를 소개할 것입니다. <strong>instance 는 DOM 에 렌더링 된 element 를 나타냅니다.</strong> 또한 element, dom, 그리고 childInstances 의 프로퍼티들을 지닌 plain 객체 입니다. childInstances 는 children element 의 instancese 들을 지닌 배열입니다.</p>\n<p>각 DOM 노드는 매칭된 instance 를 가지고 있을 것입니다. reconciliation 알고리즘의 한가지 목표는 가능한한 많이 instance 를 creating 또는 removing 을 피하는 것입니다.\n여기서 instance 를 creating 그리고 removing 한다는 것은 DOM tree 를 수정해야 한다는 의미 일 것입니다.\ninstance 를 재사용할수록 DOM 트리를 수정하는 횟수가 줄어 듭니다.</p>\n<h3 id=\"refactoring\" style=\"position:relative;\"><a href=\"#refactoring\" aria-label=\"refactoring permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Refactoring</h3>\n<p>여기서 우리 render 함수를 reconciliation 알고리즘을 적용해보고, element 를 주어지면 instance 를 생성하는 instantiate 함수를 추가해보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> rootInstance <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">element<span class=\"token punctuation\">,</span> container</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> prevInstance <span class=\"token operator\">=</span> rootInstance\n  <span class=\"token keyword\">const</span> nextInstance <span class=\"token operator\">=</span> <span class=\"token function\">reconcile</span><span class=\"token punctuation\">(</span>container<span class=\"token punctuation\">,</span> prevInstance<span class=\"token punctuation\">,</span> element<span class=\"token punctuation\">)</span>\n  rootInstance <span class=\"token operator\">=</span> nextInstance\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// reconcile ( 조정하다, 조화시키다, 일치시키다. )</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">reconcile</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">parentDom<span class=\"token punctuation\">,</span> instance<span class=\"token punctuation\">,</span> element</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 인자값 : 부모 real DOM, 이전 instance , 새로운 element</span>\n  <span class=\"token comment\">// 이전에 그려진 instance가 없다면 append</span>\n  <span class=\"token comment\">// 그려진 instance가 있다면 replace 작업을 한다.</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>instance <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 초기 render 시</span>\n    <span class=\"token keyword\">const</span> newInstance <span class=\"token operator\">=</span> <span class=\"token function\">instantiate</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">)</span>\n    parentDom<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>newInstance<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> newInstance\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// update render 시</span>\n    <span class=\"token keyword\">const</span> newInstance <span class=\"token operator\">=</span> <span class=\"token function\">instantiate</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">)</span>\n    parentDom<span class=\"token punctuation\">.</span><span class=\"token function\">replaceChild</span><span class=\"token punctuation\">(</span>newInstance<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">,</span> instance<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> newInstance\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// element를 받아서 트리구조를 돌면서 instance 구조 {dom, element, childInstances}를 만든다.</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">instantiate</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">element</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> type<span class=\"token punctuation\">,</span> props <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> element\n\n  <span class=\"token comment\">// Create DOM element</span>\n  <span class=\"token keyword\">const</span> isTextElement <span class=\"token operator\">=</span> type <span class=\"token operator\">===</span> <span class=\"token string\">'TEXT ELEMENT'</span>\n  <span class=\"token keyword\">const</span> dom <span class=\"token operator\">=</span> isTextElement\n    <span class=\"token operator\">?</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createTextNode</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">:</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// Add event listeners</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isListener</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">name</span> <span class=\"token operator\">=></span> name<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'on'</span><span class=\"token punctuation\">)</span>\n  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>isListener<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> eventType <span class=\"token operator\">=</span> name<span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">substring</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n      dom<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span>eventType<span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// Set properties</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isAttribute</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">name</span> <span class=\"token operator\">=></span> <span class=\"token operator\">!</span><span class=\"token function\">isListener</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> name <span class=\"token operator\">!=</span> <span class=\"token string\">'children'</span>\n  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>isAttribute<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      dom<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> props<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// Instantiate and append children</span>\n  <span class=\"token keyword\">const</span> childElements <span class=\"token operator\">=</span> props<span class=\"token punctuation\">.</span>children <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">const</span> childInstances <span class=\"token operator\">=</span> childElements<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>instantiate<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> childDoms <span class=\"token operator\">=</span> childInstances<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">childInstance</span> <span class=\"token operator\">=></span> childInstance<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n  childDoms<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">childDom</span> <span class=\"token operator\">=></span> dom<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>childDom<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">const</span> instance <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> dom<span class=\"token punctuation\">,</span> element<span class=\"token punctuation\">,</span> childInstances <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> instance\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이전과 코드는 같지만, 여기서 다른점은 마지막으로 호출한 render 에서 나온 instance 를 저장하고 있다는점이다. 또한 reconciliation 함수를 instantiation 으로 부터 분리 했습니다.\ndom nodes 를 재사용하기 위해서는, dom 프로퍼티들을 update 할 방법이 필요하다. ( className, style, onCLick, etc...) 등등의 업데이트 그래서 dom 프로퍼티를 update 하는 함수를 따로 분리해서 작성해보자.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// element를 받아서 트리구조를 돌면서 instance 구조 {dom, element, childInstances}를 만든다.</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">instantiate</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">element</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> type<span class=\"token punctuation\">,</span> props <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> element\n\n  <span class=\"token comment\">// Create DOM element</span>\n  <span class=\"token keyword\">const</span> isTextElement <span class=\"token operator\">=</span> type <span class=\"token operator\">===</span> <span class=\"token string\">'TEXT ELEMENT'</span>\n  <span class=\"token keyword\">const</span> dom <span class=\"token operator\">=</span> isTextElement\n    <span class=\"token operator\">?</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createTextNode</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n    <span class=\"token operator\">:</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span>\n\n  <span class=\"token function\">updateDomProperties</span><span class=\"token punctuation\">(</span>dom<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// Instantiate and append children</span>\n  <span class=\"token keyword\">const</span> childElements <span class=\"token operator\">=</span> props<span class=\"token punctuation\">.</span>children <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">const</span> childInstances <span class=\"token operator\">=</span> childElements<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>instantiate<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> childDoms <span class=\"token operator\">=</span> childInstances<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">childInstance</span> <span class=\"token operator\">=></span> childInstance<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n  childDoms<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">childDom</span> <span class=\"token operator\">=></span> dom<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>childDom<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">const</span> instance <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> dom<span class=\"token punctuation\">,</span> element<span class=\"token punctuation\">,</span> childInstances <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> instance\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// dom을 만들고 나서 dom의 프로퍼티들을 셋팅할때 사용한다.</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">updateDomProperties</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">dom<span class=\"token punctuation\">,</span> prevProps<span class=\"token punctuation\">,</span> nextProps</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isEvent</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">name</span> <span class=\"token operator\">=></span> name<span class=\"token punctuation\">.</span><span class=\"token function\">startsWith</span><span class=\"token punctuation\">(</span><span class=\"token string\">'on'</span><span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">isAttribute</span> <span class=\"token operator\">=</span> <span class=\"token parameter\">name</span> <span class=\"token operator\">=></span> <span class=\"token operator\">!</span><span class=\"token function\">isEvent</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">)</span> <span class=\"token operator\">&amp;&amp;</span> name <span class=\"token operator\">!=</span> <span class=\"token string\">'children'</span>\n\n  <span class=\"token comment\">// Remove event listeners</span>\n  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>prevProps<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>isEvent<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> eventType <span class=\"token operator\">=</span> name<span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">substring</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n      dom<span class=\"token punctuation\">.</span><span class=\"token function\">removeEventListener</span><span class=\"token punctuation\">(</span>eventType<span class=\"token punctuation\">,</span> prevProps<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// Remove attributes</span>\n  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>prevProps<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>isAttribute<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      dom<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// Set attributes</span>\n  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>nextProps<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>isAttribute<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      dom<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> nextProps<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// Add event listeners</span>\n  Object<span class=\"token punctuation\">.</span><span class=\"token function\">keys</span><span class=\"token punctuation\">(</span>nextProps<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>isEvent<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">name</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> eventType <span class=\"token operator\">=</span> name<span class=\"token punctuation\">.</span><span class=\"token function\">toLowerCase</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">substring</span><span class=\"token punctuation\">(</span><span class=\"token number\">2</span><span class=\"token punctuation\">)</span>\n      dom<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span>eventType<span class=\"token punctuation\">,</span> nextProps<span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">updateDomProperties</code> 함수는 이전 프로퍼티들을 모두 제거하고 새로운 것들을 추가한다. 이것은 프로퍼티가 변경되도 변화를 시키지 않으므로 불필요한 업데이트가 많이 발생하지만 단순하게하기 위해 지금은 그대로 두겠습니다.</p>\n<h3 id=\"reusing-dom-nodes\" style=\"position:relative;\"><a href=\"#reusing-dom-nodes\" aria-label=\"reusing dom nodes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Reusing DOM nodes</h3>\n<p>reconciliation 알고리즘은 DOM nodes 를 가능하면 재 사용하는 것이라고 말했습니다. 그래서 type 이 같다면 해당 DOM node 를 재사용할 것입니다. ( 프로퍼티만 update 할것이다. )</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">reconcile</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">parentDom<span class=\"token punctuation\">,</span> instance<span class=\"token punctuation\">,</span> element</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>instance <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Create instance</span>\n    <span class=\"token keyword\">const</span> newInstance <span class=\"token operator\">=</span> <span class=\"token function\">instantiate</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">)</span>\n    parentDom<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>newInstance<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> newInstance\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">.</span>element<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> element<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Update instance</span>\n    <span class=\"token comment\">// 여기서 instance dom은 기존에 render 되었던 이전 instance 이다.</span>\n    <span class=\"token comment\">// 이전 instance에 Real dom을 재사용해서 프로퍼티들만 update 시켜준다.</span>\n    <span class=\"token function\">updateDomProperties</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">,</span> instance<span class=\"token punctuation\">.</span>element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">,</span> element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">)</span>\n    instance<span class=\"token punctuation\">.</span>element <span class=\"token operator\">=</span> element\n    <span class=\"token keyword\">return</span> instance\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Replace instance</span>\n    <span class=\"token keyword\">const</span> newInstance <span class=\"token operator\">=</span> <span class=\"token function\">instantiate</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">)</span>\n    parentDom<span class=\"token punctuation\">.</span><span class=\"token function\">replaceChild</span><span class=\"token punctuation\">(</span>newInstance<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">,</span> instance<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> newInstance\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h3 id=\"children-reconciliation\" style=\"position:relative;\"><a href=\"#children-reconciliation\" aria-label=\"children reconciliation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Children Reconciliation</h3>\n<p>reconcile 함수에서 가장 중요한 작업을 놓쳤습니다. children 을 실행시키지 않았다는 점이다.\nChildren reconciliation 은 주요 기술중 하나이다. 여기서는 이전과 현재 tree 구조에서 children 을 매칭 하기 위해 key 라는 추가 프로퍼티가 요구됩니다.\n여기서는 오직 같은 children 배열에서 같은 위치의 children 끼리만 비교하겠습니다. 이것이 의미하는 바는 children 순서가 달라지면 DOM nodes 를 재사용하지 못한다는 비용이 든다는 점입니다.</p>\n<p>Children reconciliation 을 실행하기 위해선 이전 child instances 인 <code class=\"language-text\">instance.childInstances</code> 와 새로운 element 의 children <code class=\"language-text\">element.props.children</code>을 매칭시킬 것입니다. 그리곤 재귀적으로 reconcil 함수를 호출할 것입니다. 또한 reconcile 에서 리턴된 모든 instances 들을 유지해서 childInstances 를 업데이트 할 수 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">reconcile</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">parentDom<span class=\"token punctuation\">,</span> instance<span class=\"token punctuation\">,</span> element</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>instance <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Create instance</span>\n    <span class=\"token keyword\">const</span> newInstance <span class=\"token operator\">=</span> <span class=\"token function\">instantiate</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">)</span>\n    parentDom<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>newInstance<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> newInstance\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">.</span>element<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> element<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Update instance</span>\n    <span class=\"token comment\">// 타입이 같을때 dom을 재사용한다.</span>\n    <span class=\"token function\">updateDomProperties</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">,</span> instance<span class=\"token punctuation\">.</span>element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">,</span> element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 그리곤 children에 대해서 reconcile을 적용한다.</span>\n    <span class=\"token comment\">// children 은 배열이기 때문에 배열 처리를 위한 reconcileChildren 함수를 활용한다.</span>\n    instance<span class=\"token punctuation\">.</span>childInstances <span class=\"token operator\">=</span> <span class=\"token function\">reconcileChildren</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">,</span> element<span class=\"token punctuation\">)</span>\n    instance<span class=\"token punctuation\">.</span>element <span class=\"token operator\">=</span> element\n    <span class=\"token keyword\">return</span> instance\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Replace instance</span>\n    <span class=\"token comment\">// 부모가 기존 인스턴스에서 새로운 인스턴스로 replace 한다면 그 부모 children 들도 새로 instance를 생성한다.</span>\n    <span class=\"token keyword\">const</span> newInstance <span class=\"token operator\">=</span> <span class=\"token function\">instantiate</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">)</span>\n    parentDom<span class=\"token punctuation\">.</span><span class=\"token function\">replaceChild</span><span class=\"token punctuation\">(</span>newInstance<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">,</span> instance<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> newInstance\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">reconcileChildren</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">instance<span class=\"token punctuation\">,</span> element</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> dom <span class=\"token operator\">=</span> instance<span class=\"token punctuation\">.</span>dom\n  <span class=\"token keyword\">const</span> childInstances <span class=\"token operator\">=</span> instance<span class=\"token punctuation\">.</span>childInstances\n  <span class=\"token keyword\">const</span> nextChildElements <span class=\"token operator\">=</span> element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>children <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">const</span> newChildInstances <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">const</span> count <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span>childInstances<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span> nextChildElements<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> count<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> childInstance <span class=\"token operator\">=</span> childInstances<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token comment\">// 이미 그려져 있는 children instance들.</span>\n    <span class=\"token keyword\">const</span> childElement <span class=\"token operator\">=</span> nextChildElements<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span> <span class=\"token comment\">// 새로 그려야 할 children element들</span>\n    <span class=\"token keyword\">const</span> newChildInstance <span class=\"token operator\">=</span> <span class=\"token function\">reconcile</span><span class=\"token punctuation\">(</span>dom<span class=\"token punctuation\">,</span> childInstance<span class=\"token punctuation\">,</span> childElement<span class=\"token punctuation\">)</span>\n    newChildInstances<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>newChildInstance<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> newChildInstances\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>위 코드에서 reconcile 함수 안에서 instance 를 새로 생성하는 경우 ( 맨 처음 render 가 된다거나 type 이 바뀌는 replace 의 경우) 해당 부모의 자식(children) 들도 새로이 instance 를 생성한다. 즉, 부모가 instance 가 만들어지면 그 자식들도 새롭게 instance 를 만든다. 자식이 type 이 같더라도 부모가 바뀌었기 때문에 재 사용하지 못한다. <br/></p>\n<p>대신에 부모 element 의 type 이 같아서 dom 을 재사용 할때는 자식들을 하나하나 reconcile 처리 해준다. 이때, 자식도 type 이 같다면 재사용 가능.</p>\n<h3 id=\"removing-dom-nodes\" style=\"position:relative;\"><a href=\"#removing-dom-nodes\" aria-label=\"removing dom nodes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Removing DOM nodes</h3>\n<p>만약에 <code class=\"language-text\">nextChildElements</code>가 <code class=\"language-text\">childInstances</code> 보다 length 가 더 길다면 reconcileChildren 함수는 reconcile 함수를 호출할 때 instance 를 <code class=\"language-text\">undifined</code>로 해서 호출할 것이다. 그러면 <code class=\"language-text\">if(instance == null)</code> 에 걸려서 새로운 instance 를 생성할 것이다. 반면에 반대가 된다면 어떨까?</p>\n<p><code class=\"language-text\">childInstances</code>가 <code class=\"language-text\">nextChildElements</code> 보다 length 가 더 길다면 reconcile 함수에서 childElement 인자를 <code class=\"language-text\">undefined</code>를 보낼 것이다. 이때 reconcile 함수에서는 <code class=\"language-text\">element.type</code> 체크시 에러가 발생하게 된다.</p>\n<p>dom 이 제거되는걸 고려하지 않았기 때문이다. 그래서 두가지를 체크 할 것이다. 하나는 reconcile 함수에서 element 가 null 인 경우와 reconcileChildren 함수에서 newChildInstance 가 null 인 경우를 필터해줄 것이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">reconcile</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">parentDom<span class=\"token punctuation\">,</span> instance<span class=\"token punctuation\">,</span> element</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>instance <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Create instance</span>\n    <span class=\"token comment\">// 기존에 그려진 instance가 없는 경우 element 값이 들어왔으면 새로이 추가한다.</span>\n    <span class=\"token keyword\">const</span> newInstance <span class=\"token operator\">=</span> <span class=\"token function\">instantiate</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">)</span>\n    parentDom<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>newInstance<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> newInstance\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>element <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Remove instance</span>\n    <span class=\"token comment\">// 이전에 그려졌던 instance 가 있는데 element가 null 이라는건 새로운 수정사항이 dom을 삭제했다는 것이다.</span>\n    <span class=\"token comment\">// 그래서 그에 매칭 되는 instance.dom 을 제거해주자.</span>\n    parentDom<span class=\"token punctuation\">.</span><span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// 여기서 null 을 리턴해주기 때문에 reconcileChildren 함수에서 null을 filter 처리 한다.</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">.</span>element<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> element<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Update instance</span>\n    <span class=\"token function\">updateDomProperties</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">,</span> instance<span class=\"token punctuation\">.</span>element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">,</span> element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">)</span>\n    instance<span class=\"token punctuation\">.</span>childInstances <span class=\"token operator\">=</span> <span class=\"token function\">reconcileChildren</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">,</span> element<span class=\"token punctuation\">)</span>\n    instance<span class=\"token punctuation\">.</span>element <span class=\"token operator\">=</span> element\n    <span class=\"token keyword\">return</span> instance\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Replace instance</span>\n    <span class=\"token comment\">// 이미 그려진 instance가 있고 element도 새로 들어왔는데 type이 다르다면 새로 만들어서 교체한다.</span>\n    <span class=\"token keyword\">const</span> newInstance <span class=\"token operator\">=</span> <span class=\"token function\">instantiate</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">)</span>\n    parentDom<span class=\"token punctuation\">.</span><span class=\"token function\">replaceChild</span><span class=\"token punctuation\">(</span>newInstance<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">,</span> instance<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> newInstance\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 인스턴스의 childInstance가 배열이기 때문에 이 배열을 돌면서 reconcile 처리.</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">reconcileChildren</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">instance<span class=\"token punctuation\">,</span> element</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> dom <span class=\"token operator\">=</span> instance<span class=\"token punctuation\">.</span>dom <span class=\"token comment\">// 기존에 그려졌던 dom</span>\n  <span class=\"token keyword\">const</span> childInstances <span class=\"token operator\">=</span> instance<span class=\"token punctuation\">.</span>childInstances\n  <span class=\"token keyword\">const</span> nextChildElements <span class=\"token operator\">=</span> element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>children <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">const</span> newChildInstances <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n  <span class=\"token keyword\">const</span> count <span class=\"token operator\">=</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">max</span><span class=\"token punctuation\">(</span>childInstances<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span> nextChildElements<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> count<span class=\"token punctuation\">;</span> i<span class=\"token operator\">++</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> childInstance <span class=\"token operator\">=</span> childInstances<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">const</span> childElement <span class=\"token operator\">=</span> nextChildElements<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">const</span> newChildInstance <span class=\"token operator\">=</span> <span class=\"token function\">reconcile</span><span class=\"token punctuation\">(</span>dom<span class=\"token punctuation\">,</span> childInstance<span class=\"token punctuation\">,</span> childElement<span class=\"token punctuation\">)</span>\n    newChildInstances<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>newChildInstance<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// reconcile 함수에서 childElement가 null인 경우에 dom이 제거됬다고 간주하고 null 을 반환할 것이다.</span>\n  <span class=\"token keyword\">return</span> newChildInstances<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">instance</span> <span class=\"token operator\">=></span> instance <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><a href=\"https://codepen.io/pomber/pen/WjLqYW?editors=0010\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">codepen</a></p>\n<p>여기까지 정리를 해보면 처음에 <code class=\"language-text\">element</code> 를 받아서 무조건 dom 을 만들고 dom tree 구조를 render 함수 내에서 구조를 잡고 진행하게 되는데 맨 처음에는 render 를 모두 진행하고 나서 <code class=\"language-text\">parentDom.appendChild(dom)</code> 를 진행했다. 이러면 발생되는 문제는 계속 root dom 화면에 동일한 구조가 추가가 된다는 점이다.</p>\n<p>이러면 안되기 때문에 replace 를 추가 하게 된다. <code class=\"language-text\">parentDom.replaceChild(dom, parentDom.lastChild)</code> 라는 로직을 추가 하게 되는데 조건은 <code class=\"language-text\">parentDom.lastChild</code>의 유무로 판단하게 된다. 이렇게 되면 root dom 밑으로 replace 가 이뤄져서 tick 같은 app 에서 원하는 조건(동일한 자리에 update 된 화면)을 달성 할 수 있다.</p>\n<p>여기서 또 한가지의 문제는 그리고자 하는 트리형 dom 이 원하는 자리에 replace 가 되지만, 그 dom 의 <code class=\"language-text\">children</code> 에 대해서는 계속 새롭게 그린다는 점이다. 그러니깐 통으로 새로 그려서 화면의 같은자리에 replace 하고 다시 update 가 필요할땐 통으로 dom 을 새로 만들어 다시 replace 를 한다는 점이다. 변화가 필요한 dom 만 그리지 않고 전부 다시 그리는 셈이 되므로 복잡한 UI 의 경우 비용이 많이 들게 되어있다.</p>\n<p>그래서 update 시 dom type 이 같다면 새로 create 하는 것이 아닌 dom 의 속성(props)만 update 하고 기존의 dom 은 그대로 쓰는 <code class=\"language-text\">reconcile</code> 함수를 만들었으며, 기존 그려졌던 <code class=\"language-text\">element</code>의 type 비교와 더불어 dom 의 재사용을 위한 새로운 개념인 <code class=\"language-text\">instance : {dom, element, childInstances }</code> 라는것을 도입했다. 또한 한번 그려진 이전 <code class=\"language-text\">instance</code>는 별도로 저장을 해둔다.\n여기서 reconcile 함수의 역할은 parentDom, 이전의 그려졌던 instance, 새로운 element 받아서 조건에 맞게끔 dom 에 그려준다.</p>\n<p>그래서 reconcile 의 함수에는 다음과 같은 조건이 붙는다.</p>\n<ul>\n<li>이전에 그려놓은 <code class=\"language-text\">instance</code> 가 없다면 새로 <code class=\"language-text\">instance</code> 를 만들고 만들어진 dom 을 append 시킨다.</li>\n<li>새로 그려지는 <code class=\"language-text\">element</code> 가 null 이라면 매칭되는 <code class=\"language-text\">parentDom</code> 에서 자식들을 삭제한다.</li>\n<li>이전에 그려놓은 <code class=\"language-text\">instance</code> 의 element type 과 새로 그릴려는 <code class=\"language-text\">element type</code> 이 같으면 이전에 그려 놓은 <code class=\"language-text\">instance</code> 의 dom 에 prop 만 업데이트 한다. 그리고 나서 해당 <code class=\"language-text\">instance</code> 의 <code class=\"language-text\">children</code> 을 <code class=\"language-text\">reconcil</code> 을 한다. 여기서 따로 <code class=\"language-text\">reconcileChildren</code> 함수가 존재하는 이유는 <code class=\"language-text\">children</code> 이 배열 타입이기 때문이다.</li>\n<li>그 외 모든 경우에는 <code class=\"language-text\">parentDom</code> 기준으로 새롭게 <code class=\"language-text\">instance</code> 를 만들어서 replace 한다.</li>\n</ul>\n<p>여기까지의 문제는 dom 을 재사용하긴 했다지만 모든 변화에 대해서 전체 dom 에 대한 render 를 진행한다는 것이다.</p>\n<h2 id=\"components-and-state\" style=\"position:relative;\"><a href=\"#components-and-state\" aria-label=\"components and state permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Components and State</h2>\n<p>위 코드에서는 몇몇 가지 문제사항이 있었다.</p>\n<ul>\n<li>모든 변화에 전체 virtual DOM tree 를 reconciliation 을 진행합니다.</li>\n<li>State 가 글로벌하게 존재합니다.</li>\n<li>state 가 변화 된 후 render 함수를 좀 더 명시적으로 호출해야 합니다.</li>\n</ul>\n<p>Components 는 이러한 이슈를 해결하는데 도움을 줄수 있습니다.</p>\n<ul>\n<li>JSX 를 이용해 Custom tag 를 정의 할 수 있습니다.</li>\n<li>lifecycle 이벤트에 Hook 을 걸수 있습니다.</li>\n</ul>\n<p>먼저해야 할 일은 컴포넌트가 확장 될 Component 기본 클래스를 제공하는 것입니다. 우리는 구성 요소 상태를 업데이트하는 데 사용할 <code class=\"language-text\">partialState</code>를 받는 <code class=\"language-text\">setState</code> 메서드와 props 매개 변수가있는 생성자가 필요합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props <span class=\"token operator\">=</span> props\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">partialState</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">,</span> partialState<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>어플리케이션 코드에서는 이 클래스를 상속받을 것입니다. 그 후에 div 와 span 같이 <code class=\"language-text\">&lt;MyComponent&gt;</code> 처럼 사용할 것입니다.\n여기서 중요한건 우리가 만들었던 <code class=\"language-text\">createElement</code> 수정이 필요 없습니다. element <code class=\"language-text\">type</code>으로 class 컴포넌트를 받고 <code class=\"language-text\">props</code>를 다룰것입니다.\n우리는 요소가 주어진 컴포넌트 인스턴스( public instances 라고 부릅니다.) 를 생성하는 함수가 필요합니다.\n여기서 <code class=\"language-text\">public instance</code> 라고 하는건 class 컴포넌트의 인스턴스입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">createPublicInstance</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">element<span class=\"token punctuation\">,</span> internalInstance</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// type이 class 일 경우</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> type<span class=\"token punctuation\">,</span> props <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> element\n  <span class=\"token keyword\">const</span> publicInstance <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">type</span><span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">)</span>\n  publicInstance<span class=\"token punctuation\">.</span>__internalInstance <span class=\"token operator\">=</span> internalInstance\n  <span class=\"token keyword\">return</span> publicInstance\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>public instance 생성하는 것 외에도 internal instance(from the virtual DOM) 의 레퍼런스를 추가적으로 가지고 있기 때문에 public instance state 가 변경 되었을때 해당 인스턴스 하위트리만 (instance sub-tree) 업데이트 할 수 있어야 합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props <span class=\"token operator\">=</span> props\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">partialState</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">,</span> partialState<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// this.__internalInstance는 가상 DOM { dom, element, childInstance, publicInstance }</span>\n    <span class=\"token function\">updateInstance</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>__internalInstance<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">updateInstance</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">internalInstance</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> parentDom <span class=\"token operator\">=</span> internalInstance<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">.</span>parentNode\n  <span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> internalInstance<span class=\"token punctuation\">.</span>element\n  <span class=\"token comment\">// 보통은 render시에 reconcile을 진행하지만</span>\n  <span class=\"token comment\">// setState가 있을 시에도 reconcile을 진행 할 수 있다.</span>\n  <span class=\"token function\">reconcile</span><span class=\"token punctuation\">(</span>parentDom<span class=\"token punctuation\">,</span> internalInstance<span class=\"token punctuation\">,</span> element<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">instantiate</code> 함수도 update 가 필요합니다. components 들은 public instace 로 생성하고 component 의 <code class=\"language-text\">render</code> 함수를 child element 를 얻기 위해 호출해준다. 그리곤 해당 element 를 다시 <code class=\"language-text\">instantiate</code> 함수로 호출해준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// element를 받아서 트리구조를 돌면서 instance 구조 {dom, element, childInstances}를 만든다.</span>\n<span class=\"token comment\">// element : {type: Component , props: { ... , children: []}}</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">instantiate</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">element</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> type<span class=\"token punctuation\">,</span> props <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> element\n  <span class=\"token keyword\">const</span> isDomElement <span class=\"token operator\">=</span> <span class=\"token keyword\">typeof</span> type <span class=\"token operator\">===</span> <span class=\"token string\">'string'</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isDomElement<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Instantiate DOM element</span>\n    <span class=\"token keyword\">const</span> isTextElement <span class=\"token operator\">=</span> type <span class=\"token operator\">===</span> <span class=\"token constant\">TEXT_ELEMENT</span>\n    <span class=\"token keyword\">const</span> dom <span class=\"token operator\">=</span> isTextElement\n      <span class=\"token operator\">?</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createTextNode</span><span class=\"token punctuation\">(</span><span class=\"token string\">''</span><span class=\"token punctuation\">)</span>\n      <span class=\"token operator\">:</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span>type<span class=\"token punctuation\">)</span>\n\n    <span class=\"token function\">updateDomProperties</span><span class=\"token punctuation\">(</span>dom<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> props<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">const</span> childElements <span class=\"token operator\">=</span> props<span class=\"token punctuation\">.</span>children <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token comment\">// childElements 는 배열로 들어오기 때문에 map 돌리면서 instantiate 함수 호출해줌.</span>\n    <span class=\"token keyword\">const</span> childInstances <span class=\"token operator\">=</span> childElements<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>instantiate<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> childDoms <span class=\"token operator\">=</span> childInstances<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">childInstance</span> <span class=\"token operator\">=></span> childInstance<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n    childDoms<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">childDom</span> <span class=\"token operator\">=></span> dom<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>childDom<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">const</span> instance <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> dom<span class=\"token punctuation\">,</span> element<span class=\"token punctuation\">,</span> childInstances <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">return</span> instance\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// element.type이 class 일 경우.</span>\n    <span class=\"token comment\">// Instantiate component element</span>\n    <span class=\"token keyword\">const</span> instance <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">const</span> publicInstance <span class=\"token operator\">=</span> <span class=\"token function\">createPublicInstance</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">,</span> instance<span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// childElement은 배열이 아니다.</span>\n    <span class=\"token keyword\">const</span> childElement <span class=\"token operator\">=</span> publicInstance<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">// child 인스턴스가 하나임.</span>\n    <span class=\"token keyword\">const</span> childInstance <span class=\"token operator\">=</span> <span class=\"token function\">instantiate</span><span class=\"token punctuation\">(</span>childElement<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> dom <span class=\"token operator\">=</span> childInstance<span class=\"token punctuation\">.</span>dom\n    <span class=\"token comment\">// instance 에 publicInstance를 넣기 위해서 Object.assign을 사용</span>\n    Object<span class=\"token punctuation\">.</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span> dom<span class=\"token punctuation\">,</span> element<span class=\"token punctuation\">,</span> childInstance<span class=\"token punctuation\">,</span> publicInstance <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> instance\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>component elements 와 dom elements 를 위한 internal instances(this.__internalInstance)는 다르다. Component internal instance 들은 오직 하나의 child(render 함수에서 리턴되는) 만 가지고 있다. 그래서 internal instance 들은 dom instances 들이 가지고 있는 <code class=\"language-text\">childInstances</code> 배열 인스턴스들 대신에 <code class=\"language-text\">childInstance</code> 프로퍼티 하나를 가지고 있다. 또한, component internal instance 들은 public instance (class 컴포넌트의 인스턴스) 를 가지고 있을 필요가 있다. 그래야 render 함수가 reconciliation 하는 동안 불려질수 있기 때문이다.</p>\n<p>한가지 놓친것이 있다면 component instance 의 reconciliation 를 다루는 것이다. 그래서 우린 reconciliation algorithm 에 한가지 케이스를 더 추가할 것이다. children reconciliation 을 다루지 않아도 되는 한가지 child 만 가지고 있는 component instance 가 주어졌을때, 우린 public instance 의 props 를 update 시키고 child 를 re-render 시켜주면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// dom을 어떤 방식으로 그릴지를 결정하는 함수</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">reconcile</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">parentDom<span class=\"token punctuation\">,</span> instance<span class=\"token punctuation\">,</span> element</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>instance <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Create instance</span>\n    <span class=\"token keyword\">const</span> newInstance <span class=\"token operator\">=</span> <span class=\"token function\">instantiate</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">)</span>\n    parentDom<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>newInstance<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> newInstance\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>element <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Remove instance</span>\n    parentDom<span class=\"token punctuation\">.</span><span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">.</span>element<span class=\"token punctuation\">.</span>type <span class=\"token operator\">!==</span> element<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Replace instance</span>\n    <span class=\"token keyword\">const</span> newInstance <span class=\"token operator\">=</span> <span class=\"token function\">instantiate</span><span class=\"token punctuation\">(</span>element<span class=\"token punctuation\">)</span>\n    parentDom<span class=\"token punctuation\">.</span><span class=\"token function\">replaceChild</span><span class=\"token punctuation\">(</span>newInstance<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">,</span> instance<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> newInstance\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> element<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Update dom instance</span>\n    <span class=\"token function\">updateDomProperties</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">,</span> instance<span class=\"token punctuation\">.</span>element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">,</span> element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">)</span>\n    instance<span class=\"token punctuation\">.</span>childInstances <span class=\"token operator\">=</span> <span class=\"token function\">reconcileChildren</span><span class=\"token punctuation\">(</span>instance<span class=\"token punctuation\">,</span> element<span class=\"token punctuation\">)</span>\n    instance<span class=\"token punctuation\">.</span>element <span class=\"token operator\">=</span> element\n    <span class=\"token keyword\">return</span> instance\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">//Update composite instance</span>\n    instance<span class=\"token punctuation\">.</span>publicInstance<span class=\"token punctuation\">.</span>props <span class=\"token operator\">=</span> element<span class=\"token punctuation\">.</span>props\n    <span class=\"token keyword\">const</span> childElement <span class=\"token operator\">=</span> instance<span class=\"token punctuation\">.</span>publicInstance<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">const</span> oldChildInstance <span class=\"token operator\">=</span> instance<span class=\"token punctuation\">.</span>childInstance\n    <span class=\"token keyword\">const</span> childInstance <span class=\"token operator\">=</span> <span class=\"token function\">reconcile</span><span class=\"token punctuation\">(</span>parentDom<span class=\"token punctuation\">,</span> oldChildInstance<span class=\"token punctuation\">,</span> childElement<span class=\"token punctuation\">)</span>\n    instance<span class=\"token punctuation\">.</span>dom <span class=\"token operator\">=</span> childInstance<span class=\"token punctuation\">.</span>dom\n    instance<span class=\"token punctuation\">.</span>childInstance <span class=\"token operator\">=</span> childInstance\n    instance<span class=\"token punctuation\">.</span>element <span class=\"token operator\">=</span> element\n    <span class=\"token keyword\">return</span> instance\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이게 전부이다. 이 코드를 사용해서 활용한 예제이다. : <a href=\"https://codepen.io/pomber/pen/RVqBrx\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">codepen</a></p>\n<p>class Component 에서 setState 를 사용하면 해당 컴포넌트를 기준으로 children 에 대한 <code class=\"language-text\">reconcile</code>을 진행한다.\n<code class=\"language-text\">reconcile</code>을 진행한다는 것은 이전 instance 와 새로 들어온 element 를 비교해서 어떤 방법으로 dom 을 렌더링 할지를 결정하게 되는 것이다.\n<code class=\"language-text\">instantiate</code>를 실행한다는 것은 새롭게 들어온 element 가 이전 그려논거랑 완전히 달라졌을 때를 실행하게 된다.</p>\n<h2 id=\"fiber-incremental-reconciliation\" style=\"position:relative;\"><a href=\"#fiber-incremental-reconciliation\" aria-label=\"fiber incremental reconciliation permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Fiber: Incremental reconciliation</h2>\n<p>리액트 16 버젼이 출시 되었다. 그것은 리액트의 코드 대부분을 재 작성해야 할 필요가 생긴 새로운 내부적인 아키텍쳐를 가지고 있다.\n이것은 예전 아키텍처로는 개발하기 힘든 일부 기능이 선적되었음을 의미합니다. 또한 이 시리즈에서 작성한 대부분의 코드는 현재 가치가 없다는 것을 의미합니다.</p>\n<p>이제는 16 에서 사용하는 새로운 아키텍쳐를 사용해서 다시 코드를 작성해볼 예정이다. 특히, 구조, 변수들, 함수이름들을 리액트 코드베이스로 부터 가져와서 작성할 것입니다.\n여기서 우리가 건들지 않아도 되는 API 는 다음과 같습니다.</p>\n<ul>\n<li>createElemetn()</li>\n<li>render() (오직 DOM 을 rendering 하는 함수)</li>\n<li>Component ( setState() 메서드를 포함한. context 나 life cycle 은 미포함)</li>\n</ul>\n<p>이제 왜 우리가 예전 코드를 다시 작성해야 하는지를 설명하겠다.</p>\n<h3 id=\"why-fiber\" style=\"position:relative;\"><a href=\"#why-fiber\" aria-label=\"why fiber permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Why Fiber</h3>\n<p>브라우저의 메인 쓰레드는 시간을 많이 쓰는 무엇인가로 인해 매우 바쁘게 움직이고 있다고 할때, 매우 중요한 task 들은 끝날때 까지 기다려야 한다.</p>\n<p>이런 문제를 위해서 몇가지 데모를 준비했다. <a href=\"https://pomber.github.io/incremental-rendering-demo/react-sync.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">데모</a>에서 행서들이 도는걸 유지하기 위해서 메인 쓰레드는 매 16ms 마다 사용가능 하도록 유지 시켜주어야 한다. 만약 이 메인쓰레드가 다른 무엇인가로 blocked 당했다고 한다면 여기서 매 200ms 라고 해봅시다. 메인 쓰레드가 다시 자유로워 질때 까지 행성들이 멈춰있고 해당 프레임이 사라지는걸 확인 할 수 있을 것입니다.</p>\n<p>에니메이션을 부드럽고 UI 응답을 유지하기 위해 예비의 마이크로 초도 둘수없게 무엇이 메인쓰레드를 바쁘게 했을까요?</p>\n<p><code class=\"language-text\">reconciliation</code> 코드를 기억합니까? 한번 <code class=\"language-text\">reconciliation</code> 코드를 실행하면 멈추지 않습니다. 메인 스레드가 다른 작업을 수행해야하는 경우 <code class=\"language-text\">reconciliation</code> 코드는 대기 해야합니다. 그리고 이 <code class=\"language-text\">reconciliation</code> 코드는 많은 재귀 호출로 인해서 지연될 수 있는 코드 입니다. 이런 이유로 우리는 해당 코드를 재귀 호출을 루프로 교체 가능한 새로운 데이터 구조를 사용하는 <code class=\"language-text\">reconciliation</code> 코드를 재 작성해야 합니다.</p>\n<h3 id=\"scheduling-micro-tasks\" style=\"position:relative;\"><a href=\"#scheduling-micro-tasks\" aria-label=\"scheduling micro tasks permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Scheduling micro-tasks</h3>\n<p>우린 이제 작업을 작은 단위로 나눌 필요가 있습니다. 이것들은 짧은 시간동안 동작하기 위한 조각들입니다. 메인 스레드가 더 우선 순위가 높은 작업을 수행하게하고 보류중인 작업이 있으면 작업을 끝내기 위해 다시 돌아옵니다.\n이 작업을 돕기 위해서 <code class=\"language-text\">requestIdleCallback()</code> 함수를 이용 할 것입니다. 이것은 <code class=\"language-text\">callback</code> 함수를 큐에 넣어 두는데 이것은 브라우저가 idle 타임에 호출이 되고, 얼만큼 이용가능한 시간인지 설명해주는 <code class=\"language-text\">deadline</code> 파라미터를 포함하고 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token constant\">ENOUGH_TIME</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token comment\">// milliseconds</span>\n\n<span class=\"token keyword\">let</span> workQueue <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">let</span> nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">schedule</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">task</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  workQueue<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>task<span class=\"token punctuation\">)</span>\n  <span class=\"token function\">requestIdleCallback</span><span class=\"token punctuation\">(</span>performWork<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// requestIdleCallback 인자로 들어갈 함수</span>\n<span class=\"token comment\">// 이 함수는 브라우저가 idle 시점에 호출되고</span>\n<span class=\"token comment\">// deadline 파라미터로 적절한 시간이 남았는지를 확인해서 해당 로직을 수행한다.</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">performWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">deadline</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// 다음 작업이 남아있는지를 확인</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>nextUnitOfWork<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    nextUnitOfWork <span class=\"token operator\">=</span> workQueue<span class=\"token punctuation\">.</span><span class=\"token function\">shift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 다음 작업이 있고 시간이 충분히 남았다면 작업 수행</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextUnitOfWork <span class=\"token operator\">&amp;&amp;</span> deadline<span class=\"token punctuation\">.</span><span class=\"token function\">timeRemaining</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token constant\">ENOUGH_TIME</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span>nextUnitOfWork<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextUnitOfWork <span class=\"token operator\">||</span> workQueue<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">requestIdleCallback</span><span class=\"token punctuation\">(</span>performWork<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>실제 작업은 <code class=\"language-text\">performUnitOfWork</code> 함수에서 일어납니다. <code class=\"language-text\">performUnitOfWork</code> 안에 우리의 <strong>reconciliation code</strong> (이전 instance 와 새로 들어온 element 를 비교해서 어떤 방법(replace, append,...)으로 dom 을 렌더링할지를 결정) 를 작성할 필요가 있습니다.\n<code class=\"language-text\">performUnitOfWork</code> 함수는 작업의 조각을 동작시켜야 합니다. 그리곤 다음에 작업을 다시 시작하는 데 필요한 모든 정보를 반환해야 햡니다.</p>\n<p>이런 작업의 조각들을 추적하기위해 <code class=\"language-text\">fiber</code> 들을 사용할 것입니다. 즉, <code class=\"language-text\">fiber</code> 는 일련의 작업을 다시 시작하기 위해 만들어졌고 이것을 작업 정보 명세서라고 생각하면 될거 같습니다.</p>\n<h3 id=\"the-fiber-data-structure\" style=\"position:relative;\"><a href=\"#the-fiber-data-structure\" aria-label=\"the fiber data structure permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>The fiber data structure</h3>\n<p>우리는 render(그려지기)를 원하는 각 컴포넌트에 대해 fiber 를 생성할 것입니다. <code class=\"language-text\">nextUnitOfWork</code> 는 우리가 원하는 다음 작업인 next fiber 를 위한 참조 값입니다. <code class=\"language-text\">performUnitOfWork</code> 는 fiber 대한 작업을하고 완료가 되면 모든 작업이 끝날때 까지 새로운 fiber 를 리턴합니다.</p>\n<p>fiber 는 어떻게 생겼는가?</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">let</span> fiber <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  tag<span class=\"token operator\">:</span> <span class=\"token constant\">HOST_COMPONENT</span><span class=\"token punctuation\">,</span>\n  type<span class=\"token operator\">:</span> <span class=\"token string\">'div'</span><span class=\"token punctuation\">,</span>\n  parent<span class=\"token operator\">:</span> parentFiber<span class=\"token punctuation\">,</span>\n  child<span class=\"token operator\">:</span> childFiber<span class=\"token punctuation\">,</span>\n  sibling<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  alternate<span class=\"token operator\">:</span> currentFiber<span class=\"token punctuation\">,</span>\n  stateNode<span class=\"token operator\">:</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">createElement</span><span class=\"token punctuation\">(</span><span class=\"token string\">'div'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n  props<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> children<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> className<span class=\"token operator\">:</span> <span class=\"token string\">'foo'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  partialState<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n  effectTag<span class=\"token operator\">:</span> <span class=\"token constant\">PLACEMENT</span><span class=\"token punctuation\">,</span>\n  effects<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이것은 보통의 자바스크립트 객체입니다.</p>\n<p>우리는 <code class=\"language-text\">parents</code>, <code class=\"language-text\">child</code> 그리고 <code class=\"language-text\">sibling</code> 프로퍼티를 사용하여 component 의 tree 를 설명 하는 fiber 들의 tree 를 구축합니다.</p>\n<p><code class=\"language-text\">stateNode</code>는 component instance 에 대한 참조 값이다. 이 값으론 DOM element (createDomElement) 또는 유저가 정의한 class component 의 instance (createInstance) 를 가질 수 있습니다.  </p>\n<p>예를 들면 :</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/ho_blog/static/8a3af4245f4db32744bd10e2fe3f154c/0a47e/fiber01.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.27027027027027%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsSAAALEgHS3X78AAABB0lEQVQoz3WRy07EMAxF+//fhliwgwWPSqBOO43r2s7DSVrcMiCGoZalKLJvfK7TeBJyMqGK84QEADihcy6mtK7rO+j9K60H0cQYEfD00avqn1rS0kPoINS61rr8Iw4hLHVhmUstvwtfveOc2sGjJB+y6S0trsR2SORc8pV473kb5O4ZglYtNWqxZLt86zdxyUWCFIO7wQaK5LPmWsqlmnL1McsO0njv643sB7vD/NAycJoohrRNfupi6/K64S/N0PcTABGxyO0TosuZbVRhr/tAbYdwQt19LQ0zjXAeYRQRozAXGqNRHrEA6RmjOTcvDSIKC7N48fM8G4JuW8hHf/vY5xd3WdgnVxgOSWCdrrMAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"fiber01.png\"\n        title=\"fiber01.png\"\n        src=\"/ho_blog/static/8a3af4245f4db32744bd10e2fe3f154c/fcda8/fiber01.png\"\n        srcset=\"/ho_blog/static/8a3af4245f4db32744bd10e2fe3f154c/12f09/fiber01.png 148w,\n/ho_blog/static/8a3af4245f4db32744bd10e2fe3f154c/e4a3f/fiber01.png 295w,\n/ho_blog/static/8a3af4245f4db32744bd10e2fe3f154c/fcda8/fiber01.png 590w,\n/ho_blog/static/8a3af4245f4db32744bd10e2fe3f154c/0a47e/fiber01.png 600w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>위 예제에서 우리가 지원할 서로 다른 3 가지 종류의 컴포넌트들을 볼수 있습니다.</p>\n<ul>\n<li><code class=\"language-text\">b</code>,<code class=\"language-text\">p</code> 그리고 <code class=\"language-text\">i</code> 를 위한 fiber 들은 <strong>host components</strong> 표현합니다. 이들의 식별자는 tag 에 <code class=\"language-text\">HOST_COMPONENT</code> 라고 지칭 할것이다. <code class=\"language-text\">type</code>은 string(html element 의 태그) 이 될것입니다. <code class=\"language-text\">props</code>는 속성값과 해당 element 의 이벤트 리스너가 되겠습니다.</li>\n<li><code class=\"language-text\">Foo</code> fiber 는 <strong>class component</strong> 를 표현합니다. 이것의 <code class=\"language-text\">tag</code>는 <code class=\"language-text\">CLASS_COMPONENT</code> 가 될 것이고, <code class=\"language-text\">type</code>은 유저가 정의한 <code class=\"language-text\">Didact.Component</code>를 상속한 <code class=\"language-text\">class</code> 의 참조값이 될것이다.</li>\n<li><code class=\"language-text\">div</code>를 위한 fiber 는 <strong>host root</strong> 를 표현합니다. 이것은 위에서 언급한 host component 과 유사한데 그 이유는 <code class=\"language-text\">stateNode</code> 와 같은 DOM element 를 지니고 있기 때문입니다. 그러나 이 host root 는 트리의 root 가 되어서 특별하게 다뤄질 것입니다. <code class=\"language-text\">tag</code>는 <code class=\"language-text\">HOST_ROOT</code>가 될것입니다. 이 fiber 의 <code class=\"language-text\">stateNode</code> 는 <code class=\"language-text\">Didact.render()</code>로 전달 받은 DOM node 이다.</li>\n</ul>\n<p>다른 중요한 프로퍼티는 <code class=\"language-text\">alternate</code> 입니다. 이 <code class=\"language-text\">alternate</code> 가 필요한 이유는 대부분의 시간동안에 두가지의 fiber tree 를 가져야 하기 때문입니다.\n<strong>한가지 tree 는 우리가 이미 render 한 DOM 에 관한 것이고, 이것을 우린 current tree 또는 old tree 라고 부를 것이다. 또 다른 하나는 우리가 <code class=\"language-text\">setState()</code> 또는 <code class=\"language-text\">Didact.render()</code> 호출을 통해서 새로운 update 작업을 할때 생성되는 tree 이다. 이것을 우린 <em>work-in-progress</em> tree 라고 부를 것입니다.</strong></p>\n<p>work-in-progress tree 는 old tree 를 가진 어떤 fiber 와도 공유하지 않습니다. (이것은 work-in-progress tree 를 만들때 매번 새로운 객체 fiber 로 만든다는 이야기 이다.) 일단 work-in-progress tree 를 완성하고 필요한 DOM 을 변화를 만들 필요성을 가지면, 다시 이 work-in-progress tree 가 old tree 가 됩니다.</p>\n<p>따라서 <code class=\"language-text\">alternate</code>는 work-in-progress tree fiber 들을 old tree 에 상응하는 fiber 들과 연결하기 위해 사용합니다. fiber 와 그것의 <code class=\"language-text\">alternate</code>는 같은 <code class=\"language-text\">tag</code>, <code class=\"language-text\">type</code> 그리고 <code class=\"language-text\">stateNode</code>를 공유합니다. 때론 새로운 rendering 작업이 있을떈 fiber 들은 <code class=\"language-text\">alternate</code>를 안가지고 있을 수 있습니다.</p>\n<p>여기서 <code class=\"language-text\">alternate</code>는 처음에 dom 에 그릴땐 어떤한 값을 안가지고 있다가 dom 을 그리고 나고 다시 render 시에는 _rootContainerFiber 값을 <code class=\"language-text\">alternate</code>에 할당합니단. 그 이후에 <code class=\"language-text\">reconcileChildrenArray</code> (children 돌면서 fiber 를 만들어 줌) 메서드 실행시에 <code class=\"language-text\">wipFiber.alternate.child</code>를 <code class=\"language-text\">oldFiber</code>로 활용합니다.</p>\n<p>마지막으로, <code class=\"language-text\">effects</code>리스트와 <code class=\"language-text\">effectTag</code>를 갖습니다. work-in-progress tree 안에서 DOM 이 변화할 필요가 있는 fiber 를 찾았을때 <code class=\"language-text\">effectTag</code>를 <code class=\"language-text\">PLACEMENT</code>, <code class=\"language-text\">UPDATE</code> 또는 <code class=\"language-text\">DELETION</code>으로 설정합니다. 모든 DOM 변화를 손쉽게 처리하기 위해 <code class=\"language-text\">effectTag</code>를 가지고 있는 모든 자식 fiber 들의 목록(fiber 하위 트리로부터 나온 fiber 들)을 <code class=\"language-text\">effects</code>에 유지합니다.</p>\n<h3 id=\"didact-call-hierarchy\" style=\"position:relative;\"><a href=\"#didact-call-hierarchy\" aria-label=\"didact call hierarchy permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Didact call hierarchy</h3>\n<p>우리가 작성하려고하는 코드의 흐름을 이해하려면이 다이어그램을 살펴보십시오.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 584px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/ho_blog/static/cb798eaf0c4d3390f2b386a01f152b71/e05eb/fiber02.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 80.4054054054054%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAIAAACZeshMAAAACXBIWXMAAAsSAAALEgHS3X78AAABpElEQVQoz42TD2+DIBDF/f7fcFvm1k5R/NeKAoKg+7U2jTHNsktL4I5373F3Jus/TClV17UQ4nK57P0Jf2unrrtqY7F9LISAZ1nXZVmMMX3fxxiP4EvXFuePMEGguPeMgSykDDH2w8CmKIpxHI/gUanq8609f7VSHgQHrVVRNOfzrJRzbp/6AVZ9Lz/T+uu7zvN9jItRqblpbFWtfT9ZOwzDEfyH+Xmu2lZIqaeH/QVe7rb3UKdKyoNzO75gJkCdvffwsLler1LKeZ55Mx42OF+DqXBVVbSUynOJxtLhPM+7rgNJRjxZluGkbUcwYfBIpTZQkQJY27b4NzaYh7txfCGbMOnD3UivtQb/fBI/kNaYF7IBIBud0HJk5cF4nsOnrc3LsrnPafIs0iYShVBtmjf9qGC91WlZkBHr2mTZJAQKk3WJQL1zZckIyjRNy7Lc5pR3kovj6XRiHY3xjMrPjxfCZxltuDFT+2HUId46BAkv3PqEMcwImZx7tMr7cffxJK5ObZWOxXvoxeR80zR0Aqkwk4U9nDTGTtOi9SylEYIVVYB/AW9hoM7D2JM/AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"fiber02.png\"\n        title=\"fiber02.png\"\n        src=\"/ho_blog/static/cb798eaf0c4d3390f2b386a01f152b71/e05eb/fiber02.png\"\n        srcset=\"/ho_blog/static/cb798eaf0c4d3390f2b386a01f152b71/12f09/fiber02.png 148w,\n/ho_blog/static/cb798eaf0c4d3390f2b386a01f152b71/e4a3f/fiber02.png 295w,\n/ho_blog/static/cb798eaf0c4d3390f2b386a01f152b71/e05eb/fiber02.png 584w\"\n        sizes=\"(max-width: 584px) 100vw, 584px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><code class=\"language-text\">render()</code> 및 <code class=\"language-text\">setState()</code> 에서 시작하여 <code class=\"language-text\">commitAllWork()</code> 에서 끝나는 흐름을 따릅니다.</p>\n<h3 id=\"old-code\" style=\"position:relative;\"><a href=\"#old-code\" aria-label=\"old code permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Old code</h3>\n<p>대부분의 코드를 재 작성해야 한다고 이야기 했었습니다. 하지만 먼저 수정하지 않을 코드가 있는지 살펴봅시다.</p>\n<p>트랜스파일된 JSX 가 사용하는 함수인 <code class=\"language-text\">createElement</code> 함수를 작성했습니다. 우리가 작성한 <code class=\"language-text\">createElement()</code> 함수는 변할 필요가 없다. 우린 계속 동일한 element 들을 사용할 것이기 때문입니다. 여기서 element 는 <code class=\"language-text\">type</code>,<code class=\"language-text\">props</code> 그리고 <code class=\"language-text\">children</code>을 가진 평범한 자바스크립트 객체였습니다.</p>\n<p>우린 노드의 DOM 프로퍼티를 갱신 하기 위해 <code class=\"language-text\">updateDomProperties()</code> 도 작성했었습니다. 또 DOM element 들을 생성하기 위해 <code class=\"language-text\">createDomElement()</code> 함수도 추출했습니다. 이 두 함수 모두 <a href=\"https://gist.github.com/pomber/c63bd22dbfa6c4af86ba2cae0a863064\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">이곳</a>에서 볼수 있습니다.</p>\n<p>base class 인 <code class=\"language-text\">Component</code> 도 작성했었습니다. 여기서 <code class=\"language-text\">setState()</code>가 <code class=\"language-text\">scheduleUpdate()</code> 를 호출하게 만들고 <code class=\"language-text\">createInstance()</code> 가 instance 에 fiber 를 참조하도록 만듭시다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">class</span> <span class=\"token class-name\">Component</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">constructor</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>props <span class=\"token operator\">=</span> props <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>state <span class=\"token operator\">||</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">partialState</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">scheduleUpdate</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">this</span><span class=\"token punctuation\">,</span> partialState<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">createInstance</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> instance <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">fiber<span class=\"token punctuation\">.</span>type</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">)</span>\n  instance<span class=\"token punctuation\">.</span>__fiber <span class=\"token operator\">=</span> fiber\n  <span class=\"token keyword\">return</span> instance\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>이 코드로 시작하고 나머지는 처음부터 다시 작성하지 않습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/ho_blog/static/925fc0565fc5ec71cb75ccc91b85eb95/8c557/fiber03.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.62162162162162%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAhUlEQVQI12WOwQoDIQxE9/8/0IuKoOtN0JVGG6O26dqWlp1DiGRmfNvj1Jzzd67lqlJKSqm1tp4b+7z3WmvnXM4ZAIjoGrsB3BFjSvu+I+I7PMYwxgghpJTWWm5RSrEjhLBaFgUhwnHkGGut48P1+plNTMKz9843Lm6n/uDZVgpxkuiL9gTP0+hEPHz+hQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"fiber03.png\"\n        title=\"fiber03.png\"\n        src=\"/ho_blog/static/925fc0565fc5ec71cb75ccc91b85eb95/fcda8/fiber03.png\"\n        srcset=\"/ho_blog/static/925fc0565fc5ec71cb75ccc91b85eb95/12f09/fiber03.png 148w,\n/ho_blog/static/925fc0565fc5ec71cb75ccc91b85eb95/e4a3f/fiber03.png 295w,\n/ho_blog/static/925fc0565fc5ec71cb75ccc91b85eb95/fcda8/fiber03.png 590w,\n/ho_blog/static/925fc0565fc5ec71cb75ccc91b85eb95/8c557/fiber03.png 700w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><code class=\"language-text\">Component</code> 클래스와 <code class=\"language-text\">createElement()</code> 외에도 <code class=\"language-text\">render()</code>와 <code class=\"language-text\">setState()</code>라는 두 개의 공용 함수가 있으며 <code class=\"language-text\">setState()</code>가 <code class=\"language-text\">scheduleUpdate()</code>를 호출하는 것을 보았습니다.\n<code class=\"language-text\">render()</code> 및 <code class=\"language-text\">scheduleUpdate()</code> 도 비슷합니다. 이 두 함수들은 새 업데이트 할것을 받고 대기열(큐)에 넣습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// Fiber tags</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">HOST_COMPONENT</span> <span class=\"token operator\">=</span> <span class=\"token string\">'host'</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">CLASS_COMPONENT</span> <span class=\"token operator\">=</span> <span class=\"token string\">'class'</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">HOST_ROOT</span> <span class=\"token operator\">=</span> <span class=\"token string\">'root'</span>\n\n<span class=\"token comment\">// Global state</span>\n<span class=\"token keyword\">const</span> updateQueue <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n<span class=\"token keyword\">let</span> nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token keyword\">let</span> pendingCommit <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n<span class=\"token comment\">// render 함수</span>\n<span class=\"token comment\">// 아래서 render 함수라는건 이 함수를 가리킴</span>\n<span class=\"token comment\">// 이 render는 처음에 딱 한번 실행함.</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">elements<span class=\"token punctuation\">,</span> containerDom</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  updateQueue<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">from</span><span class=\"token operator\">:</span> <span class=\"token constant\">HOST_ROOT</span><span class=\"token punctuation\">,</span>\n    dom<span class=\"token operator\">:</span> containerDom<span class=\"token punctuation\">,</span>\n    newProps<span class=\"token operator\">:</span> <span class=\"token punctuation\">{</span> children<span class=\"token operator\">:</span> elements <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">requestIdleCallback</span><span class=\"token punctuation\">(</span>performWork<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">scheduleUpdate</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">instance<span class=\"token punctuation\">,</span> partialState</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  updateQueue<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">from</span><span class=\"token operator\">:</span> <span class=\"token constant\">CLASS_COMPONENT</span><span class=\"token punctuation\">,</span>\n    instance<span class=\"token operator\">:</span> instance<span class=\"token punctuation\">,</span>\n    partialState<span class=\"token operator\">:</span> partialState<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">requestIdleCallback</span><span class=\"token punctuation\">(</span>performWork<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">updateQueue</code> 배열을 사용해서 보류중인 update 추적할 것입니다. 매 <code class=\"language-text\">render()</code> 또는 <code class=\"language-text\">scheduleUpdate()</code> 호출은 새로운 업데이트를 <code class=\"language-text\">updateQueue</code> 큐에 넣습니다.\n각 업데이트들의 업데이트 정보는 다르고 이것을 우리가 나중에 <code class=\"language-text\">resetNextUnitOfWork()</code> 에서 어떻게 사용할지 볼 수 있을것입니다.</p>\n<p>업데이트를 큐에 넣고 나서, <code class=\"language-text\">performWork()</code>에 대한 지연(deferred) 호출을 트리거합니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/ho_blog/static/f7dc85e94c54deaebdbe6e0fc381b0a2/8c557/fiber04.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.62162162162162%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAhUlEQVQI12WOSw6FIBAEuf8ZCWwQDGieAeU76OtA4sZadQo6PewZ9N5nuAfPh5uoeF9DiOeZUpqSEZGUclkWrTXnXCllrfXef/s/cByN6F1ipRRjDDpCCDlY17XW+h6Sc76uC2bfNuccAiowWGXzBxQNcFJr7V3DCP5B4inGiAyDHEJA5Q+XkefP5rfyDAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"fiber04.png\"\n        title=\"fiber04.png\"\n        src=\"/ho_blog/static/f7dc85e94c54deaebdbe6e0fc381b0a2/fcda8/fiber04.png\"\n        srcset=\"/ho_blog/static/f7dc85e94c54deaebdbe6e0fc381b0a2/12f09/fiber04.png 148w,\n/ho_blog/static/f7dc85e94c54deaebdbe6e0fc381b0a2/e4a3f/fiber04.png 295w,\n/ho_blog/static/f7dc85e94c54deaebdbe6e0fc381b0a2/fcda8/fiber04.png 590w,\n/ho_blog/static/f7dc85e94c54deaebdbe6e0fc381b0a2/8c557/fiber04.png 700w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">const</span> <span class=\"token constant\">ENOUGH_TIME</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span> <span class=\"token comment\">// milliseconds</span>\n\n<span class=\"token comment\">// render 또는 scheduleUpdate 에서</span>\n<span class=\"token comment\">// requestIdleCallback(performWork) 로 호출함.</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">performWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">deadline</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// cpu 시간이 괜찮을때까지 loop 돌면서 작업 수행</span>\n  <span class=\"token function\">workLoop</span><span class=\"token punctuation\">(</span>deadline<span class=\"token punctuation\">)</span>\n  \n  <span class=\"token comment\">// cpu에 시간이 안괜찮아서 workLoop 탈출</span>\n  <span class=\"token comment\">// 남은 작업이 있으면 performWork를 다시 호출함</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>nextUnitOfWork <span class=\"token operator\">||</span> updateQueue<span class=\"token punctuation\">.</span>length <span class=\"token operator\">></span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">requestIdleCallback</span><span class=\"token punctuation\">(</span>performWork<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// nextUnitOfWork은 처음에 null로 셋팅되어 있음.</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">workLoop</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">deadline</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>nextUnitOfWork<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// 여기서 처음에 nextUnitOfWork 을 셋팅함.</span>\n    <span class=\"token function\">resetNextUnitOfWork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>nextUnitOfWork <span class=\"token operator\">&amp;&amp;</span> deadline<span class=\"token punctuation\">.</span><span class=\"token function\">timeRemaining</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token constant\">ENOUGH_TIME</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span>nextUnitOfWork<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>pendingCommit<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">commitAllWork</span><span class=\"token punctuation\">(</span>pendingCommit<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>여기 우리가 앞서 보았던 <code class=\"language-text\">performUnitOfWork()</code> 패턴을 사용합니다.</p>\n<p><code class=\"language-text\">requestIdleCallback()</code>은 deadline 파라미터를 함께 가진 타겟 함수를 호출합니다. <code class=\"language-text\">performWork()</code> deadline 을 받아서 <code class=\"language-text\">workLoop()</code> 로 전달해줍니다. <code class=\"language-text\">workLoop()</code> returns 후에, <code class=\"language-text\">performWork()</code> 작업 준비가 되었는지 체크를 합니다. 만약 준비가 됬다면, 자기 자신을 새로운 지연 호출로 스케줄링 시킵니다.</p>\n<p><code class=\"language-text\">workLoop()</code> 은 시간을 주시하는 함수입니다. 만약 deadline 이 너무 가깝다면(마감시간), 루프 작업은 멈추고 다음 업데이트 해야할 작업을 남겨둡니다. 그래서 다시 다음 타임에 재개 될 수 있도록 합니다.</p>\n<blockquote>\n<p><code class=\"language-text\">deadline.timeRemaining()</code>이 다른 작업 단위를 실행하기에 충분한지 아닌지 확인하기 위해 <code class=\"language-text\">ENOUGH_TIME</code> (1ms 상수, React 와 동일)을 사용합니다. <code class=\"language-text\">performUnitOfWork()</code>가 그 이상을 수행하면 마감 시간이 초과 될것입니다. deadline 은 브라우저의 제안 일 뿐이므로 몇 밀리 초 동안 초과실행 하는것은 그렇게 나쁘지 않습니다.</p>\n</blockquote>\n<p><code class=\"language-text\">performUnitOfWork()</code>는 업데이트를위한 work-in-progress 트리를 만들고 DOM 에 적용해야 할 변경 사항을 남겨둡니다. <strong>이것은 한 번에 한 fiber 씩 점진적으로 이루어질 것입니다.</strong></p>\n<p><code class=\"language-text\">performUnitOfWork()</code>가 현재 업데이트에 대한 모든 작업을 완료하면 null 을 반환하고 보류중인 DOM 변경 사항을 <code class=\"language-text\">pendingCommit</code>에 남겨 둡니다. 마침내 <code class=\"language-text\">commitAllWork()</code>는 <code class=\"language-text\">pendingCommit</code> 에서 <code class=\"language-text\">effects</code>를 받아 DOM 을 변경합니다.</p>\n<p><code class=\"language-text\">commitAllWork()</code>는 루프 외부에서 호출됩니다. <code class=\"language-text\">performUnitOfWork()</code>에서 수행 된 작업은 DOM 을 변경하지 않으므로 분할하는 것이 좋습니다. 반면에, <code class=\"language-text\">commitAllWork()</code>는 DOM 을 돌연변이시킬 것이고 일관성없는 UI 를 피하기 위해 한번에 모두 완료되어야합니다.</p>\n<p>우리는 여전히 어디서 <code class=\"language-text\">nextUnitOfWork</code>를 처음으로 불러오는지 보지 못했습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/ho_blog/static/0e1c8186d35e3df92e401236f52f1908/8c557/fiber05.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.62162162162162%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAbUlEQVQI142OCwrAIAxDvf8tBUUmguDq37oFe4AtUAhpHq16fquUUmtda+29JVGYnDMRpZTuoxACHfXe0QMAw8xSgwEvicLaGKO19t4750Baa68jtMcYMUYwAOQyH2E151Sf37bW5A5IeAnl/xdhZulTyLyzoAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"fiber05.png\"\n        title=\"fiber05.png\"\n        src=\"/ho_blog/static/0e1c8186d35e3df92e401236f52f1908/fcda8/fiber05.png\"\n        srcset=\"/ho_blog/static/0e1c8186d35e3df92e401236f52f1908/12f09/fiber05.png 148w,\n/ho_blog/static/0e1c8186d35e3df92e401236f52f1908/e4a3f/fiber05.png 295w,\n/ho_blog/static/0e1c8186d35e3df92e401236f52f1908/fcda8/fiber05.png 590w,\n/ho_blog/static/0e1c8186d35e3df92e401236f52f1908/8c557/fiber05.png 700w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>업데이트를 받아서 첫 번째 <code class=\"language-text\">nextUnitOfWork</code>로 변환하는 <code class=\"language-text\">resetNextUnitOfWork()</code> 함수 입니다.\n<code class=\"language-text\">resetNextUnitOfWork()</code> 함수는 첫 root fiber 를 만드는 함수라고 생각하면 된다. <code class=\"language-text\">render()</code> 함수 또는 <code class=\"language-text\">scheduleUpdate()</code>함수에서 <code class=\"language-text\">performWork() 함수</code>를 시작할때 <code class=\"language-text\">nextUnitOfWork</code> 가 없다면 root fiber 를 만들어서 <code class=\"language-text\">performUnitOfWork(nextUnitOfWork)</code> 를 수행한다.</p>\n<p><code class=\"language-text\">nextUnitOfWork</code> 이거는 곧 fiber 라고 생각하면 되겠다. 여기서 <code class=\"language-text\">performUnitOfWork</code> 의 매개 변수 명이 <code class=\"language-text\">wipFiber</code> 이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// render 할때나 scheduleUpdate 호출될때 updateQueue에 update를 넣게 되는데</span>\n<span class=\"token comment\">// 이때 처음으로 updateQueue에 있는 update 를 꺼내오는 함수.</span>\n<span class=\"token comment\">// update 를 꺼내와서 nextUnitOfWork 의 fiber를 만들어줌.</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">resetNextUnitOfWork</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> update <span class=\"token operator\">=</span> updateQueue<span class=\"token punctuation\">.</span><span class=\"token function\">shift</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// render</span>\n  <span class=\"token comment\">// {</span>\n  <span class=\"token comment\">//   from: HOST_ROOT,</span>\n  <span class=\"token comment\">//   dom: containerDom,</span>\n  <span class=\"token comment\">//   newProps: { children: elements },</span>\n  <span class=\"token comment\">// }</span>\n\n  <span class=\"token comment\">// scheduleUpdate</span>\n  <span class=\"token comment\">// {</span>\n  <span class=\"token comment\">//   from: CLASS_COMPONENT,</span>\n  <span class=\"token comment\">//   instance: instance,</span>\n  <span class=\"token comment\">//   partialState: partialState,</span>\n  <span class=\"token comment\">// }</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>update<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// Copy the setState parameter from the update payload to the corresponding fiber</span>\n  <span class=\"token comment\">// 여기서 instance는 component의 public instance를 가리킴.</span>\n  <span class=\"token comment\">// partialState 이것은 update할 새로운 값 (setState로 넘어오는 인자)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>update<span class=\"token punctuation\">.</span>partialState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    update<span class=\"token punctuation\">.</span>instance<span class=\"token punctuation\">.</span>__fiber<span class=\"token punctuation\">.</span>partialState <span class=\"token operator\">=</span> update<span class=\"token punctuation\">.</span>partialState\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// 그런 다음 old fiber tree의 root를 찾습니다.</span>\n  <span class=\"token comment\">// _rootContainerFiber 이것은 한번 그려졌던 dom 이라면 이전 fiber이다.</span>\n  <span class=\"token keyword\">const</span> root <span class=\"token operator\">=</span>\n    update<span class=\"token punctuation\">.</span>from <span class=\"token operator\">==</span> <span class=\"token constant\">HOST_ROOT</span>\n      <span class=\"token operator\">?</span> update<span class=\"token punctuation\">.</span>dom<span class=\"token punctuation\">.</span>_rootContainerFiber\n      <span class=\"token operator\">:</span> <span class=\"token function\">getRoot</span><span class=\"token punctuation\">(</span>update<span class=\"token punctuation\">.</span>instance<span class=\"token punctuation\">.</span>__fiber<span class=\"token punctuation\">)</span>\n\n  <span class=\"token comment\">// 새로운 fiber</span>\n  <span class=\"token comment\">// 새로운 work-in-progress tree의 root</span>\n  <span class=\"token comment\">// update에 dom값이 있으면 처음 render 함수 호출하는거</span>\n  <span class=\"token comment\">// update에 newProps 값이 있으면 처음 render 함수 호출하는거.</span>\n  nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n    tag<span class=\"token operator\">:</span> <span class=\"token constant\">HOST_ROOT</span><span class=\"token punctuation\">,</span>\n    stateNode<span class=\"token operator\">:</span> update<span class=\"token punctuation\">.</span>dom <span class=\"token operator\">||</span> root<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">,</span>\n    props<span class=\"token operator\">:</span> update<span class=\"token punctuation\">.</span>newProps <span class=\"token operator\">||</span> root<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">,</span>\n    alternate<span class=\"token operator\">:</span> root<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">getRoot</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> node <span class=\"token operator\">=</span> fiber\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    node <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>parent\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> node\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">resetNextUnitOfWork()</code>는 대기열에서 첫 번째 업데이트를 가져 와서 시작합니다.</p>\n<p>update 객체에 <code class=\"language-text\">partialState</code>가 있다면 컴포넌트 인스턴스에 속해있는 fiber 에 그것을 저장 시켜 놓습니다. 그래서 나중에 컴포넌트의 <code class=\"language-text\">render()</code>를 호출 할 때 사용할 수 있습니다.</p>\n<p>그런 다음 old fiber tree 의 root 를 찾습니다. 처음 호출되는 <code class=\"language-text\">render()</code>함수로 update 객체들이 넘어왔을 경우에는 루트 fiber 가 없으므로 <code class=\"language-text\">root</code>가 <code class=\"language-text\">null</code>이 됩니다. <code class=\"language-text\">render()</code>에 대한 후속 호출에서 오는 경우 DOM 노드의 <code class=\"language-text\">_rootContainerFiber</code> 속성에서 루트를 찾을 수 있습니다. 그리고 업데이트가 <code class=\"language-text\">setState()</code>에서 오는 경우에는, 부모가없는 fiber 가 발견 될 때까지 인스턴스 fiber 에서 위로 이동해야합니다.</p>\n<p>그런 다음 <code class=\"language-text\">nextUnitOfWork</code>에 새 fiber 를 할당합니다. <strong>이 fiber 는 새로운 work-in-progress tree 의 root 입니다.</strong></p>\n<p>만약 old root 가 없다면(이미 그려진 DOM 이 없다면), <code class=\"language-text\">stateNode</code>(component instance)는 <code class=\"language-text\">render()</code> 호출할때 매개 변수로 받은 DOM 노드(containerDom)입니다. <code class=\"language-text\">props</code> 는 update 객체의 <code class=\"language-text\">newProps</code>가 됩니다 : 여기서 <code class=\"language-text\">newProps</code>는 element(render() 함수의 element 매개변수 값)들을 가지고있는 children 프로퍼티를 가진 객체이다(위 <code class=\"language-text\">render</code> 함수 참고 : newProps: { children: elements }). <code class=\"language-text\">alternate</code>은 null 이 될 것입니다. 왜냐하면 처음으로 호출되는 <code class=\"language-text\">render</code> 이기 때문에 이전에 그렸던 루트 fiber 가 없다.</p>\n<p>만약 old root 가 있다면 <code class=\"language-text\">stateNode</code>는 이전 루트의 DOM 노드가됩니다. <code class=\"language-text\">props</code>는 다시 <code class=\"language-text\">newProps</code> 가 null 이 아니면 <code class=\"language-text\">newProps</code>로 할당되고 그렇지 않으면 이전 루트에서 <code class=\"language-text\">props</code> 복사합니다. <code class=\"language-text\">alternate</code>는 이전 루트 fiber 가 됩니다.</p>\n<p>이제 우리는 work-in-progress tree 의 root 을 가지고 나머지 부분을 만들기 시작합시다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/ho_blog/static/a3d4baef4ba4a6182d4a51b4d1a88e17/8c557/fiber06.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.62162162162162%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAbUlEQVQI142PSwrAIAxEvf8lXUkRQfAT4r8dEui2fYswTGaImvs3zNxaW2udc9QxULXWnDMRpZRUhBBgllKQnnOOMdDR2BJ673tvg5219hKcc5gxRhXee/RZQDoKaKKGAyiaz9eSoJch3i/AeQAd/uiNdYwOrwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"fiber06.png\"\n        title=\"fiber06.png\"\n        src=\"/ho_blog/static/a3d4baef4ba4a6182d4a51b4d1a88e17/fcda8/fiber06.png\"\n        srcset=\"/ho_blog/static/a3d4baef4ba4a6182d4a51b4d1a88e17/12f09/fiber06.png 148w,\n/ho_blog/static/a3d4baef4ba4a6182d4a51b4d1a88e17/e4a3f/fiber06.png 295w,\n/ho_blog/static/a3d4baef4ba4a6182d4a51b4d1a88e17/fcda8/fiber06.png 590w,\n/ho_blog/static/a3d4baef4ba4a6182d4a51b4d1a88e17/8c557/fiber06.png 700w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// wipFiber 는 처음에 아래와 같은 객체입니다.</span>\n<span class=\"token comment\">// {</span>\n<span class=\"token comment\">//   tag: HOST_ROOT,</span>\n<span class=\"token comment\">//   stateNode: update.dom || root.stateNode,</span>\n<span class=\"token comment\">//   props: update.newProps || root.props,</span>\n<span class=\"token comment\">//   alternate: root,</span>\n<span class=\"token comment\">// }</span>\n\n<span class=\"token comment\">// beginWork는 전위 탐색으로 탐색되고</span>\n<span class=\"token comment\">// completeWork는 후위 탐색으로 탐색된다.</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">performUnitOfWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">wipFiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">beginWork</span><span class=\"token punctuation\">(</span>wipFiber<span class=\"token punctuation\">)</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>wipFiber<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span> wipFiber<span class=\"token punctuation\">.</span>child\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token comment\">// No child, we call completeWork until we find a sibling</span>\n  <span class=\"token keyword\">let</span> uow <span class=\"token operator\">=</span> wipFiber\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>uow<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">completeWork</span><span class=\"token punctuation\">(</span>uow<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>uow<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token comment\">// Sibling needs to beginWork</span>\n      <span class=\"token keyword\">return</span> uow<span class=\"token punctuation\">.</span>sibling\n    <span class=\"token punctuation\">}</span>\n    uow <span class=\"token operator\">=</span> uow<span class=\"token punctuation\">.</span>parent\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">performUnitOfWork()</code>는 진행중인 작업 트리를 탐색합니다.</p>\n<p><code class=\"language-text\">beginWork()</code>를 호출한다. --이것은 새로운 fiber 의 children 을 만들기 위한 작업이다.-- 그리고 나서 첫번째 child 을 리턴한다. 그리고나서 그것을 <code class=\"language-text\">nextUnitOfWork</code> 에 대입한다.</p>\n<p>만약 어떤 child 도 없다면, <code class=\"language-text\">completeWork()</code>를 호출하고 <code class=\"language-text\">nextUnitOfWork</code>가 될 <code class=\"language-text\">sibling</code>을 리턴한다.</p>\n<p>만약 <code class=\"language-text\">sibling</code>가 없다면, parents 로 올라가서 해당 parents 를 인자로 <code class=\"language-text\">completeWork()</code>를 호출한다. 이 작업은 <code class=\"language-text\">sibling</code>을 찾을때 또는 root 에 도달했을 때까지 반복한다.</p>\n<p><code class=\"language-text\">performUnitOfWork()</code>를 여러 번 호출하면 자식(children)이 없는 파이버를 찾을 때까지 각 파이버의 첫번째 자식의 자식들을 생성하면서 계속해서 트리의 하위로 내려갑니다. 그리고 오른쪽으로 옮겨서 siblings 에도 같은 작업을 수행합니다. 그리고 다시 위로 올라와서 같은 작업을 수행합니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/ho_blog/static/9d3230e3cd7ea42baa9b3c4c2aca16a9/844cc/fiber-search.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 52.70270270270271%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAALCAYAAAB/Ca1DAAAACXBIWXMAAAsSAAALEgHS3X78AAABTUlEQVQoz5VSi3KEIAz0//+yU+spIqKiPHWbxHrTzvWu04wrEGDZDVT7vuMljgMlJsTVw4eAQHi1vvqTkHDsB9zioLUWlL1Q7r+EJZ9kpDDEIOBxIoXbNN/nSil/EB7nwugCzGCgegXnnKjkPH1YnccwDKI2xij53wmJLIckdnLZMc8zLJGyXQ6eS2uguQw7jjBK32t6Ka2uwl8Wos/oVY+ua0+b6cCgDXpSOo4W72816o9a+maYUde1gF1wCCHfIp/AYAusbFkWrMssuW3bZMztNE2w1mJdV1HHfcZlveKfJxtMMtMm7z2uiJSf7CSn8+bvcdbz+DEWy6LAfxWZrPLmnEltykgEY4zkuU0pPdzqw7PRvb7b0O35zlht11DNiGS0IwZl0LUd1W0U6xxPCdu2BYMJmbhpGrqAHpoU3243KKWEhNfwHK/heKb0ExetWYEYWbekAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"fiber-search.png\"\n        title=\"fiber-search.png\"\n        src=\"/ho_blog/static/9d3230e3cd7ea42baa9b3c4c2aca16a9/fcda8/fiber-search.png\"\n        srcset=\"/ho_blog/static/9d3230e3cd7ea42baa9b3c4c2aca16a9/12f09/fiber-search.png 148w,\n/ho_blog/static/9d3230e3cd7ea42baa9b3c4c2aca16a9/e4a3f/fiber-search.png 295w,\n/ho_blog/static/9d3230e3cd7ea42baa9b3c4c2aca16a9/fcda8/fiber-search.png 590w,\n/ho_blog/static/9d3230e3cd7ea42baa9b3c4c2aca16a9/efc66/fiber-search.png 885w,\n/ho_blog/static/9d3230e3cd7ea42baa9b3c4c2aca16a9/c83ae/fiber-search.png 1180w,\n/ho_blog/static/9d3230e3cd7ea42baa9b3c4c2aca16a9/844cc/fiber-search.png 1306w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>위 처럼 트리구조가 있을때 순서는 다음과 같습니다.\n파란색 순서는 <code class=\"language-text\">beginWork()</code> 가 호출되는 순서이고 빨간색 순서는 <code class=\"language-text\">completeWork()</code> 가 호출되는 순서입니다.\n<code class=\"language-text\">beginWork</code> 는 전위 탐색으로 탐색되고 <code class=\"language-text\">completeWork</code> 는 후위 탐색으로 호출 됩니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/ho_blog/static/d71ef97e3317e6cc9c4d8ee5a383b830/8c557/fiber07.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.62162162162162%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAlElEQVQI122Oyw6EIAxF/f9/NIagGQMmgggUfMyckc0spovm5rY9t91938dxnOdZSkFc1/X+V/g5ZxGpte77jsDscKdpGsdRaz3Ps7WWJSj1qV/cuq4pJQSdsO8xyUqpvu9BcG+MQQ/DAA7He8/etm2vpzgjFn9ZFtAdADYYt0HrzrkYY3uvSJacnfckAwohtBeKyAfr9OT+nGcDnwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"fiber07.png\"\n        title=\"fiber07.png\"\n        src=\"/ho_blog/static/d71ef97e3317e6cc9c4d8ee5a383b830/fcda8/fiber07.png\"\n        srcset=\"/ho_blog/static/d71ef97e3317e6cc9c4d8ee5a383b830/12f09/fiber07.png 148w,\n/ho_blog/static/d71ef97e3317e6cc9c4d8ee5a383b830/e4a3f/fiber07.png 295w,\n/ho_blog/static/d71ef97e3317e6cc9c4d8ee5a383b830/fcda8/fiber07.png 590w,\n/ho_blog/static/d71ef97e3317e6cc9c4d8ee5a383b830/8c557/fiber07.png 700w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// wipFiber 는 처음에 아래와 같은 객체입니다.</span>\n<span class=\"token comment\">// {</span>\n<span class=\"token comment\">//   tag: HOST_ROOT,</span>\n<span class=\"token comment\">//   stateNode: update.dom || root.stateNode,</span>\n<span class=\"token comment\">//   props: update.newProps || root.props,</span>\n<span class=\"token comment\">//   alternate: root,</span>\n<span class=\"token comment\">// }</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">beginWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">wipFiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>wipFiber<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">==</span> <span class=\"token constant\">CLASS_COMPONENT</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">updateClassComponent</span><span class=\"token punctuation\">(</span>wipFiber<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">updateHostComponent</span><span class=\"token punctuation\">(</span>wipFiber<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">updateHostComponent</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">wipFiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>wipFiber<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    wipFiber<span class=\"token punctuation\">.</span>stateNode <span class=\"token operator\">=</span> <span class=\"token function\">createDomElement</span><span class=\"token punctuation\">(</span>wipFiber<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> newChildElements <span class=\"token operator\">=</span> wipFiber<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">.</span>children\n  <span class=\"token function\">reconcileChildrenArray</span><span class=\"token punctuation\">(</span>wipFiber<span class=\"token punctuation\">,</span> newChildElements<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">updateClassComponent</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">wipFiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> instance <span class=\"token operator\">=</span> wipFiber<span class=\"token punctuation\">.</span>stateNode\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>instance <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Call class constructor</span>\n    instance <span class=\"token operator\">=</span> wipFiber<span class=\"token punctuation\">.</span>stateNode <span class=\"token operator\">=</span> <span class=\"token function\">createInstance</span><span class=\"token punctuation\">(</span>wipFiber<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>wipFiber<span class=\"token punctuation\">.</span>props <span class=\"token operator\">==</span> instance<span class=\"token punctuation\">.</span>props <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>wipFiber<span class=\"token punctuation\">.</span>partialState<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// No need to render, clone children from last time</span>\n    <span class=\"token function\">cloneChildFibers</span><span class=\"token punctuation\">(</span>wipFiber<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">}</span>\n\n  instance<span class=\"token punctuation\">.</span>props <span class=\"token operator\">=</span> wipFiber<span class=\"token punctuation\">.</span>props\n  instance<span class=\"token punctuation\">.</span>state <span class=\"token operator\">=</span> Object<span class=\"token punctuation\">.</span><span class=\"token function\">assign</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> instance<span class=\"token punctuation\">.</span>state<span class=\"token punctuation\">,</span> wipFiber<span class=\"token punctuation\">.</span>partialState<span class=\"token punctuation\">)</span>\n  wipFiber<span class=\"token punctuation\">.</span>partialState <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n\n  <span class=\"token keyword\">const</span> newChildElements <span class=\"token operator\">=</span> wipFiber<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n  <span class=\"token function\">reconcileChildrenArray</span><span class=\"token punctuation\">(</span>wipFiber<span class=\"token punctuation\">,</span> newChildElements<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">beginWork()</code>는 두가지를 합니다:</p>\n<ul>\n<li><code class=\"language-text\">stateNode</code>를 가지고 있지 않다면 생성해줍니다.</li>\n<li>component children (fiber.props.children) 을 가져와 <code class=\"language-text\">reconcileChildrenArray()</code>에 그것들을 넘겨준다.</li>\n</ul>\n<p>두가지 타입의 component 를 우리가 다루기 때문에 우리는 2 가지로 나눠야 한다. <code class=\"language-text\">updateHostComponent()</code> 와 <code class=\"language-text\">updateClassComponent()</code> 이다.</p>\n<p><code class=\"language-text\">updateHostComponent()</code>는 host component 들과 root component 를 다룬다. 그것은 필요하다면 새로운 DOM 을 만들어내고 <strong>fiber props 에서 나온 child element 들을 이용해서 <code class=\"language-text\">reconcileChildrenArray()</code>를 호출한다.</strong></p>\n<p><code class=\"language-text\">updateClassComponent()</code>는 class component instance 들을 다룬다. 그것은 필요하다면 component 의 생성자를 호출해서 instance 를 만들어낸다. <strong>instance 의 props 와 state 를 업데이트를 하고 <code class=\"language-text\">render()</code>를 호출해서 새로운 children 을 얻는다.</strong></p>\n<p><code class=\"language-text\">updateClassComponent()</code> 또한 <code class=\"language-text\">render()</code>를 호출하는것이 맞는지 확인합니다. 이것은 <code class=\"language-text\">shouldComponentUpdate()</code>의 간단한 버전이다. 만약 re-render 할 필요가 없어 보인다면, 어떠한 reconciliation 없이 현재 sub-tree 를 work-in-progress 트리로 복사합니다.</p>\n<p>이제 <code class=\"language-text\">newChildElements</code>를 가지고있고, work-in-grogress fiber 를 위한 child fiber 들을 만들 준비가 되었습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/ho_blog/static/f3e48d0a3449fc30707b57a88b80fe12/8c557/fiber08.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.62162162162162%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAcklEQVQI142O2Q5DIQhE/f9vrXEBFAVt52r62vQkknFYw/s/9t7MbGbQrTVVhQhwc84ppXyIMZZSXodr3lIi6r27+5xTRGBCP816QE6/QCP9RBG8OQYx44vN6MQgRDcLP29dS8kkLR86xt1ca8VpGLzdP1qG6VNDcdjaAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"fiber08.png\"\n        title=\"fiber08.png\"\n        src=\"/ho_blog/static/f3e48d0a3449fc30707b57a88b80fe12/fcda8/fiber08.png\"\n        srcset=\"/ho_blog/static/f3e48d0a3449fc30707b57a88b80fe12/12f09/fiber08.png 148w,\n/ho_blog/static/f3e48d0a3449fc30707b57a88b80fe12/e4a3f/fiber08.png 295w,\n/ho_blog/static/f3e48d0a3449fc30707b57a88b80fe12/fcda8/fiber08.png 590w,\n/ho_blog/static/f3e48d0a3449fc30707b57a88b80fe12/8c557/fiber08.png 700w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>이것이 이 library 의 심장입니다. work-in-progress 트리가 커지며 커밋 단계에서 DOM 에 대해 어떤 변경 작업을 수행할지 결정합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token comment\">// Effect tags</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">PLACEMENT</span> <span class=\"token operator\">=</span> <span class=\"token number\">1</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">DELETION</span> <span class=\"token operator\">=</span> <span class=\"token number\">2</span>\n<span class=\"token keyword\">const</span> <span class=\"token constant\">UPDATE</span> <span class=\"token operator\">=</span> <span class=\"token number\">3</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">arrify</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">val</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> val <span class=\"token operator\">==</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">:</span> Array<span class=\"token punctuation\">.</span><span class=\"token function\">isArray</span><span class=\"token punctuation\">(</span>val<span class=\"token punctuation\">)</span> <span class=\"token operator\">?</span> val <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span>val<span class=\"token punctuation\">]</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">reconcileChildrenArray</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">wipFiber<span class=\"token punctuation\">,</span> newChildElements</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> elements <span class=\"token operator\">=</span> <span class=\"token function\">arrify</span><span class=\"token punctuation\">(</span>newChildElements<span class=\"token punctuation\">)</span>\n\n  <span class=\"token keyword\">let</span> index <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n  <span class=\"token keyword\">let</span> oldFiber <span class=\"token operator\">=</span> wipFiber<span class=\"token punctuation\">.</span>alternate <span class=\"token operator\">?</span> wipFiber<span class=\"token punctuation\">.</span>alternate<span class=\"token punctuation\">.</span>child <span class=\"token operator\">:</span> <span class=\"token keyword\">null</span>\n  <span class=\"token keyword\">let</span> newFiber <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n  <span class=\"token comment\">// 새롭게 들어온 element 또는 oldFiber가 없을때까지 반복</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>index <span class=\"token operator\">&lt;</span> elements<span class=\"token punctuation\">.</span>length <span class=\"token operator\">||</span> oldFiber <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> prevFiber <span class=\"token operator\">=</span> newFiber\n    <span class=\"token keyword\">const</span> element <span class=\"token operator\">=</span> index <span class=\"token operator\">&lt;</span> elements<span class=\"token punctuation\">.</span>length <span class=\"token operator\">&amp;&amp;</span> elements<span class=\"token punctuation\">[</span>index<span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">const</span> sameType <span class=\"token operator\">=</span> oldFiber <span class=\"token operator\">&amp;&amp;</span> element <span class=\"token operator\">&amp;&amp;</span> element<span class=\"token punctuation\">.</span>type <span class=\"token operator\">==</span> oldFiber<span class=\"token punctuation\">.</span>type\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>sameType<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      newFiber <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        type<span class=\"token operator\">:</span> oldFiber<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">,</span>\n        tag<span class=\"token operator\">:</span> oldFiber<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">,</span>\n        stateNode<span class=\"token operator\">:</span> oldFiber<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">,</span>\n        props<span class=\"token operator\">:</span> element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">,</span>\n        parent<span class=\"token operator\">:</span> wipFiber<span class=\"token punctuation\">,</span>\n        alternate<span class=\"token operator\">:</span> oldFiber<span class=\"token punctuation\">,</span>\n        partialState<span class=\"token operator\">:</span> oldFiber<span class=\"token punctuation\">.</span>partialState<span class=\"token punctuation\">,</span>\n        effectTag<span class=\"token operator\">:</span> <span class=\"token constant\">UPDATE</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>element <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>sameType<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      newFiber <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        type<span class=\"token operator\">:</span> element<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">,</span>\n        tag<span class=\"token operator\">:</span>\n          <span class=\"token keyword\">typeof</span> element<span class=\"token punctuation\">.</span>type <span class=\"token operator\">===</span> <span class=\"token string\">'string'</span> <span class=\"token operator\">?</span> <span class=\"token constant\">HOST_COMPONENT</span> <span class=\"token operator\">:</span> <span class=\"token constant\">CLASS_COMPONENT</span><span class=\"token punctuation\">,</span>\n        props<span class=\"token operator\">:</span> element<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">,</span>\n        parent<span class=\"token operator\">:</span> wipFiber<span class=\"token punctuation\">,</span>\n        effectTag<span class=\"token operator\">:</span> <span class=\"token constant\">PLACEMENT</span><span class=\"token punctuation\">,</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldFiber <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>sameType<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      oldFiber<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">=</span> <span class=\"token constant\">DELETION</span>\n      wipFiber<span class=\"token punctuation\">.</span>effects <span class=\"token operator\">=</span> wipFiber<span class=\"token punctuation\">.</span>effects <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n      wipFiber<span class=\"token punctuation\">.</span>effects<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>oldFiber<span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>oldFiber<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      oldFiber <span class=\"token operator\">=</span> oldFiber<span class=\"token punctuation\">.</span>sibling\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">// Fiber 연결</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>index <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      wipFiber<span class=\"token punctuation\">.</span>child <span class=\"token operator\">=</span> newFiber\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>prevFiber <span class=\"token operator\">&amp;&amp;</span> element<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      prevFiber<span class=\"token punctuation\">.</span>sibling <span class=\"token operator\">=</span> newFiber\n    <span class=\"token punctuation\">}</span>\n\n    index<span class=\"token operator\">++</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>시작하기 전에 <code class=\"language-text\">newChildElements</code>가 배열인지 확인하십시오. (이전의 reconciliation 알고리즘과 달리 <code class=\"language-text\">reconcileChildrenArray</code>는 항상 자식 배열과 함께 작동합니다. 즉, 이제 component 의 <code class=\"language-text\">render()</code> 함수에서 배열을 반환 할 수 있습니다.)</p>\n<p>그 후에 old fiber tree 의 children 들을 새로운 element 와 비교하기 시작합니다. (fiber 와 element 를 비교하는 것이다.) old fiber tree 의 children 들은 <code class=\"language-text\">wipFiber.alternate</code> 의 children 이다. 새로운 element 들은 <code class=\"language-text\">wipFiber.props.children</code> 에서 얻어 오거나 또는 <code class=\"language-text\">wipFiber.stateNode.render()</code> 호출해서 얻어온 것입니다.</p>\n<p>reconciliation 알고리즘은 첫번째 old fiber(<code class=\"language-text\">wipFiber.alternate.child</code>)와 첫번째 child element(<code class=\"language-text\">element[0]</code>) 를 일치 시키고, 두번째 old fiber(<code class=\"language-text\">wipFiber.alternate.child.sibling</code>) 두번째 child element(<code class=\"language-text\">element[1]</code>)도 반복합니다. 각각 oldFiber-element 쌍을 이루게 합니다.</p>\n<ul>\n<li>만약 oldFiber 와 element 가 타입이 같다면, 이것은 좋은 소식입니다, 이것은 기존의 stateNode 를 유지할수 있다는 뜻이다. 우리는 new fiber 를 예전거 기반에서 생성합니다. <code class=\"language-text\">UPDATE</code>를 <code class=\"language-text\">effectTag</code>에 추가시킨다. 그리고 새로운 fiber 를 work-in-progress tree 에 덧붙입니다.</li>\n<li>만약 element 의 type 이 oldFiber 와 다르거나 oldFiber 가 없다면(왜냐하면 기존 자식들보다 새로운 자식들을 많이 가지고 있는 경우), 우리가 가지고 있는 element 정보를 가지고 새로운 fiber 를 생성합니다. 이 새로운 fiber 는 <code class=\"language-text\">alternate</code> 와 <code class=\"language-text\">stateNode</code>를 가지고 있지 않는다. (<code class=\"language-text\">stateNode</code>는 <code class=\"language-text\">beginWork()</code>에서 생성됩니다.) 이 fiber 의 <code class=\"language-text\">effectTag</code> 는 <code class=\"language-text\">PLACEMENT</code> 입니다.</li>\n<li>만약 oldFiber 와 element 가 다른 type 이거나 이 oldFiber 를 위한 어떠한 element 도 없는 경우(왜냐하면 기존 자식들이 새로운 자식들 보다 많이 가지고 있기 때문) oldFiber 는 DELETION 태그를 붙입니다. 이 fiber 는 작업 중(work-in-progress) 트리의 일부가 아니기 때문에, 그것을 추적할 수 없게끔 wipFiber.effets 목록에 추가해야 합니다.</li>\n</ul>\n<blockquote>\n<p>리액트와는 달리 재조정을 위해 keys 를 사용하지 않으므로, 이전 위치에서 벗어난 자식이 있는지 알 수 없습니다.</p>\n</blockquote>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/ho_blog/static/ac8503ac4e5f378f55ab8d7bfe6dfbd8/8c557/fiber09.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.62162162162162%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAfklEQVQI142O2woDIQxE/f/vlAq6FhZvWRNtT7fvpQMJk2RmiHv9h713rVVV4b13EYE4qrXG4bxRSsk501Gw3zeQIhhjrLXmnHBOZuaYj+Pw3ocQYowpJcgDhMDedOq8LhFy8WAgiFyCTNX9/HXZOGd9LpVSPq99zTjVbJu9ASun6Jpvt5FhAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"fiber09.png\"\n        title=\"fiber09.png\"\n        src=\"/ho_blog/static/ac8503ac4e5f378f55ab8d7bfe6dfbd8/fcda8/fiber09.png\"\n        srcset=\"/ho_blog/static/ac8503ac4e5f378f55ab8d7bfe6dfbd8/12f09/fiber09.png 148w,\n/ho_blog/static/ac8503ac4e5f378f55ab8d7bfe6dfbd8/e4a3f/fiber09.png 295w,\n/ho_blog/static/ac8503ac4e5f378f55ab8d7bfe6dfbd8/fcda8/fiber09.png 590w,\n/ho_blog/static/ac8503ac4e5f378f55ab8d7bfe6dfbd8/8c557/fiber09.png 700w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><code class=\"language-text\">updateClassComponent()</code> 는 재조정을 하는 대신 지름길로 old fiber 하위 트리를 work-in-progress 트리로 복제하는 특별한 경우가 있습니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">cloneChildFibers</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">parentFiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> oldFiber <span class=\"token operator\">=</span> parentFiber<span class=\"token punctuation\">.</span>alternate\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>oldFiber<span class=\"token punctuation\">.</span>child<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">let</span> oldChild <span class=\"token operator\">=</span> oldFiber<span class=\"token punctuation\">.</span>child\n  <span class=\"token keyword\">let</span> prevChild <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>oldChild<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> newChild <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n      type<span class=\"token operator\">:</span> oldChild<span class=\"token punctuation\">.</span>type<span class=\"token punctuation\">,</span>\n      tag<span class=\"token operator\">:</span> oldChild<span class=\"token punctuation\">.</span>tag<span class=\"token punctuation\">,</span>\n      stateNode<span class=\"token operator\">:</span> oldChild<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">,</span>\n      props<span class=\"token operator\">:</span> oldChild<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">,</span>\n      partialState<span class=\"token operator\">:</span> oldChild<span class=\"token punctuation\">.</span>partialState<span class=\"token punctuation\">,</span>\n      alternate<span class=\"token operator\">:</span> oldChild<span class=\"token punctuation\">,</span>\n      parent<span class=\"token operator\">:</span> parentFiber<span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>prevChild<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      prevChild<span class=\"token punctuation\">.</span>sibling <span class=\"token operator\">=</span> newChild\n    <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n      parentFiber<span class=\"token punctuation\">.</span>child <span class=\"token operator\">=</span> newChild\n    <span class=\"token punctuation\">}</span>\n    prevChild <span class=\"token operator\">=</span> newChild\n    oldChild <span class=\"token operator\">=</span> oldChild<span class=\"token punctuation\">.</span>sibling\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">cloneChildFibers()</code> 는 각 <code class=\"language-text\">wipFiber.alternate</code> 자식들(children)을 복제하고 work-in-progress 트리에 추가합니다. 아무것도 변경하지 않아도 되므로 어떠한 <code class=\"language-text\">effectTag</code> 도 추가할 필요가 없습니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/ho_blog/static/46742e113ecd9b82b1fbfb962b49a675/8c557/fiber10.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.62162162162162%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAeklEQVQI131OMQ7EIAzj/29kQwLEgg4IgQa4uiB1rIfIcmLH6v+JtVatlZlFBKSUIhtEhKlwATWllHPGLsaICWXOecyttd77GIM3XvExgznntNbee2utMSaEgAjs3s8wg/w2TiOIMob6KIx41EFDvIX/VANfzFeMk+gGTJ7pA4j0X2oAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"fiber10.png\"\n        title=\"fiber10.png\"\n        src=\"/ho_blog/static/46742e113ecd9b82b1fbfb962b49a675/fcda8/fiber10.png\"\n        srcset=\"/ho_blog/static/46742e113ecd9b82b1fbfb962b49a675/12f09/fiber10.png 148w,\n/ho_blog/static/46742e113ecd9b82b1fbfb962b49a675/e4a3f/fiber10.png 295w,\n/ho_blog/static/46742e113ecd9b82b1fbfb962b49a675/fcda8/fiber10.png 590w,\n/ho_blog/static/46742e113ecd9b82b1fbfb962b49a675/8c557/fiber10.png 700w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p><code class=\"language-text\">performUnitOfWork()</code> 에서 wipFiber 가 새로운 자식들(children)을 가지고 있지 않거나 이미 모든 자식들이 이미 작업을 완료 했을 때, <code class=\"language-text\">completeWork()</code>를 호출합니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">completeWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">==</span> <span class=\"token constant\">CLASS_COMPONENT</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    fiber<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">.</span>__fiber <span class=\"token operator\">=</span> fiber\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> childEffects <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>effects <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">const</span> thisEffect <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">!=</span> <span class=\"token keyword\">null</span> <span class=\"token operator\">?</span> <span class=\"token punctuation\">[</span>fiber<span class=\"token punctuation\">]</span> <span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    <span class=\"token keyword\">const</span> parentEffects <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">.</span>effects <span class=\"token operator\">||</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span>\n    fiber<span class=\"token punctuation\">.</span>parent<span class=\"token punctuation\">.</span>effects <span class=\"token operator\">=</span> parentEffects<span class=\"token punctuation\">.</span><span class=\"token function\">concat</span><span class=\"token punctuation\">(</span>childEffects<span class=\"token punctuation\">,</span> thisEffect<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token punctuation\">{</span>\n    pendingCommit <span class=\"token operator\">=</span> fiber\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">completeWork()</code>는 먼저 클래스 컴포넌트의 인스턴스와 관련된 fiber 에 대한 참조를 업데이트합니다. (솔직히 말해서, 여기 있을 필요는 없지만 어딘가에 있어야 합니다.)</p>\n<p>그런 다음 <code class=\"language-text\">effects</code> 목록을 작성합니다. 이 목록에는 effectTag 가 있는 work-in-progress 서브 트리의 모든 fiber 들이 포함됩니다. (DELETION effectTag 를 가진 이전 하위 트리의 파이버도 포함). 이 아이디어는 effectTag 가 있는 모든 fiber 를 root <code class=\"language-text\">effects</code> 목록에 누적하는 것입니다.</p>\n<p>자신 fiber 의 자식들 effect, 내 effect, 부모 fiber effect 를 한데 모아서 내 부모 fiber 의 effect 로 모아준다.</p>\n<p>마지막으로 fiber 에 부모(<code class=\"language-text\">parent</code>)가 없다면, work-in-progress 트리의 루트에 위치 해 있는것 입니다. 따라서 우리는 업데이트에 대한 모든 작업을 완료하고 모든 effects 를 수집했습니다. <code class=\"language-text\">workLoop()</code>이 <code class=\"language-text\">commitAllWork()</code>를 호출 할 수 있도록 <code class=\"language-text\">pendingCommit</code> 에 root 를 대입합니다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/ho_blog/static/648b738f5f4d8d0d37a11a67bf1bcd76/8c557/fiber11.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 21.62162162162162%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsSAAALEgHS3X78AAAAkklEQVQI122OSw6EMAxDuf8REQuKqESL6AKmX2iYN1TsxovIcWQ73f1CRO5/OM+zlFJr9d4fxwFhTSlBOjxa62EYlmWZ5xmulLLW7vveEtOD67qYwfsqQphzjrUjeF3XcRz7vp+miRSmMYZbaw4hxBjpaQQF/+Yc/b9mUonglnMuL9AxoGDgCieOFV1y/mwbn3wBKM3m+MI+f7YAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"fiber11.png\"\n        title=\"fiber11.png\"\n        src=\"/ho_blog/static/648b738f5f4d8d0d37a11a67bf1bcd76/fcda8/fiber11.png\"\n        srcset=\"/ho_blog/static/648b738f5f4d8d0d37a11a67bf1bcd76/12f09/fiber11.png 148w,\n/ho_blog/static/648b738f5f4d8d0d37a11a67bf1bcd76/e4a3f/fiber11.png 295w,\n/ho_blog/static/648b738f5f4d8d0d37a11a67bf1bcd76/fcda8/fiber11.png 590w,\n/ho_blog/static/648b738f5f4d8d0d37a11a67bf1bcd76/8c557/fiber11.png 700w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>이제 마지막으로 남은건 DOM 을 변경하는 것입니다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\"><span class=\"token keyword\">function</span> <span class=\"token function\">commitAllWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  fiber<span class=\"token punctuation\">.</span>effects<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">f</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span>f<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n  fiber<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">.</span>_rootContainerFiber <span class=\"token operator\">=</span> fiber\n  nextUnitOfWork <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n  pendingCommit <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">commitWork</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">==</span> <span class=\"token constant\">HOST_ROOT</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">return</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">let</span> domParentFiber <span class=\"token operator\">=</span> fiber<span class=\"token punctuation\">.</span>parent\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>domParentFiber<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">==</span> <span class=\"token constant\">CLASS_COMPONENT</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    domParentFiber <span class=\"token operator\">=</span> domParentFiber<span class=\"token punctuation\">.</span>parent\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">const</span> domParent <span class=\"token operator\">=</span> domParentFiber<span class=\"token punctuation\">.</span>stateNode\n\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">==</span> <span class=\"token constant\">PLACEMENT</span> <span class=\"token operator\">&amp;&amp;</span> fiber<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">==</span> <span class=\"token constant\">HOST_COMPONENT</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    domParent<span class=\"token punctuation\">.</span><span class=\"token function\">appendChild</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">==</span> <span class=\"token constant\">UPDATE</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">updateDomProperties</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">,</span> fiber<span class=\"token punctuation\">.</span>alternate<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">,</span> fiber<span class=\"token punctuation\">.</span>props<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">.</span>effectTag <span class=\"token operator\">==</span> <span class=\"token constant\">DELETION</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">commitDeletion</span><span class=\"token punctuation\">(</span>fiber<span class=\"token punctuation\">,</span> domParent<span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">commitDeletion</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fiber<span class=\"token punctuation\">,</span> domParent</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> node <span class=\"token operator\">=</span> fiber\n  <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span><span class=\"token boolean\">true</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>tag <span class=\"token operator\">==</span> <span class=\"token constant\">CLASS_COMPONENT</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      node <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>child\n      <span class=\"token keyword\">continue</span>\n    <span class=\"token punctuation\">}</span>\n    domParent<span class=\"token punctuation\">.</span><span class=\"token function\">removeChild</span><span class=\"token punctuation\">(</span>node<span class=\"token punctuation\">.</span>stateNode<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>node <span class=\"token operator\">!=</span> fiber <span class=\"token operator\">&amp;&amp;</span> <span class=\"token operator\">!</span>node<span class=\"token punctuation\">.</span>sibling<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      node <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>parent\n    <span class=\"token punctuation\">}</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>node <span class=\"token operator\">==</span> fiber<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">return</span>\n    <span class=\"token punctuation\">}</span>\n    node <span class=\"token operator\">=</span> node<span class=\"token punctuation\">.</span>sibling\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">commitAllWork()</code> 먼저 각각의 모든 루트 <code class=\"language-text\">effects</code> 를 순회하여 <code class=\"language-text\">commitWork()</code> 반복해서 호출합니다. <code class=\"language-text\">commitWork()</code>는 각 fiber 의 <code class=\"language-text\">effectTag</code> 를 검사합니다.</p>\n<ul>\n<li><code class=\"language-text\">PLACEMENT</code> 인 경우 우리는 부모 DOM 노드를 찾은 다음 단순히 fiber 의 stateNode 를 추가합니다.</li>\n<li><code class=\"language-text\">UPDATE</code> 인 경우 stateNode 를 이전 props 및 새 props 와 함께 전달하고 <code class=\"language-text\">updateDomProperties()</code>가 업데이트 할 항목을 결정하도록 합니다.</li>\n<li><code class=\"language-text\">DELETION</code> 이고 fiber 가 호스트 컴포넌트인 경우 간단합니다. 그저 <code class=\"language-text\">removeChild()</code>를 호출하면 됩니다. 그러나 fiber 가 클래스 컴포넌트인 경우 <code class=\"language-text\">removeChild()</code>를 호출하기 전에 fiber 하위 트리에서 모든 호스트 컴포넌트를 찾아서 제거해야 합니다.</li>\n</ul>\n<p>모든 effects 가 끝나면 <code class=\"language-text\">nextUnitOfWork</code> 및 <code class=\"language-text\">pendingCommit</code> 을 초기화 할 수 있습니다. work-in-progress 트리는 작업중인 트리가 아닌 이전 트리가 되므로 루트를 _rootContainerFiber 에 할당합니다. 이제 우리는 현재의 업데이트가 끝냈고 다음 업데이트를 시작할 준비가 되었습니다.</p>\n<h3 id=\"fiber-정리\" style=\"position:relative;\"><a href=\"#fiber-%EC%A0%95%EB%A6%AC\" aria-label=\"fiber 정리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>fiber 정리</h3>\n<p>fiber root 를 가지고 처음엔 <code class=\"language-text\">beginWork(rootFiber)</code> 를 작업한다.</p>\n<p>여기서 <code class=\"language-text\">beginWork()</code> 한다는 것은 <code class=\"language-text\">stateNode</code> 생성해주고 자식들을 <code class=\"language-text\">reconcileChildrenArray()</code> 실행해준다.\n그러면 <code class=\"language-text\">reconcileChildrenArray()</code> 이 하는 일은 여러명의 자식중에 첫번째 자식은\nrootFiber.child 에 childFiber01 로 넣고 나머지는 이전 작업했던 childFiber01 에 sibling 으로 childFiber02 를 넣는다.</p>\n<p>예를 들면 아래 와 같은 구조를 구성한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">rootFiber<span class=\"token punctuation\">.</span>child <span class=\"token operator\">=</span> childFiber01\n\nchildFiber01<span class=\"token punctuation\">.</span>parent <span class=\"token operator\">=</span> rootFiber\nchildFiber01<span class=\"token punctuation\">.</span>sibling <span class=\"token operator\">=</span> childFiber02\n\nchildFiber02<span class=\"token punctuation\">.</span>parent <span class=\"token operator\">=</span> rootFiber\nchildFiber02<span class=\"token punctuation\">.</span>sibling <span class=\"token operator\">=</span> childFiber03</code></pre></div>\n<p>그래서 <code class=\"language-text\">beginWork()</code> 이 작업을 통해서 한 부모 fiber 의 자식 fiber 들을 생성해주는 역할을 합니다. 이 역할이 끝나고 나서 fiber.child 가 발견 되면 다시 <code class=\"language-text\">beginWork()</code> 를 수행한다. 끝까지 child 가 나오지 않는다면 그때부턴 fiber 를 <code class=\"language-text\">complateWork()</code>를 실행합니다. 실행도중 fiber.sibling 가 발견되면 다시 <code class=\"language-text\">beginWork()</code>를 수행하게 되어 child fiber 를 만들게 됩니다.</p>\n<p>그래서 결론적으로는 <code class=\"language-text\">performUnitOfWork()</code>의 반복 수행으로 전체 fiber 트리 구조를 잡아준다.</p>\n<p>정리하면 트리 구조의 왼쪽 맨 아래쪽으로 내려가면서 fiber 를 만들게 됩니다. 이때, 더이상의 child 를 만나지 않으면 <code class=\"language-text\">complateWork()</code> 를 실행하고 부모로 올라가 <code class=\"language-text\">complateWork()</code> 를 실행합니다. 이때, 해당 fiber 에서 sibling 들을 만나게 되면 해당 sibling 을 리턴해서 다시 <code class=\"language-text\">beginWork()</code> 작업을 하게 되고 child 가 없을때 다시 <code class=\"language-text\">complateWork()</code>를 실행해줍니다. 이 작업을 반복해서 실행합니다.</p>\n<p><code class=\"language-text\">complateWork()</code> 이 하는 일은 해당 fiber 에 부모가 존재한지 확인한 후에 자신(fiber)의 자식들 effect 에 자신의 effect 를 만들고 부모가 가진 effect 를 concat(합쳐서) 부모 fiber 에 effect 로 넘겨줍니다.\n이렇게 하면 최종적으로 root fiber 의 effect 에는 배열로 각 fiber 의 정보가 수집되게 됩니다.</p>\n<p>마지막으로는 <code class=\"language-text\">commitAllWork()</code> 함수가 root fiber 의 effect 리스트들을 돌면서 <code class=\"language-text\">commitWork()</code>를 수행합니다.\n<code class=\"language-text\">commitWork()</code> 에서는 <code class=\"language-text\">effectTag</code>를 보면서 적절한 DOM 변이를 처리 합니다.</p>\n<p>최종적으론 fiber tree 구조를 만들면서 순회를 합니다. 이때, 각 필요한 DOM 변이를 최종 root fiber 의 effects 배열로 전달해준다. 이 작업은 재귀 없이 분할작업으로 처리를 한다.\n그렇게 해서 완성된 root fiber effects 를 가지고 실제 DOM 변이를 일으킨다. 이 작업은 나누지 않고 한번에 작업하도록 한다.</p>\n<h2 id=\"최종-정리\" style=\"position:relative;\"><a href=\"#%EC%B5%9C%EC%A2%85-%EC%A0%95%EB%A6%AC\" aria-label=\"최종 정리 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>최종 정리</h2>\n<p>fiber 알고리즘이 적용 되기 전까지는 dom 의 재사용성을 위한 <code class=\"language-text\">instance</code>라는 개념을 도입 (<code class=\"language-text\">{dom, element, childInstances}</code>) 했다. 여기서 <code class=\"language-text\">instance</code>는 dom 에 그려진 <code class=\"language-text\">element</code>를 나타냅니다.\nrender 또는 setState 시 에 발동되는 <code class=\"language-text\">reconcile</code> 라는 \"diff\" 알고리즘을 사용합니다. 여기서 <code class=\"language-text\">reconcile</code> 함수는 이미 그려진 <code class=\"language-text\">instance</code> 와 새롭게 그려질 element 를 비교한다. 이런 비교를 통해서 dom 을 업데이트 할지 새로 추가할지, 교체할지를 정한다. dom 에 새로 추가 또는 type 이 달라서 replace 처리 하게 될 땐 새로 element 받아서 <code class=\"language-text\">instance</code>를 만든다음에 append or replace 를 단행한다. 반대로 type 이 같다면 dom property 를 update 처리 하고 <code class=\"language-text\">reconcileChildren</code> 함수를 통해서 자식들의 reconcile 을 진행한다.</p>\n<p>여기서 중요한 문제는 한번 <strong>reconcile 이 이뤄지면 끊지 않고 화면에 rendering 까지 진행한다는 점이다.</strong> 여기서 재귀적으로 함수들이 호출 되기 때문에 더더욱 중간에 끊을 수 없고 계속 진행해야 한다는 점이다. 그래서 이 작업이 오래 걸려서 단일 쓰레드를 점령하고 있으면 다른 작업(ex. css animation 같은 작업)이 멈출 수 있다.</p>\n<p>이 문제를 해결하고자 fiber 알고리즘을 적용한다.</p>\n<p>기존에 instance 를 대체하는 fiber 구조를 사용한다. <strong>fiber 알고리즘에선 이전 재귀적으로 실행했던 reconcile 을 iteration 구조로 바꿨다고 보면 된다.</strong> 그래서 재귀 구문이 없을 뿐더러 while 구문이 많이 보인다. 그래서 <code class=\"language-text\">requestIdleCallback</code>을 이용해서 분할작업을 진행할 수 있고 다음작업에 대해서 <code class=\"language-text\">nextUnitOfWork</code>를 전역으로 보관하고 있다. 처음으로 <code class=\"language-text\">requestIdleCallback(performWork)</code>를 수행해서 <code class=\"language-text\">workLoop(deadline)</code>를 수행한다.\n<code class=\"language-text\">workLoop(deadline)</code>에서는 브라우저 idle 타임을 보고 계속 <code class=\"language-text\">performUnitOfWork(nextUnitOfWork)</code>를 수행한다. 그러다가 시간이 부족하게 된다면 다음 이어서 해야할 작업을 <code class=\"language-text\">nextUnitOfWork</code>에 담아두고 <code class=\"language-text\">workLoop(deadline)</code> 를 빠져나온다. 그리고 나서 다음 작업이 남았다면 다시 <code class=\"language-text\">requestIdleCallback(performWork)</code>을 수행해서 브라우저 대기열에 넣어 둡니다. 그리고 시간이 되면 다시 수행합니다.</p>\n<p><code class=\"language-text\">workLoop()</code>에서는 <code class=\"language-text\">resetNextUnitOfWork()</code>를 처음에 수행해서 root 의 fiber 를 만들고 <code class=\"language-text\">performUnitOfWork(nextUnitOfWork)</code>를 수행한다.\n<code class=\"language-text\">performUnitOfWork(nextUnitOfWork)</code> 에서는 fiber 를 받아서 <code class=\"language-text\">beginWork()</code> 와 <code class=\"language-text\">completeWork()</code> 를 수행한다.</p>\n<p><code class=\"language-text\">beginWork()</code> 는 fiber 를 받아서 fiber 의 stateNode 프로퍼티에 값을 셋팅해주고 해당 fiber 의 children 들을 fiber 로 만들어준다. ( 1 단 트리만 구성 ) 그리고 나서 <code class=\"language-text\">performUnitOfWork(nextUnitOfWork)</code> 에선 fiber 에 child 가 존재하면 리턴시켜서 다음 작업(<code class=\"language-text\">nextUnitOfWork</code>)이 child 를 root 로 진행해야한다는걸 알린다.\n이런 수행은 child 가 없을때 까지 진행되며 <code class=\"language-text\">beginWork()</code>을 실행시켜서 fiber 트리 일부를 구성한다.\n더이상의 child 가 없다면 그때부턴 <code class=\"language-text\">completeWork()</code>를 수행한다.\n<code class=\"language-text\">completeWork()</code>는 Effect 들을 모아서 부모로 넘겨주는 작업을 한다. 모으는 대상은 자신의 effect 와 children 의 effect 를 모은다.\n그런 다음 sibling 이 있는지 확인하는데 있다면 다시 리턴해서 다음 작업(<code class=\"language-text\">nextUnitOfWork</code>)이라는걸 알린다. 이때 다시 <code class=\"language-text\">beginWork()</code>를 수행해서 sibling 의 children 들을 fiber 로 만들어준다.</p>\n<p>위 작업이 복잡하지만 간단히 생각해보면 root 와 root 의 children 들을 한 작업 단위로 beginWork()로 fiber 를 만든다.\n다음 작업땐 그 root 의 child (보통 첫번째 child 이다.)를 새로운 root 로 삼고 children 을 fiber 를 만든다.</p>\n<div class=\"gatsby-highlight\" data-language=\"javascript\"><pre class=\"language-javascript\"><code class=\"language-javascript\">root <span class=\"token operator\">=</span> rootFiber\nroot<span class=\"token punctuation\">.</span>child <span class=\"token operator\">=</span> childFiber01\nchildFiber01<span class=\"token punctuation\">.</span>parent <span class=\"token operator\">=</span> root\nchildFiber01<span class=\"token punctuation\">.</span>sibling <span class=\"token operator\">=</span> childFiber02\n\nchildFiber02<span class=\"token punctuation\">.</span>parent <span class=\"token operator\">=</span> root\nchildFiber02<span class=\"token punctuation\">.</span>sibling <span class=\"token operator\">=</span> childFiber03\n\nchildFiber03<span class=\"token punctuation\">.</span>parent <span class=\"token operator\">=</span> root</code></pre></div>\n<p>위와 같은 구조가 되겠다.\nchild 가 없는 구조까지 도달하면 마지막 fiber 의 Effect 와 그의 자식들이 모인 effects 를 부모에게 전달한다.\n그리고 나서 sibling 이 있다면 다음 작업을 sibling 으로 넘긴다. sibling 으로 가서 다시 child 를 탐색하고 Effect 를 모으고 하는 작업들을 반복해서 진행한다.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 590px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/ho_blog/static/0ee8beae9cf23025a56054a7edd53fb3/31d79/react-fiber.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 74.32432432432432%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAABYlAAAWJQFJUiTwAAACVElEQVQ4y31Uy47TMBQNnwMrQCD+iD0bfgIJISEWIMRjwcySFR8wM5XayaZVp2l5TFJEVbVpHo0d5/04XDtN25kWLF3ZvrKPzzn3JhqOjLquVchR0VxUtKf1er3GaDSCYRgYj8eYTCawLEuFzAVBAA3/GdUGtNkU+HltwiCgEV0eDAYwTRPD4RD9fl89NJ1OjwNKdi2Yvizw9CzB1UKArxbgxHL7RlWhLMutIrnXjoHJkZfN/PzMg/bsO95croCMw53NkAiB+h+qtGNg6sVmhd9OiE9XEVZBDKSxymd5jiRJkKbpDc9laE1il6w2YDKY7wOCA9xBXRZgto0yEmjvZFmmgPdBtf2K7qhWyqvCJZnkUWgvUAaNd9xxUDk25Qu1z4hlToxb0K1kHoYE4kPkNViUogh8rImhoLztMlVlxjgYATuOh7Rq7mVZfgioGBIrFgo8+rLE/RMHPM5kHfFKd3DntY2TEclHgXUY48mpjYenLpyAE8Nka5kqyn6LBMTgwYcp7r0z8We+VLmXnTm0FxY+6zO19wjk8UcLd99e05nFwYegNewkqOospCQ34lTNLEFC/pQihOeF2wrLcnGfwbNddb5uK3QgeXM4Z+TbYo4siRGSf8GmGAX5JKuaUuQkU1p0u912DAlImuz7AWySwewVXC+AiBMC5YjiBlxQQ0dRpCKkNWNMfSn7oFrr39mixjcrwVczw6Vd4r0R44eb4NfEwPn5BTqdDrrdrgpd19Hr9VROsr4BuP9XSakFQhEpWXKWQzJzqPckGxnyjyLnlultyX8BXp94cuVcJOcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"react-fiber 도식화\"\n        title=\"react-fiber 도식화\"\n        src=\"/ho_blog/static/0ee8beae9cf23025a56054a7edd53fb3/fcda8/react-fiber.png\"\n        srcset=\"/ho_blog/static/0ee8beae9cf23025a56054a7edd53fb3/12f09/react-fiber.png 148w,\n/ho_blog/static/0ee8beae9cf23025a56054a7edd53fb3/e4a3f/react-fiber.png 295w,\n/ho_blog/static/0ee8beae9cf23025a56054a7edd53fb3/fcda8/react-fiber.png 590w,\n/ho_blog/static/0ee8beae9cf23025a56054a7edd53fb3/efc66/react-fiber.png 885w,\n/ho_blog/static/0ee8beae9cf23025a56054a7edd53fb3/c83ae/react-fiber.png 1180w,\n/ho_blog/static/0ee8beae9cf23025a56054a7edd53fb3/31d79/react-fiber.png 1954w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n      />\n  </a>\n    </span></p>\n<p>재귀 방식이 아닌 iterator 작업 방식이기 때문에 이렇게 Effect 를 모으는 작업을 분할해서 작업할 수 있다.\n그 후에 root 에 모인 Effect 를 <code class=\"language-text\">commitAllWork()</code> 를 수행해서 한번에 화면에 rendering 을 진행한다.</p>","excerpt":"이 글은 아래 링크에 있는 글을 참조 했습니다.\n참조 Rendering DOM element 우리가 render 할 때 필요한게 뭔지 설명하기 위해 plain JS object 를 하나 만들 것입니다.\n이것을 우리는 element…","tableOfContents":"<ul>\n<li><a href=\"/ho_blog/build-react.md/#rendering-dom-element\">Rendering DOM element</a></li>\n<li><a href=\"/ho_blog/build-react.md/#element-creation-and-jsx\">Element creation and JSX</a></li>\n<li>\n<p><a href=\"/ho_blog/build-react.md/#instances-reconciliation-and-virtual-dom\">Instances, reconciliation and virtual DOM</a></p>\n<ul>\n<li><a href=\"/ho_blog/build-react.md/#virtual-dom-and-reconciliation\">Virtual DOM and Reconciliation</a></li>\n<li><a href=\"/ho_blog/build-react.md/#instances\">Instances</a></li>\n<li><a href=\"/ho_blog/build-react.md/#refactoring\">Refactoring</a></li>\n<li><a href=\"/ho_blog/build-react.md/#reusing-dom-nodes\">Reusing DOM nodes</a></li>\n<li><a href=\"/ho_blog/build-react.md/#children-reconciliation\">Children Reconciliation</a></li>\n<li><a href=\"/ho_blog/build-react.md/#removing-dom-nodes\">Removing DOM nodes</a></li>\n</ul>\n</li>\n<li><a href=\"/ho_blog/build-react.md/#components-and-state\">Components and State</a></li>\n<li>\n<p><a href=\"/ho_blog/build-react.md/#fiber-incremental-reconciliation\">Fiber: Incremental reconciliation</a></p>\n<ul>\n<li><a href=\"/ho_blog/build-react.md/#why-fiber\">Why Fiber</a></li>\n<li><a href=\"/ho_blog/build-react.md/#scheduling-micro-tasks\">Scheduling micro-tasks</a></li>\n<li><a href=\"/ho_blog/build-react.md/#the-fiber-data-structure\">The fiber data structure</a></li>\n<li><a href=\"/ho_blog/build-react.md/#didact-call-hierarchy\">Didact call hierarchy</a></li>\n<li><a href=\"/ho_blog/build-react.md/#old-code\">Old code</a></li>\n<li><a href=\"/ho_blog/build-react.md/#fiber-%EC%A0%95%EB%A6%AC\">fiber 정리</a></li>\n</ul>\n</li>\n<li><a href=\"/ho_blog/build-react.md/#%EC%B5%9C%EC%A2%85-%EC%A0%95%EB%A6%AC\">최종 정리</a></li>\n</ul>","fields":{"slug":"/build-react.md/"},"frontmatter":{"title":"build-react","date":"Jun 03, 2019","tags":["undefined"],"keywords":["Merlin Tech Blog","Merlin.ho"],"update":"Jan 01, 0001"}}},"pageContext":{"slug":"/build-react.md/","series":[],"lastmod":"0001-01-01"}}}