webpackJsonp([0x7fbbdaeb8b3a],{508:function(n,e){n.exports={data:{site:{siteMetadata:{title:"Merlin Tec Blog",author:"merlin.ho"}},markdownRemark:{id:"/Users/merlin.ho/Documents/workspace/ho_blog/gatsby-blog/src/pages/docker-depolyment/index.md absPath of file >>> MarkdownRemark",html:'<hr>\n<h2>Docker Depolyment</h2>\n<h3>blue-green 배포를 해보자.</h3>\n<h4>개념</h4>\n<p>로드발란서를 앞단에 하나를 두고 v1 버젼인 블루(가칭) 라는 앱을 띄운다. 그러다가 나는 v2 버젼인 그린(가칭)을 무중단 방식으로 업데이트를 진행하고 싶다. <br>\n그럴때 그린을 로드발란서에 등록을 시킨다. <br>\n그러면 블루와 그린을 로드발란싱을 할텐데 그린이 완전히 정상작동을 하였을때 v1 버젼인 블루를 죽이는 방식이다.</p>\n<p>\n  <a\n    class="gatsby-resp-image-link"\n    href="/ho_blog/static/img_config-a3375ddee96da32a30b26f500d9d4a69-6f6cd.png"\n    style="display: block"\n    target="_blank"\n    rel="noopener"\n  >\n  \n  <span\n    class="gatsby-resp-image-wrapper"\n    style="position: relative; display: block; ; max-width: 590px; margin-left: auto; margin-right: auto;"\n  >\n    <span\n      class="gatsby-resp-image-background-image"\n      style="padding-bottom: 79.87261146496814%; position: relative; bottom: 0; left: 0; background-image: url(\'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsSAAALEgHS3X78AAACQklEQVQ4y52Sy28SURTG+W8E5wF2oXXhxqRbujHR2C60VVc+Kqhg22GAdFfrorEBbcTG1oClRrvQxC20AROoJraVh9IxogkTXRBoTCDweecO88Joqjf5Mnfud+7vnJlzbDCt79vv8PF5gu4bjQYkSUKz2cS/LJu22ZVLeLn7Gutb60hLb9Bqtaja7bYe3Ol0Dg6c3VjAQGQIA9EhnIqP0wqLxSJKpRJkWUalUkGhUKDvfwPrwG63SwMVKfv/XTrw5/4+8tkscpkMvkqfIZXL+Fatovx+G19IdZupFD7s7BwcWJHruJHIUnnjGV3amVl/8mKpggHM78ngp9d0sbcTYCcW4ZxOwik8o9I8jpxxU0n1XVjT/SvLGwYwZwIqwcqlsbFbcHtHwc14wBLxwQjxVmkyC7QnK7BSo0GsP47D3iUwvidwXF+EIzgMu+CGXXSDEWbA3FzGmfN+8ARMoT2wot+BYoRkmofLPwfOswBu8ikNZCdX9coV4OlLF8GERsCER0nCETjEs+TuPVx+nIatXq+jVqshPRvGSd8xsFNHwd85QaoRwXgfEagKo/9QUKF8MIojoQtwCeOqyJ4Xo9YK83s18IGHxFDF+mI4R/7h8IQIZyhKIZywQpIskQRJSzO0hvUBZdUkhusqAVx7AJfnPvms47CHB3EoOAhWDOiXtYbo0ADp8spm39j0shoXiMQYlVN5CnHqa02wAPvHxjyH5s6ZZ80yVn1QJcYCrP5o4O6rtz1tUc31nsa54Vmlei9yn/AL0L6/MBe+oOMAAAAASUVORK5CYII=\'); background-size: cover; display: block;"\n    >\n      <img\n        class="gatsby-resp-image-image"\n        style="width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;"\n        alt="구성"\n        title=""\n        src="/ho_blog/static/img_config-a3375ddee96da32a30b26f500d9d4a69-fb8a0.png"\n        srcset="/ho_blog/static/img_config-a3375ddee96da32a30b26f500d9d4a69-1a291.png 148w,\n/ho_blog/static/img_config-a3375ddee96da32a30b26f500d9d4a69-2bc4a.png 295w,\n/ho_blog/static/img_config-a3375ddee96da32a30b26f500d9d4a69-fb8a0.png 590w,\n/ho_blog/static/img_config-a3375ddee96da32a30b26f500d9d4a69-6f6cd.png 785w"\n        sizes="(max-width: 590px) 100vw, 590px"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h4>환경</h4>\n<ul>\n<li>노트북 : 맥북</li>\n<li>도커 호스트 : virtual box ubuntu</li>\n<li>도커 컨테이너 : node express server , nginx-proxy</li>\n</ul>\n<h4>요약</h4>\n<ol>\n<li>맥북 - virtual box 공유 폴더 구성</li>\n<li>폴더 구성 </li>\n<li>ubuntu 에서 nginx-proxy 이미지 다운</li>\n<li>ubuntu 에서 node 이미지를 기반으로 express Dockerfile_express 작성 및 빌드</li>\n<li>docker-compose.yml 작성</li>\n<li>check.sh 현재 돌아가는 도커 확인하고 새로운 도커 띄우고 현재 돌아가는 도커 죽이는 쉘 스크립트 작성</li>\n<li>테스트</li>\n</ol>\n<div class="gatsby-highlight">\n      <pre class="language-sh"><code>## nginx-proxy 이미지 다운 받기 \n$ docker pull jwilder/nginx-proxy </code></pre>\n      </div>\n<ul>\n<li>\n<p>해당 이미지는 도커 젠을 기반으로 만들어진 nginx-proxy로 로드발란싱의 기능이 있는 nginx applicaion에 도커 젠 기능을 추가 해서 넣은 이미지</p>\n</li>\n<li>\n<p>해당 이미지를 사용하게 되면 도커 젠이 도커 데몬을 바라보고 있다가 컨테이너의 런 , 스탑 등의 이벤트를 감지, 해당 컨테이너 정보를 수집 해서 추가 작업을 할 수 있게 끔 도와준다. 여기서 추가작업은 nginx reverse proxy config 작업을 자동으로 수행할 수 있게 도와준다.</p>\n</li>\n<li>\n<p>여기서 호스트의 docker.sock을 nginx-proxy 내부로 들고가야 하는데 이유는 호스트와 통신을 해야하기 때문이다. 호스트 서버에서 발생되는 도커 데몬의 이벤트를 바라보고 있다가 정보를 잘 받을수 있도록 통신을 해야한다.</p>\n</li>\n<li>\n<p>여기서 nginx-proxy에 등록될 app 들은 VIRTUAL_HOST라는 환경변수를 등록 해야한다.</p>\n</li>\n<li>\n<p>nginx 의 가상 호스트 정보는 <a href="https://opentutorials.org/module/384/4529">https://opentutorials.org/module/384/4529</a> 여길 참조</p>\n</li>\n</ul>\n<div class="gatsby-highlight">\n      <pre class="language-dockerfile"><code>## express 를 위한 도커파일\nFROM node:alpine\nMAINTAINER  merlin@merlin.com\n\nRUN mkdir -p /app\nWORKDIR /app\nCOPY package*.json ./\nRUN  npm install\n\nEXPOSE 3000</code></pre>\n      </div>\n<div class="gatsby-highlight">\n      <pre class="language-sh"><code>$ docker build -t blog_express:v1 -f ./dockerfile/Dockerfile_express: .</code></pre>\n      </div>\n<div class="gatsby-highlight">\n      <pre class="language-yml"><code>#docker-compose.yml\n\nversion: \'3\'\n\nservices:\n  app_blue:\n    image: blog_express:v1\n    depends_on:\n      - nginx-proxy\n    working_dir: /app/\n    ports:\n      - 8888:3000\n    environment:\n      - VIRTUAL_HOST=nodeapp.local\n    volumes:\n      - front-volume:/app/front\n      - server-volume:/app/server\n    command: npm start\n  \n  app_green:\n    image: blog_express:v1\n    depends_on:\n      - nginx-proxy\n    environment:\n      - VIRTUAL_HOST=localhost.app\n    volumes:\n      - front-volume:/app/front\n      - server-volume:/app/server\n      \n    command: npm start\n\n  nginx-proxy:\n    image: jwilder/nginx-proxy\n    ports:\n      - 8080:80\n    volumes:\n      - /var/run/docker.sock:/tmp/docker.sock:ro\n    \n\nvolumes:\n  server-volume:\n    driver: local-persist \n    driver_opts:\n      mountpoint: /home/merlin/blog_project/server # full path \n  \n  front-volume:\n    driver: local-persist\n    driver_opts:\n      mountpoint: /home/merlin/blog_project/front # full path</code></pre>\n      </div>\n<p>** 브라우저에서 접근할시 VIRTUAL_HOST 에 설정했던 이름으로 접근할 것 <br></p>\n<p>nginx 설정에 server<em>name이 VIRTUAL\\</em>HOST 에 설정했던 값이 박혀있기에 nginx는 해당 이름으로 접근할때 반응하게 된다. <br></p>\n<p>해서 /etc/hosts 설정은 필수</p>\n<div class="gatsby-highlight">\n      <pre class="language-sh"><code>#check.sh\n\n$ docker-compose up -d app_blue</code></pre>\n      </div>\n<div class="gatsby-highlight">\n      <pre class="language-sh"><code># test</code></pre>\n      </div>',frontmatter:{title:"Docker Depolyment",date:"January 20, 2018"}}},pathContext:{slug:"/docker-depolyment/"}}}});
//# sourceMappingURL=path---docker-depolyment-2a465c95ad91c37a3648.js.map